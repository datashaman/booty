name: Deploy

# Deploy is triggered ONLY by the Release Governor via workflow_dispatch.
# Push to main → Booty verifies (runs tests) → Governor decides ALLOW → dispatches this workflow.
on:
  workflow_dispatch:
    inputs:
      sha:
        description: "SHA to deploy"
        required: true
        type: string

concurrency:
  group: production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    environment: production
    env:
      DEPLOY_SHA: ${{ inputs.sha }}
      DEPLOY_HOST: ${{ vars.DEPLOY_HOST || secrets.DEPLOY_HOST }}
      DEPLOY_PORT: ${{ vars.DEPLOY_PORT || secrets.DEPLOY_PORT || '' }}
      SERVER_NAME: ${{ vars.SERVER_NAME || secrets.SERVER_NAME }}
      REPO_URL: ${{ vars.REPO_URL || secrets.REPO_URL }}
      DEPLOY_USER: ${{ vars.DEPLOY_USER || secrets.DEPLOY_USER || '' }}
      # https when Cloudflare/Certbot/LB terminates SSL; http for bare nginx
      HEALTH_SCHEME: ${{ vars.HEALTH_SCHEME || 'https' }}
      DEPLOY_BRANCH: ${{ vars.DEPLOY_BRANCH || 'main' }}

    steps:
      - name: Preflight
        run: |
          : "${DEPLOY_HOST:?Missing DEPLOY_HOST}"
          : "${SERVER_NAME:?Missing SERVER_NAME}"
          : "${REPO_URL:?Missing REPO_URL}"
          : "${DEPLOY_SHA:?Missing sha input}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
          fetch-depth: 0

      - name: Load SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Test SSH connectivity
        run: |
          {
            echo "## Deploy params"
            echo "| Param | Value |"
            echo "|-------|-------|"
            echo "| DEPLOY_HOST | \`$DEPLOY_HOST\` |"
            echo "| DEPLOY_PORT | \`${DEPLOY_PORT:-22}\` |"
            echo "| DEPLOY_USER | \`${DEPLOY_USER:-runner}\` |"
            echo "| SERVER_NAME | \`$SERVER_NAME\` |"
            echo "| REPO_URL | \`$REPO_URL\` |"
            echo "| DEPLOY_BRANCH | \`${DEPLOY_BRANCH:-main}\` |"
            echo "| HEALTH_SCHEME | \`${HEALTH_SCHEME:-https}\` |"
          } >> $GITHUB_STEP_SUMMARY
          SSH_TARGET="${DEPLOY_USER:+${DEPLOY_USER}@}${DEPLOY_HOST}"
          SSH_OPTS=(-o ConnectTimeout=30 -o BatchMode=yes -o StrictHostKeyChecking=accept-new)
          [ -n "$DEPLOY_PORT" ] && SSH_OPTS+=(-p "$DEPLOY_PORT")
          echo "Testing SSH to $SSH_TARGET..."
          ssh "${SSH_OPTS[@]}" "$SSH_TARGET" "echo OK" > /tmp/ssh-test.log 2>&1
          SSH_EXIT=$?
          cat /tmp/ssh-test.log
          if [ $SSH_EXIT -eq 0 ]; then
            echo "SSH connectivity OK"
          else
            {
              echo "## Deploy Failure — SSH connection failed"
              echo ""
              echo "**Stage:** Test SSH connectivity"
              echo "**Target:** \`$SSH_TARGET\` (port ${DEPLOY_PORT:-22})"
              echo ""
              echo "### Common cause: Firewall"
              echo "GitHub Actions runners use dynamic IPs. Your server must allow SSH from [GitHub's IP ranges](https://api.github.com/meta) (filter \`.actions\`)."
              echo ""
              echo "See [docs/deploy-setup.md](docs/deploy-setup.md) for setup."
              echo ""
              if [ -f /tmp/ssh-test.log ] && [ -s /tmp/ssh-test.log ]; then
                echo "<details><summary>SSH output</summary>"
                echo '```'
                cat /tmp/ssh-test.log
                echo '```'
                echo "</details>"
              fi
            } >> $GITHUB_STEP_SUMMARY
            echo "::error::SSH connection failed. See job summary."
            exit 1
          fi

      - name: Deploy
        id: deploy
        run: |
          export DEPLOY_HOST SERVER_NAME REPO_URL DEPLOY_BRANCH DEPLOY_SHA
          [ -n "$DEPLOY_USER" ] && export DEPLOY_USER
          [ -n "$DEPLOY_PORT" ] && export DEPLOY_PORT
          if ./deploy.sh 2>&1 | tee /tmp/deploy.log; then
            echo "deploy_transport_success=true" >> $GITHUB_OUTPUT
          else
            EXIT=${PIPESTATUS[0]}
            echo "deploy_transport_success=false" >> $GITHUB_OUTPUT
            echo "## Deploy Failure" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Failure class:** remote script exit" >> $GITHUB_STEP_SUMMARY
            echo "**Host:** $DEPLOY_HOST" >> $GITHUB_STEP_SUMMARY
            echo "**User:** ${DEPLOY_USER:-$(whoami)}" >> $GITHUB_STEP_SUMMARY
            echo "**Stage:** deploy.sh" >> $GITHUB_STEP_SUMMARY
            echo "**Exit code:** $EXIT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f /tmp/deploy.log ] && [ -s /tmp/deploy.log ]; then
              echo "<details><summary>Last 20 lines</summary>" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -20 /tmp/deploy.log >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            else
              echo "**No output captured**" >> $GITHUB_STEP_SUMMARY
            fi
            exit 1
          fi

      - name: Health check
        if: steps.deploy.outputs.deploy_transport_success == 'true'
        id: health
        run: |
          HEALTH_URL="${HEALTH_SCHEME}://${SERVER_NAME}/health"
          echo "Probing $HEALTH_URL"
          for i in $(seq 1 15); do
            if curl -sf --connect-timeout 15 --max-time 25 "$HEALTH_URL" > /dev/null; then
              echo "runtime_ready=true" >> $GITHUB_OUTPUT
              echo "Health check passed on attempt $i"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 6s..."
            sleep 6
          done
          echo "::error::Deploy failed — health check timeout after 15 attempts"
          echo "runtime_ready=false" >> $GITHUB_OUTPUT
          echo "## Deploy Failure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failure class:** health check timeout" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $HEALTH_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** health check (15 attempts × 6s, curl connect 15s, max 25s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          exit 1
