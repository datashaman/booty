---
phase: 13-observability-agent
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/booty/webhooks.py
  - src/booty/github/issues.py
autonomous: true

user_setup:
  - service: Sentry
    why: "Webhook integration for error alerts"
    env_vars:
      - name: SENTRY_WEBHOOK_SECRET
        source: "Sentry → Settings → Integrations → Create Internal Integration → Webhook URL + Client Secret"
    dashboard_config:
      - task: "Create alert rule with 'Send a notification via an integration'"
        location: "Sentry Project → Alerts → Create Alert → Add action: Webhook"

must_haves:
  truths:
    - "Sentry alerts that pass filters create GitHub issues with agent:builder label"
    - "Issue body includes severity, release, environment, Sentry link, stack frames, breadcrumbs"
    - "GitHub API failures retry 3x with exponential backoff; then spool to disk"
    - "Builder can pick up created issues via existing webhook flow"
  artifacts:
    - path: src/booty/github/issues.py
      provides: create_issue_from_sentry_event
      min_lines: 80
    - path: src/booty/webhooks.py
      provides: Wire sentry_webhook to issue creator
      contains: create_issue_from_sentry_event
  key_links:
    - from: src/booty/webhooks.py
      to: src/booty/github/issues.py
      via: create_issue_from_sentry_event(event, settings)
      pattern: create_issue_from_sentry_event
    - from: src/booty/github/issues.py
      to: TARGET_REPO
      via: repo.create_issue with GITHUB_TOKEN
      pattern: create_issue|get_repo
---

<objective>
Implement GitHub issue creation from Sentry events: build issue title/body per CONTEXT format, create issue with agent:builder label in TARGET_REPO, retry on failure with exponential backoff (2s, 8s, 30s), spool to JSONL on persistent failure. Wire into sentry_webhook so accepted events create issues.

Purpose: OBSV-06, OBSV-07, OBSV-08 — issue creation with proper format and failure handling.
Output: Complete alert-to-issue pipeline; Builder picks up created issues.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-observability-agent/13-CONTEXT.md
@.planning/phases/13-observability-agent/13-RESEARCH.md
@src/booty/webhooks.py
@src/booty/github/pulls.py
@src/booty/github/comments.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create issue body builder and create_issue_from_sentry_event</name>
  <files>src/booty/github/issues.py</files>
  <action>
Create src/booty/github/issues.py with:

1. def build_sentry_issue_title(event: dict) -> str:
   Pattern: "[severity] ExceptionType — path/to/file.py:line" per CONTEXT.
   - level = event.get("level", "error")
   - meta = event.get("metadata", {})
   - ex_type = meta.get("type") or event.get("exception", {}).get("values", [{}])[0].get("type") or "Error"
   - filename = meta.get("filename", "").strip() or "unknown"
   - NEVER include full message in title (volatile, breaks dedup)
   Return f"[{level}] {ex_type} — {filename}"

2. def build_sentry_issue_body(event: dict, web_url: str) -> str:
   Per CONTEXT body order: (1) severity/env/release, (2) first/last seen, (3) Sentry link, (4) location, (5) top 7 frames, (6) breadcrumb excerpt.
   - Severity, environment (from tags or event.environment), release
   - Timestamp as "first/last seen" (event.datetime or event.timestamp)
   - Sentry link: web_url from event
   - Location: culprit or metadata.filename
   - Top 7 frames from event.exception.values[0].stacktrace.frames
   - Breadcrumbs: last 8, truncate 160 chars each, drop debug (if present in event.breadcrumbs)
   Use markdown formatting. Handle missing fields gracefully.

3. def create_issue_from_sentry_event(event: dict, github_token: str, repo_url: str, label: str = "agent:builder") -> int | None:
   - Parse owner/repo from repo_url (reuse pattern from pulls.py urlparse)
   - g = Github(Auth.Token(github_token)); repo = g.get_repo(owner_repo)
   - title = build_sentry_issue_title(event); body = build_sentry_issue_body(event, event.get("web_url", ""))
   - issue = repo.create_issue(title=title, body=body)
   - Add label: try issue.add_to_labels(label); except 404: repo.create_label(label, "0366d6", "Created by Booty Observability"); issue.add_to_labels(label)
   - Return issue.number
  </action>
  <verify>
python -c "
from booty.github.issues import build_sentry_issue_title, build_sentry_issue_body
e = {'level':'error','metadata':{'type':'ValueError','filename':'foo.py'}}
assert '[error]' in build_sentry_issue_title(e) and 'ValueError' in build_sentry_issue_title(e)
body = build_sentry_issue_body(e, 'https://sentry.io/...')
assert 'error' in body.lower() and 'sentry' in body.lower()
"
  </verify>
  <done>build_sentry_issue_title and build_sentry_issue_body produce CONTEXT-compliant output; create_issue_from_sentry_event creates labeled issue in repo.</done>
</task>

<task type="auto">
  <name>Task 2: Add retry with tenacity and disk spool on failure</name>
  <files>src/booty/github/issues.py</files>
  <action>
1. Wrap create_issue_from_sentry_event call in tenacity retry:
   - retries=3, wait=wait_exponential(multiplier=2, min=2, max=30)
   - retry on 5xx, network errors; NOT on 4xx
   - After 3 failures: write to disk spool instead of raising

2. Add _spool_failed_sentry_event(event: dict, error: str) -> None:
   - Path: /tmp/booty-sentry-spool.jsonl (or configurable via OBSV_SPOOL_PATH env)
   - Append JSONL line: json.dumps({"ts": time.time(), "event": event, "error": error}) + "\n"
   - Log: "observability_spooled", issue_id=event.get("issue_id"), error=error

3. create_sentry_issue_with_retry(event, github_token, repo_url, label) -> int | None:
   - Try: tenacity-wrapped create_issue_from_sentry_event
   - On RetryError after 3 attempts: _spool_failed_sentry_event(event, str(e)); return None
   - Return issue number on success
  </action>
  <verify>
# Spool creates file on simulated failure
python -c "
from booty.github.issues import _spool_failed_sentry_event
import os, tempfile
path = os.path.join(tempfile.gettempdir(), 'booty-sentry-spool-test.jsonl')
os.environ['OBSV_SPOOL_PATH'] = path
try:
    _spool_failed_sentry_event({'issue_id':'123'}, 'test error')
    assert os.path.exists(path)
    with open(path) as f: line = f.read(); assert '123' in line and 'test error' in line
finally:
    if os.path.exists(path): os.remove(path)
"
  </verify>
  <done>Retry 3x exponential backoff; spool to JSONL on persistent failure; no silent drop.</done>
</task>

<task type="auto">
  <name>Task 3: Wire issue creation into sentry_webhook</name>
  <files>src/booty/webhooks.py</files>
  <action>
1. In sentry_webhook, when event passes all filters (severity, dedup, cooldown):
   - Call create_sentry_issue_with_retry(event, settings.GITHUB_TOKEN, settings.TARGET_REPO_URL, settings.TRIGGER_LABEL)
   - If returns issue_number: update _obsv_seen[issue_id] = time.time(); return {"status": "created", "issue_number": issue_number, "issue_id": issue_id}
   - If returns None (spooled): return {"status": "spooled", "issue_id": issue_id}  # 202 accepted
   - Log: "observability_issue_created" or "observability_issue_spooled"

2. Add github.issues to booty.github.__all__ if not present
  </action>
  <verify>
# Integration: mock Sentry payload, verify create_issue path is called
# Run app, send valid event_alert with valid HMAC — expect 202 with status created (requires GITHUB_TOKEN and real repo for E2E)
pytest tests/ -k sentry -v 2>/dev/null || python -c "
# Smoke: create_issue_from_sentry_event is importable and callable
from booty.github.issues import create_sentry_issue_with_retry
assert callable(create_sentry_issue_with_retry)
"
  </verify>
  <done>sentry_webhook creates GitHub issues for events that pass filters; retries and spools on failure; returns 202 with status created or spooled.</done>
</task>

</tasks>

<verification>
- Issue created with agent:builder label in TARGET_REPO
- Issue body has severity, release, environment, Sentry link, stack trace excerpt
- Retry on 5xx; spool on persistent failure
- Builder flow unchanged — created issues have TRIGGER_LABEL, Builder webhook picks up labeled issues
</verification>

<success_criteria>
1. create_issue_from_sentry_event creates issues with correct format
2. Retry 3x with 2s, 8s, 30s backoff
3. Disk spool on failure (JSONL)
4. sentry_webhook wires to creator
5. OBSV-06, OBSV-07, OBSV-08 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/13-observability-agent/13-02-SUMMARY.md`
</output>
