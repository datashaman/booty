---
phase: 07-github-app-checks
plan: 03
type: execute
wave: 3
depends_on: ["02"]
files_modified:
  - src/booty/cli.py
  - src/booty/main.py
  - pyproject.toml
  - docs/github-app-setup.md
  - README.md
autonomous: true

user_setup:
  - service: github_app
    why: "Create GitHub App for Checks API (checks:write)"
    env_vars:
      - name: GITHUB_APP_ID
        source: "GitHub App settings → App ID"
      - name: GITHUB_APP_PRIVATE_KEY
        source: "GitHub App settings → Generate private key, paste PEM (or path)"
    dashboard_config:
      - task: "Install App on repository"
        location: "GitHub App → Install App → Select repository"
      - task: "Note installation ID"
        location: "URL after install: .../installations/{id}"

must_haves:
  truths:
    - "booty verifier check-test creates a check run and prints check_run_id, url, etc."
    - "booty status prints verifier: enabled|disabled"
    - "docs/github-app-setup.md has step-by-step App creation and installation"
  artifacts:
    - path: src/booty/cli.py
      provides: booty status, booty verifier check-test
      min_lines: 80
    - path: docs/github-app-setup.md
      provides: GitHub App setup guide
      min_lines: 60
  key_links:
    - from: cli.py
      to: checks.create_check_run
      via: create_check_run(owner, repo, sha, installation_id, settings)
      pattern: create_check_run
    - from: cli.py
      to: config.verifier_enabled
      via: verifier_enabled(settings)
      pattern: verifier_enabled
---

<objective>
Add CLI commands (booty status, booty verifier check-test) and GitHub App setup docs. Enables manual verification of check creation.

Purpose: CONTEXT — "booty verifier check-test" as operator primitive; "booty status" for verifier: enabled|disabled; docs for App setup.
Output: cli.py with subcommands; docs/github-app-setup.md; README section.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-github-app-checks/07-RESEARCH.md
@.planning/phases/07-github-app-checks/07-CONTEXT.md
@src/booty/config.py
@src/booty/github/checks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI with booty status and booty verifier check-test</name>
  <files>src/booty/cli.py</files>
  <action>
Create src/booty/cli.py using click:

1. Add click to pyproject.toml dependencies (not dev)

2. CLI structure:
   - Main group: @click.group()
   - Subcommand: status
   - Subcommand: verifier with nested check-test
   - Entry: def main() -> None

3. booty status:
   - Load get_settings()
   - Print "verifier: enabled" or "verifier: disabled" (per CONTEXT)
   - If disabled: optionally show reason ("missing GITHUB_APP_ID or GITHUB_APP_PRIVATE_KEY")

4. booty verifier check-test --repo owner/repo --sha SHA --installation-id ID [--details-url URL] [--dry-run]:
   - Required: --repo (owner/repo), --sha (commit SHA), --installation-id
   - Optional: --details-url, --dry-run (if True, don't create, just validate inputs)
   - Parse owner, repo from --repo (split on /)
   - Call create_check_run(owner, repo, sha, installation_id, settings, status="queued", output={"title":"Booty Verifier","summary":"Manual check-test"})
   - On success: print (per CONTEXT) check_run_id, installation_id, repo, sha, status, url
   - Format: one per line or key=value for easy parsing
   - Example: "check_run_id=123\ninstallation_id=456\nrepo=owner/repo\nsha=abc123\nstatus=queued\nurl=https://..."

5. Update pyproject.toml [project.scripts]:
   - Keep existing: booty-server = "booty.main:app" or similar for uvicorn
   - Set: booty = "booty.cli:main"
   - Note: FastAPI app is typically run via `uvicorn booty.main:app`. The current booty = booty.main:app may be incorrect for direct execution. Change to:
     booty = "booty.cli:main"
   - Add booty-server = "uvicorn:main" with [booty-server] or document "uvicorn booty.main:app" in README
   - Simpler: booty = "booty.cli:main" and document `uvicorn booty.main:app` for server. The `booty` command becomes the CLI.
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && pip install -e . -q 2>/dev/null; booty status 2>/dev/null || booty --help 2>/dev/null
# Verify CLI exists
python -c "
from booty.cli import main
assert callable(main)
print('OK: CLI module exists')
"
  </verify>
  <done>booty status and booty verifier check-test work; output includes check_run_id, url per CONTEXT.</done>
</task>

<task type="auto">
  <name>Task 2: Create docs/github-app-setup.md</name>
  <files>docs/github-app-setup.md</files>
  <action>
Create docs/github-app-setup.md with step-by-step guide:

1. Sections per CONTEXT:
   - "Create a new App" — steps for GitHub → Settings → Developer settings → GitHub Apps → New
   - "Use an existing App" — link to App, note App ID, permissions
   - "Install the App" — Install on repo, note installation ID from URL
   - "Configure Booty" — GITHUB_APP_ID, GITHUB_APP_PRIVATE_KEY env vars
   - "Verify" — run `booty verifier check-test --repo owner/repo --sha HEAD --installation-id N`
   - "If not configured" — Verifier disabled, booty status shows disabled

2. Required permissions: checks: write, pull_requests: read, contents: read, metadata: read

3. Private key: Generate in App settings, copy PEM. Env: can use literal newlines or \\n.

4. Include expected output from check-test and note: "Check visible in GitHub UI at <url>"
</action>
  <verify>
test -f /Users/marlinf/Projects/datashaman/booty/docs/github-app-setup.md && head -20 docs/github-app-setup.md
  </verify>
  <done>docs/github-app-setup.md has create/use/install/configure/verify sections.</done>
</task>

<task type="auto">
  <name>Task 3: Add README section for Verifier/App setup</name>
  <files>README.md</files>
  <action>
Add README section (or subsection under Configuration):

1. "Verifier (GitHub App)" — short blurb: Verifier posts check runs via Checks API; requires GitHub App. Set GITHUB_APP_ID and GITHUB_APP_PRIVATE_KEY. See docs/github-app-setup.md for setup.

2. Quick verify: `booty verifier check-test --repo owner/repo --sha <sha> --installation-id <id>`

3. Link to docs/github-app-setup.md for full instructions.
</action>
  <verify>
grep -l "Verifier\|GITHUB_APP\|github-app-setup" README.md
  </verify>
  <done>README mentions Verifier, App env vars, and links to docs.</done>
</task>

</tasks>

<verification>
- booty status prints verifier: enabled or disabled
- booty verifier check-test with valid credentials creates check and prints check_run_id, url
- docs/github-app-setup.md is complete
</verification>

<success_criteria>
- [ ] CLI with booty status, booty verifier check-test
- [ ] docs/github-app-setup.md
- [ ] README section
</success_criteria>

<output>
After completion, create `.planning/phases/07-github-app-checks/07-03-SUMMARY.md`
</output>
