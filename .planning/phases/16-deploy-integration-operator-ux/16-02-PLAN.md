---
phase: 16-deploy-integration-operator-ux
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/release_governor/failure_issues.py
autonomous: true

must_haves:
  truths:
    - "On deploy failure: GitHub issue created with deploy-failure, severity:high"
    - "Issue includes Actions run link"
    - "Same SHA rapid retry: append to existing issue"
  artifacts:
    - path: src/booty/release_governor/failure_issues.py
      provides: create_or_append_deploy_failure_issue
  key_links:
    - from: failure_issues.py
      to: repo.create_issue
      via: PyGithub with labels
---

<objective>
Deploy failure issue handling (GOV-17).

Create or append GitHub issue on deploy failure with labels deploy-failure, severity:high, and failure-type (e.g. deploy:health-check-failed). Include Actions run link in body. Append to same SHA's issue if rapid retry (within 30 min).

Purpose: Operator-visible deploy failures. Visibility only; no coupling to Governor decision.
Output: failure_issues.py with create_or_append_deploy_failure_issue.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-deploy-integration-operator-ux/16-CONTEXT.md
@.planning/phases/16-deploy-integration-operator-ux/16-RESEARCH.md
@src/booty/github/issues.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create failure_issues.py with create_or_append_deploy_failure_issue</name>
  <files>src/booty/release_governor/failure_issues.py</files>
  <action>
Create src/booty/release_governor/failure_issues.py with:

def create_or_append_deploy_failure_issue(
    gh_repo,
    sha: str,
    run_url: str,
    conclusion: str,
    failure_type: str = "deploy:unknown",
) -> int | None:
    """Create or append deploy failure issue (GOV-17). Returns issue number or None on error."""

Behavior:
- Labels: "deploy-failure", "severity:high", failure_type (e.g. "deploy:health-check-failed")
- Title: "Deploy failure: {sha[:7]}"
- Body: SHA, run link, conclusion, timestamp
- Append logic: Search open issues with label deploy-failure, filter by title containing sha[:7], created in last 30 min. If found, add comment with new failure and run link; return that issue number. Else create new issue.
- Use PyGithub: repo.create_issue, repo.get_issues(labels=[...], state="open")
- Map conclusion to failure_type: "failure" -> deploy:health-check-failed (or parse from run), "cancelled" -> deploy:cancelled
</action>
  <verify>python -c "from booty.release_governor.failure_issues import create_or_append_deploy_failure_issue; print('OK')"</verify>
  <done>create_or_append_deploy_failure_issue exists; creates issue with correct labels</done>
</task>

</tasks>

<verification>
- [ ] create_or_append_deploy_failure_issue creates issue with deploy-failure, severity:high
- [ ] Issue body contains run URL
- [ ] Append path adds comment to existing issue for same SHA
</verification>

<success_criteria>
- Deploy failure produces GitHub issue with required labels
- Run link in body
- Append for rapid retry (30 min window)
</success_criteria>

<output>
After completion, create .planning/phases/16-deploy-integration-operator-ux/16-02-SUMMARY.md
</output>
