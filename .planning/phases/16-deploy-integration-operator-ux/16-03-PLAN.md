---
phase: 16-deploy-integration-operator-ux
plan: 03
type: execute
wave: 2
depends_on: ["02"]
files_modified:
  - src/booty/webhooks.py
  - src/booty/release_governor/store.py
autonomous: true

must_haves:
  truths:
    - "Governor observes deploy workflow_run completion"
    - "On success: production_sha updated, deploy_history appended"
    - "On failure: create_or_append_deploy_failure_issue called"
    - "Deploy workflow filtered by deploy_workflow_name"
  artifacts:
    - path: src/booty/webhooks.py
      provides: workflow_run branch for deploy outcome
  key_links:
    - from: webhooks.py
      to: failure_issues.create_or_append_deploy_failure_issue
      via: call when workflow conclusion is failure/cancelled
---

<objective>
Deploy outcome observation (GOV-16).

Add workflow_run branch: when workflow_run.name or path matches deploy_workflow_name and action=completed, handle deploy outcome. On success: update production_sha_current/previous, append_deploy_to_history(success). On failure/cancelled: call create_or_append_deploy_failure_issue; append_deploy_to_history(failure).

Purpose: Governor observes deploy completion; updates release state; surfaces failures.
Output: Deploy workflow_run handling in webhooks; release state kept in sync.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-deploy-integration-operator-ux/16-CONTEXT.md
@.planning/phases/16-deploy-integration-operator-ux/16-RESEARCH.md
@src/booty/webhooks.py
@src/booty/release_governor/store.py
@src/booty/release_governor/failure_issues.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deploy workflow_run branch to webhooks</name>
  <files>src/booty/webhooks.py</files>
  <action>
In webhooks.py, workflow_run handling must support TWO branches (mutually exclusive by workflow identity):

1. **Existing branch** (verification): action=completed, conclusion=success, head_branch=main, workflow_name == verification_workflow_name. Keep as-is.

2. **NEW branch** (deploy outcome): action=completed, workflow matches deploy_workflow_name.
   - Match by: workflow_run.path (e.g. ".github/workflows/deploy.yml") endswith config.deploy_workflow_name, or workflow_run.name if config uses display name.
   - Config has deploy_workflow_name="deploy.yml". workflow_run has "path" and "name". Use: path.endswith(deploy_workflow_name) or name matches.
   - If not governor-enabled repo, skip (same config load as verification branch).
   - On conclusion=="success": update production_sha (state.production_sha_previous = current, state.production_sha_current = head_sha), append_deploy_to_history(success), save_release_state.
   - On conclusion in ("failure","cancelled"): call create_or_append_deploy_failure_issue(gh_repo, head_sha, run_html_url, conclusion, failure_type); append_deploy_to_history(failure); save_release_state.
   - failure_type: "deploy:health-check-failed" for failure, "deploy:cancelled" for cancelled.
   - Idempotency: use workflow_run.id or (repo, head_sha, conclusion) to avoid duplicate processing. delivery_id works for webhook retries.

Structure: Add this as a SECOND workflow_run branchâ€”check deploy BEFORE verification (or check workflow name first). If deploy workflow -> handle deploy outcome; elif verification workflow -> existing flow.
</action>
  <verify>pytest tests/test_release_governor_handler.py tests/ -v -k governor 2>/dev/null || pytest tests/ -v -k release 2>/dev/null || pytest tests/ -v</verify>
  <done>Deploy workflow_run updates state on success; creates issue on failure</done>
</task>

</tasks>

<verification>
- [ ] Deploy workflow completion (success) updates production_sha
- [ ] Deploy workflow completion (failure) creates/append issue
- [ ] Verification workflow still triggers decision flow
- [ ] No cross-talk between deploy and verification branches
</verification>

<success_criteria>
- Governor observes deploy outcome via workflow_run
- Release state updated; failures create issues
</success_criteria>

<output>
After completion, create .planning/phases/16-deploy-integration-operator-ux/16-03-SUMMARY.md
</output>
