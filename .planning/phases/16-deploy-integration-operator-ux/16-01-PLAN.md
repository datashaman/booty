---
phase: 16-deploy-integration-operator-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/release_governor/deploy.py
  - src/booty/release_governor/ux.py
  - src/booty/webhooks.py
  - src/booty/release_governor/store.py
autonomous: true

must_haves:
  truths:
    - "On ALLOW: deploy workflow dispatches with sha input"
    - "On ALLOW: commit status shows Triggered deploy workflow run"
    - "On HOLD: commit status shows reason, SHA, how to unblock"
    - "Never deploys non-head_sha (GOV-18)"
  artifacts:
    - path: src/booty/release_governor/deploy.py
      provides: dispatch_deploy function
    - path: src/booty/release_governor/ux.py
      provides: post_hold_status, post_allow_status
  key_links:
    - from: src/booty/webhooks.py
      to: deploy.dispatch_deploy
      via: call when decision.outcome == ALLOW
    - from: src/booty/webhooks.py
      to: ux.post_hold_status
      via: call when decision.outcome == HOLD
---

<objective>
Deploy trigger and operator UX (GOV-14, GOV-15, GOV-18, GOV-23, GOV-24, GOV-25).

On ALLOW: dispatch deploy workflow via workflow_dispatch with sha input; update release state; post commit status with "Triggered: deploy workflow run" (target_url to run when available).
On HOLD: post commit status with Decision, SHA, Risk, Reason, "How to unblock" (target_url).

Purpose: Governor executes deploy and surfaces HOLD/ALLOW to operators via commit status booty/release-governor.
Output: deploy.py, ux.py; webhook integration; release state updated on ALLOW.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-deploy-integration-operator-ux/16-CONTEXT.md
@.planning/phases/16-deploy-integration-operator-ux/16-RESEARCH.md
@src/booty/webhooks.py
@src/booty/release_governor/handler.py
@src/booty/release_governor/store.py
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy.py with dispatch_deploy</name>
  <files>src/booty/release_governor/deploy.py</files>
  <action>
Create src/booty/release_governor/deploy.py with:

def dispatch_deploy(gh_repo, config: ReleaseGovernorConfig, head_sha: str) -> None:
    """Dispatch deploy workflow via workflow_dispatch with sha input (GOV-14, GOV-18)."""
    workflow = gh_repo.get_workflow(config.deploy_workflow_name)
    workflow.create_dispatch(
        ref=config.deploy_workflow_ref,
        inputs={"sha": head_sha}
    )

Use PyGithub: repo.get_workflow(filename) accepts deploy_workflow_name (e.g. "deploy.yml" or ".github/workflows/deploy.yml").
Raise on failure; no return value. GITHUB_TOKEN from get_settings().
</action>
  <verify>python -c "from booty.release_governor.deploy import dispatch_deploy; print('OK')"</verify>
  <done>dispatch_deploy exists and triggers workflow with sha input</done>
</task>

<task type="auto">
  <name>Task 2: Create ux.py with post_hold_status and post_allow_status</name>
  <files>src/booty/release_governor/ux.py</files>
  <action>
Create src/booty/release_governor/ux.py with:

def post_hold_status(gh_repo, head_sha: str, decision: Decision, target_url: str) -> None:
    """Post HOLD commit status (GOV-15, GOV-23). context='booty/release-governor', state='failure'."""
    # Description: HOLD: {reason} — {sha[:7]}. Max 140 chars.
    # Reason-specific "how to unblock" in target_url per CONTEXT.
    # Build target_url: link to Actions runs or docs. Planner discretion.

def post_allow_status(gh_repo, head_sha: str, target_url: str) -> None:
    """Post ALLOW commit status (GOV-24). context='booty/release-governor', state='success'."""
    # Description: "Triggered: deploy workflow run" or similar; target_url = run link when available.
    # workflow_dispatch returns 204 with no body; target_url can be generic runs list or empty initially.

Per CONTEXT: commit status only (no issue comments). Reason-specific "how to unblock" for HOLD. Include approval_mode in HOLD text for approval reasons.
</action>
  <verify>python -c "from booty.release_governor.ux import post_hold_status, post_allow_status; print('OK')"</verify>
  <done>post_hold_status and post_allow_status exist; context=booty/release-governor</done>
</task>

<task type="auto">
  <name>Task 3: Integrate deploy + UX into webhook after handle_workflow_run</name>
  <files>src/booty/webhooks.py, src/booty/release_governor/store.py</files>
  <action>
In webhooks.py workflow_run branch, after handle_workflow_run(payload, governor_config):

1. If decision.outcome == "ALLOW":
   - dispatch_deploy(gh_repo, governor_config, head_sha)
   - Update release state: last_deploy_attempt_sha=head_sha, last_deploy_time=now, last_deploy_result="pending"
   - append_deploy_to_history(state_dir, head_sha, now_iso, "pending")
   - post_allow_status(gh_repo, head_sha, target_url)
   - target_url: use repo html_url + "/actions" or empty string (run link comes from deploy workflow_run webhook later)

2. If decision.outcome == "HOLD":
   - Build target_url for "how to unblock": e.g. "https://github.com/{owner}/{repo}/actions" or docs link
   - post_hold_status(gh_repo, head_sha, decision, target_url)

Ensure we use head_sha from payload (never "latest") — GOV-18. Record delivery_id after success (already done).
</action>
  <verify>pytest tests/test_release_governor_handler.py -v</verify>
  <done>Webhook acts on ALLOW (dispatch + status) and HOLD (status); state updated</done>
</task>

</tasks>

<verification>
- [ ] On ALLOW: workflow_dispatch called with sha
- [ ] On HOLD: commit status posted with state=failure, context=booty/release-governor
- [ ] On ALLOW: commit status posted with state=success
- [ ] release.json updated on ALLOW (last_deploy_attempt_sha, last_deploy_time)
</verification>

<success_criteria>
- dispatch_deploy triggers deploy workflow with sha input
- HOLD and ALLOW both post commit status to head_sha
- Release state updated on ALLOW before status post
</success_criteria>

<output>
After completion, create .planning/phases/16-deploy-integration-operator-ux/16-01-SUMMARY.md
</output>
