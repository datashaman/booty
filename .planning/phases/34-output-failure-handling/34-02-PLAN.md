---
phase: 34-output-failure-handling
plan: 02
type: execute
wave: 2
depends_on: ['01']
files_modified:
  - src/booty/architect/output.py
  - src/booty/planner/output.py
  - src/booty/github/comments.py
autonomous: true

must_haves:
  truths:
    - Architect updates plan comment with <!-- booty-architect --> section (Approved or Rewritten or Blocked)
    - booty-architect section placed between Builder instructions and collapsed JSON
    - When blocked: update same plan comment, not create new
  artifacts:
    - path: src/booty/architect/output.py
      provides: format_architect_section
    - path: src/booty/planner/output.py
      provides: format_plan_comment with architect_section param
    - path: src/booty/github/comments.py
      provides: update_plan_comment_with_architect_section
  key_links:
    - from: format_plan_comment
      to: booty-architect section
      via: architect_section param inserts before <details>
      pattern: booty-architect
    - from: update_plan_comment_with_architect_section
      to: plan comment
      via: find <!-- booty-plan -->, inject section, edit
      pattern: get_comments|comment\.edit
---

<objective>
Add booty-architect section formatting and plan comment update for Approved/Rewritten/Blocked.

Purpose: ARCH-18 — Architect updates existing plan comment with architect section. ARCH-19/34-CONTEXT — block updates same comment. Section placement per CONTEXT: between Builder instructions and collapsed JSON.
Output: format_architect_section, format_plan_comment(architect_section param), update_plan_comment_with_architect_section.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/34-output-failure-handling/34-CONTEXT.md
@.planning/phases/34-output-failure-handling/34-RESEARCH.md
@src/booty/architect/output.py
@src/booty/planner/output.py
@src/booty/github/comments.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: format_architect_section and format_plan_comment update</name>
  <files>src/booty/architect/output.py, src/booty/planner/output.py</files>
  <action>
1. In src/booty/architect/output.py: Add format_architect_section(status: Literal["approved","rewritten","blocked"], risk_level: str | None = None, reason: str | None = None, architect_notes: str | None = None, rewrite_summary: list[str] | None = None) -> str.
   - Approved: "✓ Approved — Risk: {risk_level}". Add architect_notes after status line if present; truncate with <details> per CONTEXT when long.
   - Rewritten: "✎ Rewritten — {reason or 'ambiguous steps clarified'}". Add rewrite_summary bullets if present; architect_notes if present.
   - Blocked: Stronger emphasis per CONTEXT. "Architect review required — plan is structurally unsafe." plus reason in parens. No architect_notes (internal).
   - Wrap in "<!-- booty-architect -->\n{content}\n<!-- /booty-architect -->".
2. In src/booty/planner/output.py: Update format_plan_comment(plan: Plan, architect_section: str | None = None) -> str: when architect_section provided, insert it between "## Builder instructions" section and "<details>" (before collapsed JSON). Preserve backward compat: architect_section=None produces current output.
</action>
  <verify>python -c "
from booty.planner.output import format_plan_comment
from booty.architect.output import format_architect_section
from booty.planner.schema import Plan, Step, HandoffToBuilder
p = Plan(goal='g', steps=[Step(id='P1', action='read', path='x', acceptance='ok')], handoff_to_builder=HandoffToBuilder(branch_name_hint='b', commit_message_hint='c', pr_title='t', pr_body_outline='o'))
s = format_architect_section('approved', risk_level='MEDIUM')
assert '<!-- booty-architect -->' in s and 'Approved' in s and 'MEDIUM' in s
body = format_plan_comment(p, s)
assert 'booty-architect' in body and body.index('booty-architect') < body.index('<details>')
print('OK')
"</verify>
  <done>format_architect_section and format_plan_comment accept architect_section</done>
</task>

<task type="auto">
  <name>Task 2: update_plan_comment_with_architect_section</name>
  <files>src/booty/github/comments.py</files>
  <action>
Add update_plan_comment_with_architect_section(github_token: str, repo_url: str, issue_number: int, architect_section: str) -> None.
- Find comment containing "<!-- booty-plan -->" via issue.get_comments().
- If not found: log warning and return (rare; Planner should have posted).
- Modify body: inject architect_section before "<details>" (or before "<!-- booty-plan -->" if <details> absent). If <!-- booty-architect --> already exists, replace that block; else insert before <details>.
- comment.edit(new_body). Log architect_section_updated.
- Mirror _get_repo, exception handling from post_plan_comment.
</action>
  <verify>python -c "
from booty.github.comments import update_plan_comment_with_architect_section
import inspect
sig = inspect.signature(update_plan_comment_with_architect_section)
assert set(sig.parameters) >= {'github_token','repo_url','issue_number','architect_section'}
print('OK')
"</verify>
  <done>update_plan_comment_with_architect_section finds plan comment, injects section, edits</done>
</task>

<task type="auto">
  <name>Task 3: Refactor post_architect_blocked_comment to update same comment</name>
  <files>src/booty/github/comments.py</files>
  <action>
Refactor post_architect_blocked_comment(github_token, repo_url, issue_number, reason: str = "") to update the SAME plan comment instead of creating new.
- Build architect_section = format_architect_section("blocked", reason=reason).
- Call update_plan_comment_with_architect_section(github_token, repo_url, issue_number, architect_section).
- If no plan comment found: fall back to creating minimal comment with block message (preserve operator visibility).
- Keep exact phrase "Architect review required — plan is structurally unsafe." per ARCH-19.
</action>
  <verify>pytest tests/test_planner_output.py tests/test_architect_worker.py -v 2>/dev/null || true; python -c "from booty.github.comments import post_architect_blocked_comment, update_plan_comment_with_architect_section; print('OK')"</verify>
  <done>Block updates same comment; fallback to new comment if none exists</done>
</task>

</tasks>

<verification>
- format_architect_section produces Approved/Rewritten/Blocked variants with booty-architect wrapper
- format_plan_comment(plan, section) inserts section before <details>
- update_plan_comment_with_architect_section finds plan comment, injects, edits
- post_architect_blocked_comment updates same comment
</verification>

<success_criteria>
- format_architect_section and format_plan_comment updated
- update_plan_comment_with_architect_section in comments.py
- post_architect_blocked_comment refactored to update same comment
</success_criteria>

<output>
After completion, create `.planning/phases/34-output-failure-handling/34-02-SUMMARY.md`
</output>
