---
phase: 34-output-failure-handling
plan: 03
type: execute
wave: 3
depends_on: ['01', '02']
files_modified:
  - src/booty/main.py
  - src/booty/github/comments.py
autonomous: true

must_haves:
  truths:
    - Architect updates plan comment with booty-architect section on approved and rewritten
    - Architect updates same plan comment on block (does not create new)
    - Architect does NOT trigger Builder when blocked
    - No automatic retries on block
  artifacts:
    - path: src/booty/main.py
      provides: Architect flow with comment updates
  key_links:
    - from: _planner_worker_loop
      to: update_plan_comment_with_architect_section
      via: on approved/rewritten/blocked
      pattern: format_plan_comment|update_plan_comment|post_plan_comment
---

<objective>
Wire Architect comment updates into main.py planner worker loop.

Purpose: ARCH-18 (update comment Approved/Rewritten), ARCH-19/20/21 (block updates same comment, label, no Builder). No retries (ARCH-22).
Output: main.py updates plan comment for all Architect outcomes.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/34-output-failure-handling/34-CONTEXT.md
@.planning/phases/34-output-failure-handling/34-RESEARCH.md
@src/booty/main.py
@src/booty/architect/worker.py
@src/booty/architect/output.py
@src/booty/planner/output.py
@src/booty/github/comments.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update plan comment on Architect approved</name>
  <files>src/booty/main.py</files>
  <action>
In _planner_worker_loop, after arch_result = process_architect_input(...) and when arch_result.approved:
1. Import build_architect_plan, format_architect_section from architect.output, format_plan_comment from planner.output, post_plan_comment from github.comments.
2. architect_plan = build_architect_plan(arch_result.plan, arch_result.architect_notes).
3. Determine status: "rewritten" if arch_result.architect_notes and any rewrite indicators (e.g. "ambiguous" or "overreach" in notes), else "approved".
4. architect_section = format_architect_section(status, risk_level=architect_plan.risk_level, architect_notes=architect_plan.architect_notes).
5. body = format_plan_comment(arch_result.plan, architect_section).
6. post_plan_comment(settings.GITHUB_TOKEN, job.repo_url, job.issue_number, body) — wrap in try/except GithubException, log on failure, continue (comment is best-effort).
7. Then set should_enqueue_builder = True.
</action>
  <verify>pytest tests/test_architect_worker.py -v; booty starts without error</verify>
  <done>Approved/rewritten updates plan comment with booty-architect section before enqueueing Builder</done>
</task>

<task type="auto">
  <name>Task 2: Block flow — update same comment, apply label, do not enqueue Builder</name>
  <files>src/booty/main.py</files>
  <action>
When arch_result.approved is False:
1. Extract block reason from arch_result.architect_notes (format: "Architect review required — plan is structurally unsafe. (reason)" — use parenthetical if present, else empty string).
2. Call post_architect_blocked_comment(settings.GITHUB_TOKEN, job.repo_url, job.issue_number, reason=reason). post_architect_blocked_comment now updates same comment (Phase 34-02).
3. add_architect_review_label(...) — unchanged.
4. Do NOT set should_enqueue_builder. Do NOT enqueue Builder. No automatic retry (ARCH-21, ARCH-22).
5. Ensure post_architect_blocked_comment accepts reason param (34-02 refactor).
</action>
  <verify>Code review: block branch calls post_architect_blocked_comment + add_architect_review_label, does not set should_enqueue_builder; pytest tests/test_architect_worker.py -v</verify>
  <done>Block updates comment, adds label, never triggers Builder</done>
</task>

</tasks>

<verification>
- Approved: plan comment updated with booty-architect Approved section, Builder enqueued
- Rewritten: plan comment updated with booty-architect Rewritten section, Builder enqueued
- Blocked: plan comment updated with booty-architect Blocked section, label applied, Builder NOT enqueued
</verification>

<success_criteria>
- Architect updates plan comment for all outcomes
- Block never triggers Builder
- No retries on block
</success_criteria>

<output>
After completion, create `.planning/phases/34-output-failure-handling/34-03-SUMMARY.md`
</output>
