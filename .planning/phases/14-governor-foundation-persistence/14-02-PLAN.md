---
phase: 14-governor-foundation-persistence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/release_governor/__init__.py
  - src/booty/release_governor/store.py
  - tests/test_release_governor_store.py
autonomous: true

must_haves:
  truths:
    - "Release state persists to release.json with atomic write"
    - "Delivery ID cache deduplicates (repo, head_sha)"
    - "Single writer safe via fcntl.flock"
    - ".booty/state/ directory created when store is used"
  artifacts:
    - path: src/booty/release_governor/store.py
      provides: ReleaseState, DeliveryCache, atomic write, load/save
    - path: src/booty/release_governor/__init__.py
      provides: Module exports
  key_links:
    - from: store.save_release_state
      to: release.json
      via: atomic write (temp + os.replace)
      pattern: os.replace|tempfile
    - from: store.record_delivery_id
      to: delivery cache
      via: (repo, head_sha) key
      pattern: delivery|repo.*sha
---

<objective>
Create release state store and delivery ID cache with atomic writes and single-writer safety.

Purpose: GOV-19, GOV-20, GOV-21, GOV-22 — release state in file, atomic writes, delivery ID cache for idempotency, never trigger deploy twice for same SHA.

Output: src/booty/release_governor/store.py, __init__.py, tests.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-governor-foundation-persistence/14-CONTEXT.md
@.planning/phases/14-governor-foundation-persistence/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create store module with ReleaseState and atomic write</name>
  <files>src/booty/release_governor/__init__.py, src/booty/release_governor/store.py</files>
  <action>
Create src/booty/release_governor/ directory. In store.py:

1. ReleaseState dataclass or Pydantic model: production_sha_current, production_sha_previous, last_deploy_attempt_sha, last_deploy_time (ISO8601 str or None), last_deploy_result (success|failure|pending), last_health_check (ISO8601 or None).

2. get_state_dir() -> Path: return Path from RELEASE_GOVERNOR_STATE_DIR env, or $HOME/.booty/state, or ./.booty/state if HOME unset. Create directory if missing.

3. _atomic_write_json(path: Path, data: dict): write to temp file in same dir (tempfile.NamedTemporaryFile delete=False), json.dump with indent=2, flush, fsync, close, then os.replace(temp_path, target_path).

4. load_release_state(state_dir: Path) -> ReleaseState: if release.json missing, return ReleaseState with null/empty defaults. Use fcntl.flock LOCK_SH for read. Parse JSON.

5. save_release_state(state_dir: Path, state: ReleaseState): acquire LOCK_EX, write atomically to release.json.

Create __init__.py with exports: ReleaseState, load_release_state, save_release_state, get_state_dir.
  </action>
  <verify>python -c "
from pathlib import Path
from booty.release_governor.store import get_state_dir, load_release_state, save_release_state, ReleaseState
import tempfile, os
os.environ.pop('RELEASE_GOVERNOR_STATE_DIR', None)
with tempfile.TemporaryDirectory() as d:
    os.environ['RELEASE_GOVERNOR_STATE_DIR'] = d
    state_dir = get_state_dir()
    s = load_release_state(state_dir)
    assert s.production_sha_current is None
    s2 = ReleaseState(production_sha_current='abc123', production_sha_previous=None, last_deploy_attempt_sha='abc123', last_deploy_time='2026-01-01T00:00:00Z', last_deploy_result='success', last_health_check=None)
    save_release_state(state_dir, s2)
    s3 = load_release_state(state_dir)
    assert s3.production_sha_current == 'abc123'
print('OK')
"</verify>
  <done>Release state load/save with atomic write and flock works</done>
</task>

<task type="auto">
  <name>Task 2: Add delivery ID cache for idempotency</name>
  <files>src/booty/release_governor/store.py</files>
  <action>
Add delivery ID cache:
1. delivery_ids.json structure: {"repo:sha": "delivery_id"} or list of {repo, sha, delivery_id}. Use dict keyed by "owner/repo:sha" for O(1) lookup.

2. has_delivery_id(state_dir: Path, repo: str, head_sha: str) -> bool: load delivery_ids.json (create if missing), check if key exists.

3. record_delivery_id(state_dir: Path, repo: str, head_sha: str, delivery_id: str): load, add entry, save atomically. Use same _atomic_write_json + flock pattern.

4. Optional: add max_entries or TTL for pruning — Phase 14 can ship without; defer unbounded growth to later if needed.

Export has_delivery_id, record_delivery_id from __init__.py.
  </action>
  <verify>python -c "
from pathlib import Path
from booty.release_governor.store import get_state_dir, has_delivery_id, record_delivery_id
import tempfile, os
with tempfile.TemporaryDirectory() as d:
    os.environ['RELEASE_GOVERNOR_STATE_DIR'] = d
    state_dir = get_state_dir()
    assert has_delivery_id(state_dir, 'owner/repo', 'abc123') is False
    record_delivery_id(state_dir, 'owner/repo', 'abc123', 'deliv-1')
    assert has_delivery_id(state_dir, 'owner/repo', 'abc123') is True
    assert has_delivery_id(state_dir, 'owner/repo', 'def456') is False
print('OK')
"</verify>
  <done>Delivery ID cache deduplicates (repo, head_sha); has and record work</done>
</task>

<task type="auto">
  <name>Task 3: Add store tests</name>
  <files>tests/test_release_governor_store.py</files>
  <action>
Create tests/test_release_governor_store.py. Test cases:
1. load_release_state returns defaults when release.json missing
2. save_release_state then load_release_state round-trip
3. has_delivery_id returns False for new (repo, sha)
4. record_delivery_id then has_delivery_id returns True
5. Different (repo, sha) pairs are independent
6. get_state_dir creates directory when missing
Use tempfile.TemporaryDirectory and RELEASE_GOVERNOR_STATE_DIR for isolation.
  </action>
  <verify>pytest tests/test_release_governor_store.py -v</verify>
  <done>All store tests pass</done>
</task>

</tasks>

<verification>
- release.json written atomically (temp + os.replace)
- fcntl.flock used for single-writer safety
- delivery_ids.json keyed by "repo:sha"
- State directory created on first use
</verification>

<success_criteria>
- [ ] store.py with ReleaseState, load/save, delivery cache
- [ ] Atomic write pattern (no partial writes)
- [ ] tests/test_release_governor_store.py passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-governor-foundation-persistence/14-02-SUMMARY.md`
</output>
