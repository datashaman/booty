---
phase: 14-governor-foundation-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/test_runner/config.py
  - tests/test_release_governor_config.py
autonomous: true

must_haves:
  truths:
    - "ReleaseGovernorConfig schema accepts valid config and rejects unknown keys"
    - "Env vars RELEASE_GOVERNOR_* override .booty.yml values"
    - "BootyConfigV1 with release_governor optional block loads without release_governor (backward compat)"
  artifacts:
    - path: src/booty/test_runner/config.py
      provides: ReleaseGovernorConfig, BootyConfigV1.release_governor
      contains: ReleaseGovernorConfig
    - path: tests/test_release_governor_config.py
      provides: Config validation tests
  key_links:
    - from: BootyConfigV1
      to: ReleaseGovernorConfig
      via: release_governor optional field
      pattern: release_governor.*ReleaseGovernorConfig
---

<objective>
Add ReleaseGovernorConfig schema to .booty.yml and env override support.

Purpose: GOV-04, GOV-26, GOV-27, GOV-28, GOV-29 â€” Governor loads config from env + .booty.yml; env overrides; strict schema (unknown keys fail).

Output: ReleaseGovernorConfig model, BootyConfigV1 extended, env override helper, tests.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-governor-foundation-persistence/14-CONTEXT.md
@.planning/phases/14-governor-foundation-persistence/14-RESEARCH.md
@src/booty/test_runner/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReleaseGovernorConfig and extend BootyConfigV1</name>
  <files>src/booty/test_runner/config.py</files>
  <action>
Create ReleaseGovernorConfig Pydantic model with model_config = ConfigDict(extra="forbid"). Include fields per GOV-26 to GOV-29:
- enabled: bool = True
- production_environment_name: str = "production"
- require_approval_for_first_deploy: bool = False
- high_risk_paths: list[str] with default [".github/workflows/**", "**/migrations/**"]
- migration_paths: list[str] = [] (pathspecs)
- deploy_workflow_name: str = "deploy.yml"
- deploy_workflow_ref: str = "main"
- cooldown_minutes: int = 30, ge=0
- max_deploys_per_hour: int = 6, ge=1
- approval_mode: Literal["environment", "label", "comment"] = "environment"
- approval_label: str | None = None
- approval_command: str | None = None

Add release_governor: ReleaseGovernorConfig | None = None to BootyConfigV1. Ensure _parse_booty_config and load_booty_config_from_content handle the new field. Backward compat: repos without release_governor key load successfully with release_governor=None.
  </action>
  <verify>python -c "from booty.test_runner.config import load_booty_config_from_content; c = load_booty_config_from_content('schema_version: 1\ntest_command: pytest\nrelease_governor:\n  enabled: true'); assert c.release_governor is not None and c.release_governor.enabled is True"</verify>
  <done>BootyConfigV1 loads .booty.yml with optional release_governor block; ReleaseGovernorConfig validates with strict schema</done>
</task>

<task type="auto">
  <name>Task 2: Add env override for ReleaseGovernorConfig</name>
  <files>src/booty/test_runner/config.py</files>
  <action>
Add function apply_release_governor_env_overrides(config: ReleaseGovernorConfig) -> ReleaseGovernorConfig that reads RELEASE_GOVERNOR_* env vars and overrides config fields. Map: RELEASE_GOVERNOR_ENABLED, RELEASE_GOVERNOR_COOLDOWN_MINUTES, RELEASE_GOVERNOR_MAX_DEPLOYS_PER_HOUR, RELEASE_GOVERNOR_DEPLOY_WORKFLOW_NAME, RELEASE_GOVERNOR_PRODUCTION_ENVIRONMENT_NAME, etc. Use os.environ.get; parse bool/int as needed. Return new config with overrides applied. Document env var names in module docstring or function docstring.
  </action>
  <verify>RELEASE_GOVERNOR_ENABLED=false python -c "from booty.test_runner.config import load_booty_config_from_content, apply_release_governor_env_overrides; c = load_booty_config_from_content('schema_version: 1\ntest_command: pytest\nrelease_governor:\n  enabled: true'); r = apply_release_governor_env_overrides(c.release_governor); assert r.enabled is False"</verify>
  <done>Env vars override ReleaseGovernorConfig when present</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for schema validation</name>
  <files>tests/test_release_governor_config.py</files>
  <action>
Create tests/test_release_governor_config.py. Test cases:
1. Valid release_governor config loads
2. Unknown key in release_governor raises ValidationError (extra="forbid")
3. BootyConfigV1 without release_governor loads (release_governor is None)
4. apply_release_governor_env_overrides overrides enabled, cooldown_minutes from env
5. Invalid approval_mode value raises ValidationError
  </action>
  <verify>pytest tests/test_release_governor_config.py -v</verify>
  <done>All config validation tests pass</done>
</task>

</tasks>

<verification>
- ReleaseGovernorConfig has all GOV-26 to GOV-29 fields
- BootyConfigV1.release_governor is optional, backward compat
- Env overrides work for at least enabled, cooldown_minutes
- Unknown keys in release_governor fail validation
</verification>

<success_criteria>
- [ ] ReleaseGovernorConfig in config.py with extra="forbid"
- [ ] BootyConfigV1.release_governor optional field
- [ ] apply_release_governor_env_overrides function
- [ ] tests/test_release_governor_config.py passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-governor-foundation-persistence/14-01-SUMMARY.md`
</output>
