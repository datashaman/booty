---
phase: 14-governor-foundation-persistence
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - deploy.sh
autonomous: true

must_haves:
  truths:
    - "workflow_dispatch with sha input checks out that SHA"
    - "workflow_dispatch without sha fails immediately"
    - "deploy.sh deploys specific SHA when DEPLOY_SHA set"
  artifacts:
    - path: .github/workflows/deploy.yml
      provides: sha input for workflow_dispatch
    - path: deploy.sh
      provides: DEPLOY_SHA support on remote
  key_links:
    - from: deploy.yml checkout step
      to: inputs.sha
      via: ref: ${{ inputs.sha || github.sha }}
    - from: deploy.yml Deploy step
      to: deploy.sh
      via: DEPLOY_SHA env var
      pattern: DEPLOY_SHA
---

<objective>
Add optional sha input to deploy workflow and DEPLOY_SHA support in deploy.sh.

Purpose: Governor will trigger deploy via workflow_dispatch with sha; remote must checkout that exact SHA.

Output: deploy.yml with sha input; deploy.sh with DEPLOY_SHA handling.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-governor-foundation-persistence/14-CONTEXT.md
@.planning/phases/14-governor-foundation-persistence/14-RESEARCH.md
@.github/workflows/deploy.yml
@deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sha input to deploy workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
1. Under workflow_dispatch, add inputs: sha: description "SHA to deploy (required for governor-triggered deploys)", required: false, type: string.

2. Add a Preflight-like step at the start (or extend Preflight) that runs when github.event_name == 'workflow_dispatch' and !inputs.sha: echo "::error::workflow_dispatch requires sha input"; exit 1. This enforces "deploy fails immediately if sha omitted" for manual workflow_dispatch.

3. Update Checkout step: ref: ${{ inputs.sha || github.sha }}. When push triggers, github.sha is the commit; when workflow_dispatch, use inputs.sha (which we've enforced to be present).

4. Pass sha to Deploy step env: DEPLOY_SHA: ${{ inputs.sha || github.sha }} so deploy.sh receives it when workflow_dispatch runs. For push events, DEPLOY_SHA will be github.sha (current commit) — that's fine, deploy.sh can treat it as "deploy this SHA" and it matches what we have checked out.
  </action>
  <verify>grep -A2 "workflow_dispatch:" .github/workflows/deploy.yml | head -10; grep "inputs.sha\|DEPLOY_SHA" .github/workflows/deploy.yml</verify>
  <done>deploy.yml has sha input; checkout uses it; DEPLOY_SHA passed to deploy</done>
</task>

<task type="auto">
  <name>Task 2: Add DEPLOY_SHA support to deploy.sh</name>
  <files>deploy.sh</files>
  <action>
In the remote heredoc section (after "cd $INSTALL_DIR"), replace the checkout/pull logic:
- If DEPLOY_SHA is set (pass from ssh env): git fetch origin; git checkout "$DEPLOY_SHA". Do not pull.
- Else: git checkout "$DEPLOY_BRANCH"; git pull origin "$DEPLOY_BRANCH".

The workflow passes DEPLOY_SHA to the deploy step. The deploy step runs deploy.sh locally, which SSHs to remote. We need to pass DEPLOY_SHA into the SSH session. Check current deploy.sh: it passes DEPLOY_BRANCH as $6. Add DEPLOY_SHA as an optional 7th argument or via env. The script uses export for some vars. For SSH, env vars don't automatically propagate. Options: (a) pass as 7th heredoc arg, (b) prefix the ssh command with DEPLOY_SHA=... bash -s. Use (b): when invoking the remote script, export DEPLOY_SHA before the heredoc if it's set. Actually deploy.sh is invoked as ./deploy.sh — it gets env from the caller. So the GitHub Actions step has env: DEPLOY_SHA. When run via bash, the current shell has it. But ssh ... bash -s runs a new shell on remote — the remote doesn't have DEPLOY_SHA. We need to pass it. The heredoc passes args: $DEPLOY_USER $REPO_URL $INSTALL_DIR $SERVICE_NAME $SERVER_NAME $DEPLOY_BRANCH. Add $DEPLOY_SHA as 7th. In remote script: DEPLOY_SHA="${7:-}". Then use it in the checkout block.

Update the ssh invocation: the heredoc is 'REMOTE' so vars are not expanded. We need to pass DEPLOY_SHA. Use: ssh ... bash -s "$DEPLOY_USER" "$REPO_URL" "$INSTALL_DIR" "$SERVICE_NAME" "$SERVER_NAME" "$DEPLOY_BRANCH" "${DEPLOY_SHA:-}" <<'REMOTE'

And in the workflow, the Deploy step needs DEPLOY_SHA in env. We already added that. The deploy.sh script needs to receive env. When run from Actions, DEPLOY_SHA is in env. So deploy.sh has access. We need to pass it through to the remote. The heredoc uses $1, $2, etc. So add "$DEPLOY_SHA" or "${DEPLOY_SHA:-}" as another arg.
  </action>
  <verify>grep -A15 "cd.*INSTALL_DIR" deploy.sh | grep -E "DEPLOY_SHA|git fetch|git checkout"</verify>
  <done>deploy.sh checks out DEPLOY_SHA when set; otherwise pull branch</done>
</task>

</tasks>

<verification>
- workflow_dispatch with empty sha fails fast
- Checkout uses inputs.sha when workflow_dispatch
- deploy.sh receives DEPLOY_SHA and does git fetch + checkout
</verification>

<success_criteria>
- [ ] deploy.yml: sha input, checkout ref, DEPLOY_SHA env
- [ ] deploy.sh: DEPLOY_SHA checkout when set
- [ ] workflow_dispatch without sha fails
</success_criteria>

<output>
After completion, create `.planning/phases/14-governor-foundation-persistence/14-04-SUMMARY.md`
</output>
