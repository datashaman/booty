---
phase: 25-surfacing
plan: 02
type: execute
wave: 2
depends_on: [25-01]
files_modified:
  - src/booty/memory/surfacing.py
  - src/booty/webhooks.py
  - tests/test_memory_surfacing.py
autonomous: true

must_haves:
  truths:
    - "On Governor HOLD: find PR for commit, run fingerprint lookup, update same Memory comment with 1-2 hold-reason matches"
    - "If no PR found for commit: skip (no separate surface)"
    - "Governor section only when matches; omit when zero matches"
    - "Reuse comment_on_pr — Governor surfaces only when it can add to PR comment"
  artifacts:
    - path: src/booty/memory/surfacing.py
      provides: surface_governor_hold
      contains: def surface_governor_hold
    - path: src/booty/webhooks.py
      provides: Governor HOLD branch calls surface_governor_hold
  key_links:
    - from: workflow_run HOLD path
      to: surface_governor_hold
    - from: surface_governor_hold
      to: repo.get_commit(sha).get_pulls()
      pattern: Find PR for commit
---

<objective>
Implement Governor HOLD surfacing: when Governor holds deploy, find PR for the commit, run memory lookup by fingerprint (hold reason), and update the same Memory PR comment with 1-2 relevant matches. MEM-21.

Purpose: Surface prior incidents that match the hold reason (e.g. high_risk_no_approval, cooldown) so operators see related history.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/25-surfacing/25-CONTEXT.md
@.planning/phases/25-surfacing/25-RESEARCH.md
@src/booty/webhooks.py
@src/booty/release_governor/decision.py
@src/booty/memory/adapters.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: surface_governor_hold and PR lookup</name>
  <files>src/booty/memory/surfacing.py</files>
  <action>
Add to src/booty/memory/surfacing.py:

1. _find_pr_for_commit(gh_repo, head_sha: str) -> int | None
   - commit = gh_repo.get_commit(head_sha)
   - pulls = commit.get_pulls()  # PyGithub Commit.get_pulls()
   - Return first PR number if any, else None
   - Handle empty list / API errors; return None on any failure

2. surface_governor_hold(
     github_token: str,
     repo_full_name: str,
     head_sha: str,
     hold_reason: str,
     mem_config: MemoryConfig,
     state_dir: Path | None = None,
   ) -> None
   - If not mem_config.comment_on_pr: return
   - gh = Github(github_token); repo = gh.get_repo(repo_full_name)
   - pr_number = _find_pr_for_commit(repo, head_sha)
   - If not pr_number: return (no PR, skip per CONTEXT)
   - matches = lookup.query(paths=[], repo=repo_full_name, fingerprint=hold_reason, config=mem_config, state_dir=state_dir, max_matches=2)
   - If not matches: return (omit Governor section)
   - Build body: optionally combine with existing comment — RESEARCH says rebuild from scratch. For Governor-only: we have fingerprint matches. For full comment: we could also run path lookup from commit diff. Per CONTEXT "1-2 memory links" — keep simple: body = format_matches_for_pr(matches), with optional section header "### Related to this hold" before the list.
   - repo_url = f"https://github.com/{repo_full_name}"
   - post_memory_comment(github_token, repo_url, pr_number, body)

Note: This REPLACES the existing Memory comment body with Governor's section. If Builder already posted, we overwrite. Per RESEARCH: "each trigger builds the full body from scratch" — but Governor doesn't have PR paths easily (we'd need diff). Simpler: Governor only adds its section. So we need to MERGE. Read existing comment, parse, add Governor section, edit. Implementation: get issue comments, find one with <!-- booty-memory -->, get current body. If it has "### Related to this hold" section, replace that section. Else append "### Related to this hold\n\n{formatted}" before the marker. Then edit.

Simpler approach (RECOMMENDED): Governor replaces entire body with just Governor matches. If Builder already posted path matches, we lose them. CONTEXT says "include 1-2 memory links when hold reason matches" — implies we're ADDING. So merge. Implementation: get existing comment body. If no existing, create with Governor section. If existing, append Governor section before marker (insert "\n\n### Related to this hold\n\n" + formatted + "\n\n" before "<!-- booty-memory -->"). This preserves Builder's content.
  </action>
  <verify>python -c "
from booty.memory.surfacing import surface_governor_hold
assert callable(surface_governor_hold)
print('OK')
"</verify>
  <done>surface_governor_hold finds PR, runs fingerprint lookup, updates comment (merge or replace)</done>
</task>

<task type="auto">
  <name>Task 2: Wire Governor HOLD to surface_governor_hold</name>
  <files>src/booty/webhooks.py</files>
  <action>
In webhooks.py, in the workflow_run branch where decision.outcome != "ALLOW" (Governor HOLD path):

After post_hold_status(...) and before the memory ingestion block for governor_hold:
- mem_config is already loaded (for add_record). Apply env overrides.
- If mem_config and mem_config.enabled and mem_config.comment_on_pr:
  - In background_tasks or inline (background preferred to not block response): surface_governor_hold(settings.GITHUB_TOKEN, repo_full_name, head_sha, decision.reason, mem_config)
  - Use background_tasks.add_task(surface_governor_hold, ...) so webhook returns 202 promptly
  - Catch exceptions in surface_governor_hold; log on failure, do not re-raise (informational only)
  </action>
  <verify>python -c "
with open('src/booty/webhooks.py') as f:
    c = f.read()
assert 'surface_governor_hold' in c
# Governor HOLD path has the call
idx = c.find('post_hold_status')
assert idx >= 0
rest = c[idx:idx+2000]
assert 'surface_governor_hold' in rest or 'memory' in rest.lower()
print('OK')
"</verify>
  <done>Governor HOLD triggers surface_governor_hold when comment_on_pr</done>
</task>

<task type="auto">
  <name>Task 3: Merge logic for Governor section</name>
  <files>src/booty/github/comments.py, src/booty/memory/surfacing.py</files>
  <action>
Governor must APPEND its section to existing Memory comment, not replace.

Option A: Add post_memory_comment_append_section(github_token, repo_url, pr_number, section_title, section_body) that finds comment, appends section before marker, edits.

Option B: In surface_governor_hold, manually get issue, get_comments, find marker, build new body = existing + Governor section, edit.

Implement Option B in surface_governor_hold:
- Get repo, issue = repo.get_issue(pr_number) — wait, pr_number is for a PR; get_issue(pr_number) on a repo returns the PR as issue (PRs are issues).
- For comment in issue.get_comments(): if "<!-- booty-memory -->" in (comment.body or ""): found
- current_body = comment.body
- If "### Related to this hold" already in current_body: replace that section with new formatted matches (regex or string split)
- Else: insert "\n\n### Related to this hold\n\n" + formatted + "\n\n" before "<!-- booty-memory -->"
- comment.edit(new_body)
- If no comment found: create new with body = "## Memory: related history\n\n### Related to this hold\n\n{formatted}\n\n<!-- booty-memory -->"
  </action>
  <verify>Unit test: mock comment body with Builder section, call merge logic, assert Governor section appended correctly</verify>
  <done>Governor section merges into existing comment; creates new if none</done>
</task>

</tasks>

<verification>
- MEM-21: Governor HOLD includes 1-2 memory links when hold reason matches prior incidents
- No PR → skip
- comment_on_pr off → skip
- Zero matches → no Governor section added

<success_criteria>
- Governor HOLD updates PR comment with hold-reason matches when PR exists
- Section "### Related to this hold" appended or updated
- Informational only
