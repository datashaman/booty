---
phase: 29-plan-generation
plan: 03
type: execute
wave: 2
depends_on:
  - 29-01
  - 29-02
files_modified:
  - src/booty/planner/worker.py
  - src/booty/cli.py
autonomous: true

must_haves:
  truths:
    - Worker calls generate_plan(inp) then classify_risk_from_paths; overwrites plan.risk_level; stores
    - CLI booty plan --issue and booty plan --text use generation flow
    - Plan stored to $HOME/.booty/state/plans/<issue_id>.json (existing store)
    - Same normalized flow for webhook jobs and CLI
  artifacts:
    - path: src/booty/planner/worker.py
      provides: process_planner_job with LLM plan generation + risk classification
  key_links:
    - from: worker.py
      to: generation.py, risk.py
      via: generate_plan, classify_risk_from_paths
      pattern: process_planner_job
---

<objective>
Wire planner worker and CLI to generation flow. Replace skeleton plan with LLM-generated Plan. Apply risk classification after generation. Store to existing plan_path_for_issue.

Purpose: PLAN-25 — end-to-end valid Plan JSON from real issue; Phase 30 handles output delivery (comment, storage UX).
Output: worker and CLI call generate_plan → classify_risk → save_plan.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-plan-generation/29-CONTEXT.md
@.planning/phases/29-plan-generation/29-RESEARCH.md
@src/booty/planner/worker.py
@src/booty/planner/generation.py
@src/booty/planner/risk.py
@src/booty/planner/store.py
@src/booty/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire worker to generation and risk</name>
  <files>src/booty/planner/worker.py</files>
  <action>
Update process_planner_job in worker.py:

1. **Current behavior**: Builds minimal Plan with empty steps, LOW risk, basic handoff.
2. **New behavior**:
   - inp = normalize_from_job(job, repo_context=repo_context) — already done
   - plan = generate_plan(inp) — from generation.py (replaces manual Plan construction)
   - risk_level, risk_drivers = classify_risk_from_paths(plan.touch_paths)
   - plan = plan.model_copy(update={"risk_level": risk_level})
   - Optional: attach risk_drivers to plan metadata if schema supports (or leave for Phase 30 comment)
   - path = plan_path_for_issue(job.owner, job.repo, job.issue_number)
   - save_plan(plan, path)
   - logger.info with path, risk_level

3. Handle exceptions: magentic/LLM errors — log and re-raise or store fallback skeleton per project pattern. Check llm/prompts.py for retry/tenacity usage.

4. Remove manual Plan(goal=..., steps=[], ...) construction. Keep get_repo_context, normalize_from_job flow.
  </action>
  <verify>python -c "
from booty.planner.worker import process_planner_job
# At least imports resolve
from booty.planner.generation import generate_plan
from booty.planner.risk import classify_risk_from_paths
"</verify>
  <done>Worker calls generate_plan and classify_risk; stores Plan with correct risk_level</done>
</task>

<task type="auto">
  <name>Task 2: Wire CLI to generation flow</name>
  <files>src/booty/cli.py</files>
  <action>
Update booty plan --issue and booty plan --text handlers:

1. **plan --issue <n>**: 
   - Fetch issue, get repo from git, fetch repo_context if token
   - inp = normalize_github_issue(issue, repo_info, repo_context)
   - plan = generate_plan(inp)
   - risk_level, _ = classify_risk_from_paths(plan.touch_paths)
   - plan = plan.model_copy(update={"risk_level": risk_level})
   - save_plan to plan_path_for_issue(owner, repo, issue_number)
   - Print summary (goal, risk, step count) or path

2. **plan --text "..."**:
   - inp = normalize_cli_text(text, repo_info, repo_context)
   - plan = generate_plan(inp)
   - risk_level, _ = classify_risk_from_paths(plan.touch_paths)
   - plan = plan.model_copy(update={"risk_level": risk_level})
   - Save to temp path or plans/; print summary

3. Ensure same generation → risk → store flow as worker. Reuse plan_path_for_issue when owner/repo/issue known.
  </action>
  <verify>booty plan --text "Add auth validation" — completes without error; plan stored</verify>
  <done>CLI plan commands use generate_plan and risk classification</done>
</task>

</tasks>

<verification>
- [ ] process_planner_job uses generate_plan and classify_risk
- [ ] booty plan --issue and --text use same flow
- [ ] Plan stored with schema-valid JSON
- [ ] risk_level overwritten from touch_paths
</verification>
