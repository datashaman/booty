---
phase: 33-validation-rules
plan: 03
type: execute
wave: 3
depends_on: ["01", "02"]
files_modified:
  - src/booty/architect/worker.py
  - src/booty/main.py
  - tests/test_architect_worker.py
autonomous: true

must_haves:
  truths:
    - process_architect_input runs full validation pipeline
    - Blocked plans post "Architect review required — plan is structurally unsafe." and apply agent:architect-review
    - Rewrite retry: one additional attempt on validation failure after rewrite
    - Architect completes in < 5 seconds
  artifacts:
    - path: src/booty/architect/worker.py
      provides: process_architect_input with validation pipeline
  key_links:
    - from: src/booty/architect/worker.py
      to: booty.architect.validation
      via: validate_structural, validate_paths, ensure_touch_paths_and_risk
      pattern: "from booty.architect.validation import"
    - from: src/booty/architect/worker.py
      to: booty.architect.rewrite
      via: rewrite_ambiguous_steps, try_rewrite_overreach
      pattern: "from booty.architect.rewrite import"
    - from: src/booty/main.py
      to: booty.architect.worker.process_architect_input
      via: existing call site
      pattern: "process_architect_input"
---

<objective>
Integrate validation and rewrite into Architect worker; implement block flow and retry (ARCH-19, ARCH-20, ARCH-21, ARCH-22, ARCH-34).

Purpose: process_architect_input runs validation, rewrites when needed, blocks with fixed message when structurally unsafe.

Output: Updated worker.py; tests; < 5s runtime asserted.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-validation-rules/33-CONTEXT.md
@src/booty/architect/worker.py
@src/booty/architect/config.py
@src/booty/architect/validation.py
@src/booty/architect/rewrite.py
@src/booty/main.py
@src/booty/github/comments.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validation pipeline in worker</name>
  <files>src/booty/architect/worker.py</files>
  <action>
Update process_architect_input in worker.py:

1. Normalize inp.plan to Plan: Plan.model_validate(inp.plan) if isinstance(inp.plan, dict) else inp.plan. On ValidationError, return ArchitectResult(approved=False, plan=inp.plan, architect_notes="Invalid plan structure").

2. Run validation pipeline in order:
   - validate_structural(plan) → if blocks: return blocked
   - validate_paths(plan) → if blocks: return blocked
   - ensure_touch_paths_and_risk(plan) — update plan in place
   - rewrite_ambiguous_steps(plan, config) — get (plan, notes)
   - check_overreach(plan) + try_rewrite_overreach if overreach

3. On any block: return ArchitectResult(approved=False, plan=inp.plan, architect_notes="Architect review required — plan is structurally unsafe." plus short reason)
   - Caller (main.py) already calls post_architect_blocked_comment and add_architect_review_label — no changes needed there
   - ARCH-21: do NOT trigger Builder when blocked (main.py already handles this)
   - ARCH-22: no automatic retries (caller does not retry)

4. Retry logic per CONTEXT: if rewrite produces invalid plan, retry validation once. If still fails, block.

5. Aggregate architect_notes from path mismatch, ambiguity flags, overreach notes.
  </action>
  <verify>pytest tests/test_architect_worker.py -v</verify>
  <done>Full pipeline runs; blocks with correct message; notes accumulated</done>
</task>

<task type="auto">
  <name>Task 2: Tests and performance</name>
  <files>tests/test_architect_worker.py</files>
  <action>
1. Add integration tests: process_architect_input with valid plan returns approved; with >12 steps returns blocked; with invalid action returns blocked.
2. Add test asserting process_architect_input completes in < 5 seconds for typical plan (e.g. 5 steps). Use pytest with timeout or assert time.perf_counter() delta < 5.
3. Ensure existing Phase 32 tests still pass.
  </action>
  <verify>pytest tests/test_architect*.py -v</verify>
  <done>Integration tests pass; < 5s asserted</done>
</task>

</tasks>

<verification>
- process_architect_input uses validation and rewrite modules
- Block flow does not trigger Builder
- ARCH-34 satisfied
</verification>

<success_criteria>
- ARCH-19, ARCH-20, ARCH-21, ARCH-22, ARCH-34 covered
- All architect tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/33-validation-rules/33-03-SUMMARY.md`
</output>
