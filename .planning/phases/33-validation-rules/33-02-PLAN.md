---
phase: 33-validation-rules
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/booty/architect/rewrite.py
  - src/booty/architect/__init__.py
  - tests/test_architect_rewrite.py
autonomous: true

must_haves:
  truths:
    - Architect detects ambiguous steps (vague acceptance, missing specifics)
    - Architect rewrites ambiguous steps when rewrite_ambiguous_steps enabled
    - Architect flags ambiguous steps in architect_notes when rewrite disabled
    - Architect detects overreach (repo-wide, multi-domain, speculative arch)
    - Architect rewrites into smaller scope when possible
  artifacts:
    - path: src/booty/architect/rewrite.py
      provides: check_ambiguity, check_overreach, rewrite_ambiguous_steps, try_rewrite_overreach
    - path: tests/test_architect_rewrite.py
      provides: Unit tests for ambiguity and overreach
  key_links:
    - from: src/booty/architect/rewrite.py
      to: booty.architect.config
      via: ArchitectConfig.rewrite_ambiguous_steps
      pattern: "config.rewrite_ambiguous_steps"
---

<objective>
Implement ambiguity and overreach detection and rewrite for Architect (ARCH-13, ARCH-14, ARCH-15).

Purpose: Architect rewrites vague or overreaching steps when config permits. Rule-driven; no LLM.

Output: rewrite.py with check_ambiguity, check_overreach, rewrite_plan; unit tests.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-validation-rules/33-CONTEXT.md
@.planning/phases/33-validation-rules/33-RESEARCH.md
@src/booty/planner/schema.py
@src/booty/architect/config.py
@src/booty/architect/validation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ambiguity detection and rewrite</name>
  <files>src/booty/architect/rewrite.py</files>
  <action>
Create src/booty/architect/rewrite.py with:

1. AMBIGUITY_PATTERNS: list of regex/strings - e.g. "fix", "improve", "as needed", "update", "refactor" (standalone or in vague context)
2. check_ambiguity(plan: Plan) -> list[tuple[int, str]]
   - Returns list of (step_index, reason) for ambiguous steps
   - Triggers: acceptance &lt; 15 chars; action+path/edit with acceptance matching AMBIGUITY_PATTERNS
   - Per CONTEXT: moderate scope - infer path from context when possible; otherwise narrow wording only

3. rewrite_ambiguous_steps(plan: Plan, config: ArchitectConfig) -> tuple[Plan, list[str]]
   - If not config.rewrite_ambiguous_steps: return (plan, list of flag messages for architect_notes)
   - If enabled: for each ambiguous step, try to tighten acceptance or infer path; return (modified_plan, notes)
   - Per CONTEXT: do not aggressively infer; block only if rewrite fails after one retry (handled in worker)
  </action>
  <verify>pytest tests/test_architect_rewrite.py -k "ambiguity" -v</verify>
  <done>Ambiguous steps detected; rewrite tightens when enabled; flags when disabled</done>
</task>

<task type="auto">
  <name>Task 2: Overreach detection and rewrite</name>
  <files>src/booty/architect/rewrite.py</files>
  <action>
Add to rewrite.py:

1. DOMAINS: src/, tests/, docs/, infra/, .github/
2. check_overreach(plan: Plan) -> list[str]
   - Repo-wide: touch_paths count ≥ 8 OR directory spread (paths in 3+ distinct domain prefixes)
   - Multi-domain: paths touch 2+ of DOMAINS
   - Speculative: goal or acceptance contains "refactor architecture", "improve structure", "technical debt" (keyword match)
   - Return list of reasons (empty if none)

3. try_rewrite_overreach(plan: Plan) -> tuple[Plan | None, list[str]]
   - Try to split into smaller steps or narrow scope per CONTEXT
   - If consolidation possible (e.g. merge related steps to fit ≤12): return (modified_plan, notes)
   - If neither works: return (None, reasons) — worker will block

Export from architect/__init__.py.
  </action>
  <verify>pytest tests/test_architect_rewrite.py -v</verify>
  <done>Overreach detected; rewrite attempted; returns modified plan or None for block</done>
</task>

</tasks>

<verification>
- Ambiguity and overreach logic covered by tests
- No LLM in rewrite module
</verification>

<success_criteria>
- ARCH-13, ARCH-14, ARCH-15 covered
- rewrite.py passes tests
</success_criteria>

<output>
After completion, create `.planning/phases/33-validation-rules/33-02-SUMMARY.md`
</output>
