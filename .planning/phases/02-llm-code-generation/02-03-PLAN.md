---
phase: 02-llm-code-generation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/git/__init__.py
  - src/booty/git/operations.py
  - src/booty/github/__init__.py
  - src/booty/github/pulls.py
autonomous: true

must_haves:
  truths:
    - "Code changes can be committed to workspace with conventional commit messages"
    - "Feature branch can be pushed to remote with authentication"
    - "Pull request appears on GitHub with title, structured body, and issue reference"
  artifacts:
    - path: "src/booty/git/operations.py"
      provides: "Git commit and push operations"
      exports: ["commit_changes", "push_to_remote"]
      min_lines: 25
    - path: "src/booty/github/pulls.py"
      provides: "PR creation via PyGithub"
      exports: ["create_pull_request"]
      min_lines: 30
  key_links:
    - from: "src/booty/git/operations.py"
      to: "git.Repo"
      via: "GitPython index.add/commit and push"
      pattern: "repo\\.index\\.(add|commit)"
    - from: "src/booty/github/pulls.py"
      to: "github.Github"
      via: "PyGithub Auth.Token and create_pull"
      pattern: "create_pull"
---

<objective>
Build git commit/push operations and GitHub PR creation — the output side of the pipeline.

Purpose: REQ-10 (PR creation with explanation) and REQ-11 (multi-file changes committed together).
Output: Functions to commit changes, push branches, and create PRs with structured descriptions.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-llm-code-generation/02-RESEARCH.md
@src/booty/repositories.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Git commit and push operations</name>
  <files>src/booty/git/__init__.py, src/booty/git/operations.py</files>
  <action>
  1. Create src/booty/git/__init__.py (empty package init).

  2. Create src/booty/git/operations.py with:

  **commit_changes(repo: git.Repo, file_paths: list[str], message: str) -> str**
  - Stage files with repo.index.add(file_paths)
  - For deleted files, use repo.index.remove(deleted_paths) instead
  - Commit with repo.index.commit(message)
  - Return the commit SHA (str(commit))
  - Accept a `deleted_paths: list[str] = None` parameter for files to remove

  **push_to_remote(repo: git.Repo, github_token: str = "") -> None**
  - Get origin remote: repo.remote(name="origin")
  - If github_token provided, update the remote URL to inject token (same pattern as repositories.py: replace https:// with https://{token}@)
  - Push with upstream tracking: repo.git.push("--set-upstream", "origin", repo.active_branch.name)
  - Run push in executor (asyncio.get_running_loop().run_in_executor) since GitPython is blocking
  - This function should be async

  **format_commit_message(commit_type: str, scope: str | None, summary: str, body: str, issue_number: int) -> str**
  - Format conventional commit: "{type}({scope}): {summary}" or "{type}: {summary}" if no scope
  - Add body after blank line
  - Add "Resolves #{issue_number}" footer
  - Add "Co-Authored-By: Booty Agent <noreply@booty.dev>" footer

  Import git, asyncio. Use booty.logging.get_logger for structured logging.
  </action>
  <verify>
  Run:
  ```
  python -c "
  from booty.git.operations import format_commit_message
  msg = format_commit_message('feat', 'auth', 'add login endpoint', 'JWT-based auth', 42)
  assert 'feat(auth): add login endpoint' in msg
  assert 'Resolves #42' in msg
  assert 'Co-Authored-By: Booty Agent' in msg
  print('OK:', repr(msg[:60]))
  "
  ```
  </verify>
  <done>commit_changes stages and commits files. push_to_remote pushes with token auth (async). format_commit_message produces conventional commit format with issue reference.</done>
</task>

<task type="auto">
  <name>Task 2: PR creation via PyGithub</name>
  <files>src/booty/github/__init__.py, src/booty/github/pulls.py</files>
  <action>
  1. Create src/booty/github/__init__.py (empty package init).

  2. Create src/booty/github/pulls.py with:

  **create_pull_request(github_token: str, repo_url: str, head_branch: str, base_branch: str, title: str, body: str) -> int**
  - Parse owner/repo from repo_url (handle both https://github.com/owner/repo and https://github.com/owner/repo.git)
  - Create Github instance with Auth.Token(github_token)
  - Get repo via g.get_repo("owner/repo")
  - Create PR with repo.create_pull(title=title, body=body, head=head_branch, base=base_branch)
  - Log PR creation with structlog
  - Return pr.number
  - Wrap in try/except for GithubException, log and re-raise

  **format_pr_body(approach: str, file_changes: list[dict], testing_notes: str, issue_number: int) -> str**
  - Accept file_changes as list of dicts with keys: path, operation, explanation
  - Format structured PR body:
    ```
    ## Summary
    {approach}

    ## Changes
    | File | Operation | Description |
    |------|-----------|-------------|
    | {path} | {operation} | {explanation} |

    ## Testing
    {testing_notes}

    ---
    Fixes #{issue_number}
    Generated by [Booty](https://github.com/datashaman/booty)
    ```
  - Return the formatted string

  Import: from github import Github, Auth, GithubException
  Import: from urllib.parse import urlparse
  Use booty.logging.get_logger for structured logging.

  Note: Do NOT import booty.llm.models here — accept plain dicts/strings to keep this module independent. The orchestrator will convert.
  </action>
  <verify>
  Run:
  ```
  python -c "
  from booty.github.pulls import format_pr_body
  body = format_pr_body(
      approach='Added JWT auth',
      file_changes=[{'path': 'src/auth.py', 'operation': 'create', 'explanation': 'New auth module'}],
      testing_notes='Run pytest',
      issue_number=42
  )
  assert '## Summary' in body
  assert 'Fixes #42' in body
  assert 'src/auth.py' in body
  print('OK')
  "
  ```
  </verify>
  <done>create_pull_request creates GitHub PR with PyGithub, returns PR number. format_pr_body produces structured markdown description with changes table and issue reference.</done>
</task>

</tasks>

<verification>
- [ ] format_commit_message produces valid conventional commit with scope, body, footer
- [ ] commit_changes stages and commits (tested by later orchestrator plan)
- [ ] push_to_remote is async and injects token into remote URL
- [ ] create_pull_request parses owner/repo from URL correctly
- [ ] format_pr_body includes summary, changes table, testing notes, issue reference
- [ ] No dependencies on booty.llm.models (stays independent)
</verification>

<success_criteria>
Git operations and PR creation modules complete. Can commit multi-file changes with conventional commits, push authenticated branches, and create structured PRs on GitHub.
</success_criteria>

<output>
After completion, create `.planning/phases/02-llm-code-generation/02-03-SUMMARY.md`
</output>
