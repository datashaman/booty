---
phase: 38-agent-pr-detection-event-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/reviewer/__init__.py
  - src/booty/reviewer/job.py
  - src/booty/reviewer/queue.py
autonomous: true

must_haves:
  truths:
    - "ReviewerJob carries repo, pr_number, head_sha, payload, is_agent_pr"
    - "ReviewerQueue uses dedup key repo_full_name:pr_number:head_sha"
    - "New SHA for same PR requests cancel of prior in-flight run"
    - "enqueue returns False on duplicate; marks processed before put"
  artifacts:
    - path: src/booty/reviewer/job.py
      provides: ReviewerJob dataclass
      contains: "ReviewerJob"
    - path: src/booty/reviewer/queue.py
      provides: ReviewerQueue with enqueue, is_duplicate, cancel
      min_lines: 80
  key_links:
    - from: ReviewerQueue
      to: ReviewerJob
      via: enqueue(job)
      pattern: ReviewerJob
---

<objective>
Create ReviewerJob dataclass and ReviewerQueue with repo-inclusive dedup and cooperative cancel.

Purpose: REV-03 — Dedup key (repo, pr_number, head_sha); new synchronize with new SHA cancels prior in-progress (best-effort).
Output: reviewer/job.py, reviewer/queue.py
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-agent-pr-detection-event-wiring/38-CONTEXT.md
@.planning/phases/38-agent-pr-detection-event-wiring/38-RESEARCH.md
@src/booty/verifier/job.py
@src/booty/verifier/queue.py
@src/booty/security/queue.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: ReviewerJob dataclass</name>
  <files>src/booty/reviewer/job.py</files>
  <action>
Create src/booty/reviewer/job.py mirroring VerifierJob:

@dataclass
class ReviewerJob:
    job_id: str
    owner: str
    repo_name: str
    pr_number: int
    head_sha: str
    head_ref: str
    repo_url: str
    installation_id: int
    payload: dict
    is_agent_pr: bool = True  # Webhook only enqueues for agent PRs

Add cancel_event: asyncio.Event | None = None — queue sets it for cancel signaling. Worker checks cancel_event.is_set() at phase boundaries.
  </action>
  <verify>python -c "from booty.reviewer.job import ReviewerJob; j = ReviewerJob('r-1','o','r',1,'abc','ref','url',0,{},True); print(j.job_id)"</verify>
  <done>ReviewerJob importable with required fields</done>
</task>

<task type="auto">
  <name>Task 2: ReviewerQueue with dedup and cancel</name>
  <files>src/booty/reviewer/queue.py</files>
  <action>
Create src/booty/reviewer/queue.py mirroring VerifierQueue with extensions:

1. _dedup_key(repo_full_name, pr_number, head_sha) -> str: return f"{repo_full_name}:{pr_number}:{head_sha}"
2. is_duplicate(repo_full_name, pr_number, head_sha) -> bool
3. mark_processed(repo_full_name, pr_number, head_sha)
4. request_cancel(repo_full_name, pr_number) -> None: if (repo_full_name, pr_number) in _cancel_events, set the Event to signal in-flight worker
5. enqueue(job: ReviewerJob) -> bool: 
   - Build repo_full_name = f"{job.owner}/{job.repo_name}"
   - Call request_cancel(repo_full_name, job.pr_number) to cancel prior run for same PR
   - Create new asyncio.Event for this run, store in _cancel_events[(repo_full_name, pr_number)]
   - Attach to job: job.cancel_event = event (add to dataclass or setattr)
   - If is_duplicate: return False
   - mark_processed, put on queue, return True
   - Cap _processed at 10000 (deque eviction)
6. worker(worker_id, process_fn), start_workers, shutdown — same pattern as VerifierQueue
7. Worker must clear _cancel_events[(repo, pr)] when done (normally or cancelled)

Note: ReviewerJob needs cancel_event. Add as optional attribute. Queue sets job.cancel_event = event before enqueue (use setattr if not in dataclass).

4. reviewer/__init__.py: Add ReviewerJob, ReviewerQueue to imports and __all__ (mirror booty.security exports).
  </action>
  <verify>python -c "from booty.reviewer import ReviewerJob, ReviewerQueue; q = ReviewerQueue(); print(hasattr(q,'enqueue'))"</verify>
  <done>ReviewerQueue has enqueue, is_duplicate, request_cancel; worker pattern matches VerifierQueue; reviewer module exports Job and Queue</done>
</task>

</tasks>

<verification>
- ReviewerJob has all fields needed for webhook (owner, repo_name, pr_number, head_sha, etc.)
- ReviewerQueue dedup key includes repo for multi-repo safety
- request_cancel sets Event so worker can exit early
</verification>

<success_criteria>
- ReviewerJob and ReviewerQueue importable
- Queue accepts ReviewerJob, returns bool from enqueue
</success_criteria>

<output>
After completion, create .planning/phases/38-agent-pr-detection-event-wiring/38-01-SUMMARY.md
</output>
