---
phase: 38-agent-pr-detection-event-wiring
plan: 02
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - src/booty/webhooks.py
autonomous: true

must_haves:
  truths:
    - "pull_request opened/synchronize/reopened enqueues ReviewerJob for agent PRs only"
    - "Reviewer uses same agent PR detection as Verifier (TRIGGER_LABEL, Bot, agent/issue-)"
    - "Early return includes reviewer_ok — all three disabled before ignore"
  artifacts:
    - path: src/booty/webhooks.py
      provides: Reviewer enqueue in pull_request handler
  key_links:
    - from: webhooks
      to: reviewer
      via: reviewer_queue.enqueue(ReviewerJob)
      pattern: ReviewerJob|reviewer_queue
---

<objective>
Wire pull_request webhook to Reviewer — enqueue ReviewerJob for agent PRs only when reviewer_queue exists.

Purpose: REV-01, REV-02 — Reviewer runs on pull_request opened/synchronize/reopened; only for agent PRs (same detection as Verifier).
Output: webhooks.py Reviewer enqueue block.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-agent-pr-detection-event-wiring/38-CONTEXT.md
@.planning/phases/38-agent-pr-detection-event-wiring/38-RESEARCH.md
@src/booty/webhooks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reviewer_ok to pull_request early return</name>
  <files>src/booty/webhooks.py</files>
  <action>
In github_webhook pull_request block, update the early return condition:

1. Get reviewer_queue = getattr(request.app.state, "reviewer_queue", None)
2. reviewer_ok = reviewer_queue is not None and verifier_enabled(settings) — Reviewer uses same GitHub App as Verifier
3. Change condition from:
   if not verifier_ok and not security_ok:
   to:
   if not verifier_ok and not security_ok and not reviewer_ok:

So we only return "verifier_and_security_disabled" (or rename log reason to "all_pr_agents_disabled") when all three are disabled. If any of Verifier, Security, or Reviewer is enabled, we continue processing.
  </action>
  <verify>grep -n "reviewer_ok\|reviewer_queue" src/booty/webhooks.py | head -5</verify>
  <done>Early return condition includes reviewer_ok</done>
</task>

<task type="auto">
  <name>Task 2: Reviewer enqueue for agent PRs only</name>
  <files>src/booty/webhooks.py</files>
  <action>
In github_webhook pull_request block, after Security enqueue block and before the return statement, add Reviewer enqueue:

1. if reviewer_ok and is_agent_pr:
   - repo_full_name = f"{owner}/{repo_name}"
   - if reviewer_queue.is_duplicate(repo_full_name, pr_number, head_sha): skip (log reviewer_already_processed if desired)
   - else:
     - job_id = f"reviewer-{pr_number}-{head_sha[:7]}"
     - job = ReviewerJob(job_id=job_id, owner=owner, repo_name=repo_name, pr_number=pr_number, head_sha=head_sha, head_ref=head_ref, repo_url=repo_url, installation_id=installation_id, payload=payload, is_agent_pr=True)
     - enqueued = await reviewer_queue.enqueue(job)
     - if enqueued: log reviewer_job_accepted

2. Import ReviewerJob from booty.reviewer.job

Reviewer runs ONLY for agent PRs — do not enqueue when is_agent_pr is False. Verifier and Security run on all PRs; Reviewer runs only on agent PRs.
  </action>
  <verify>grep -A2 "is_agent_pr" src/booty/webhooks.py | grep -E "reviewer|Reviewer"</verify>
  <done>Agent PRs enqueue ReviewerJob; non-agent PRs skip Reviewer</done>
</task>

</tasks>

<verification>
- pull_request handler enqueues Reviewer when reviewer_ok and is_agent_pr
- Dedup uses repo_full_name:pr_number:head_sha (via queue)
</verification>

<success_criteria>
- Reviewer enqueue block present in webhooks.py
- Condition reviewer_ok and is_agent_pr gates enqueue
</success_criteria>

<output>
After completion, create .planning/phases/38-agent-pr-detection-event-wiring/38-02-SUMMARY.md
</output>
