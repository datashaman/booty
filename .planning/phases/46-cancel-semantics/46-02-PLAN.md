---
phase: 46-cancel-semantics
plan: 02
type: execute
wave: 2
depends_on: ['01']
files_modified:
  - src/booty/verifier/runner.py
autonomous: true

must_haves:
  truths:
    - Verifier runner checks cancel_event at phase boundaries
    - Superseded run exits with conclusion=cancelled
    - Check run shows "Booty Verifier — Cancelled" / "Cancelled — superseded by new push"
  artifacts:
    - path: src/booty/verifier/runner.py
      provides: process_verifier_job with cancel checks
      contains: cancel_event|conclusion.*cancelled
  key_links:
    - from: src/booty/verifier/runner.py
      to: VerifierJob.cancel_event
      via: getattr(job, "cancel_event", None) and job.cancel_event.is_set()
      pattern: cancel_event
---

<objective>
Add cancel_event checks at phase boundaries in process_verifier_job. When cancel_event is set, exit with edit_check_run(conclusion="cancelled", output={"title":"Booty Verifier — Cancelled","summary":"Cancelled — superseded by new push"}).

Purpose: DEDUP-05 — Verifier runner checks cancel_event; superseded run exits with conclusion=cancelled.
Output: Runner checks cancel at entry, before clone, after setup/install, before tests, before promote; all early returns and failure paths check cancel; overwrite failure to cancelled when cancel_event set.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-cancel-semantics/46-CONTEXT.md
@.planning/phases/46-cancel-semantics/46-RESEARCH.md
@.planning/phases/46-cancel-semantics/46-01-SUMMARY.md
@src/booty/verifier/runner.py
@src/booty/reviewer/runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper and entry/before-clone cancel checks</name>
  <files>src/booty/verifier/runner.py</files>
  <action>
1. Add helper at top of file (after imports):
   def _check_cancel(job, check_run): returns True if job.cancel_event set; if check_run exists, edit_check_run(check_run, status="completed", conclusion="cancelled", output={"title":"Booty Verifier — Cancelled","summary":"Cancelled — superseded by new push"}); return True. Else return False.

2. At very start of process_verifier_job (before verifier_enabled): if cancel before check run, we must still create check run with cancelled (per 46-CONTEXT: "Cancelled before check run created: Create check run with conclusion=cancelled"). So: check cancel; if set, create_check_run with status="completed" conclusion="cancelled" output as above, return.

3. After create_check_run (line ~214): if _check_cancel(job, check_run): return

4. Before agent PR schema/limits block: check cancel. Before each early return in schema validation, limits, config validation: add _check_cancel before return; if cancelled, overwrite to cancelled and return.
</action>
  <verify>grep -n "cancel_event\|cancelled\|_check_cancel" src/booty/verifier/runner.py | head -30</verify>
  <done>Entry and before-clone cancel checks in place; early returns (schema, limits) check cancel and overwrite to cancelled.</done>
</task>

<task type="auto">
  <name>Task 2: Add cancel checks at remaining phase boundaries</name>
  <files>src/booty/verifier/runner.py</files>
  <action>
Add _check_cancel(job, check_run) before each of these points (return if True):

1. After edit_check_run(in_progress) — before load_booty_config in workspace
2. After setup_command success — before install_command
3. After install_command success — before compile/import sweep
4. After compile/import sweep — before execute_tests
5. After execute_tests, before promotion-gate logic (before reviewer_check_success / architect gates)
6. After any edit_check_run(conclusion="failure") — before the actual return, check cancel and overwrite to cancelled if set
7. In the outer except Exception block: after edit_check_run(failure), check cancel and overwrite to cancelled if set

Use pattern: getattr(job, "cancel_event", None) and job.cancel_event.is_set() for the check (same as Reviewer). Ensure helper _check_cancel handles both cases: check_run exists (edit and return) or check_run is None (just return True).
</action>
  <verify>grep -c "cancel_event\|_check_cancel" src/booty/verifier/runner.py</verify>
  <done>All phase boundaries (entry, pre-clone, post-setup, post-install, pre-tests, pre-promote) check cancel; failure paths overwrite to cancelled when cancel_event set.</done>
</task>

</tasks>

<verification>
- 5–6+ cancel check points in runner
- Conclusion "cancelled" with title "Booty Verifier — Cancelled", summary "Cancelled — superseded by new push"
- All early returns and failure paths check cancel
</verification>

<success_criteria>
- DEDUP-03: Prior run marked cancelled when superseded
- DEDUP-05: Verifier runner checks cancel_event at phase boundaries; exits with conclusion=cancelled
</success_criteria>

<output>
After completion, create .planning/phases/46-cancel-semantics/46-02-SUMMARY.md
</output>
