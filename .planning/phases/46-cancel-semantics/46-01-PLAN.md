---
phase: 46-cancel-semantics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/verifier/job.py
  - src/booty/verifier/queue.py
autonomous: true

must_haves:
  truths:
    - VerifierQueue has request_cancel(repo_full_name, pr_number)
    - New head_sha for same PR triggers cancel of prior in-flight Verifier run
    - VerifierJob carries cancel_event set by queue
  artifacts:
    - path: src/booty/verifier/job.py
      provides: VerifierJob with cancel_event
      contains: cancel_event
    - path: src/booty/verifier/queue.py
      provides: VerifierQueue with request_cancel and _cancel_events
      contains: request_cancel|_cancel_events
  key_links:
    - from: src/booty/verifier/queue.py
      to: VerifierJob
      via: job.cancel_event = event before enqueue
      pattern: cancel_event
---

<objective>
Add request_cancel support to VerifierQueue mirroring ReviewerQueue. When a new head_sha for the same PR is enqueued, prior in-flight run is signalled to cancel via asyncio.Event.

Purpose: DEDUP-03 â€” new head_sha supersedes old run; prior run marked cancelled.
Output: VerifierJob with cancel_event; VerifierQueue with request_cancel, _cancel_events; enqueue wires cancel flow; worker clears _cancel_events on completion.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-cancel-semantics/46-CONTEXT.md
@.planning/phases/46-cancel-semantics/46-RESEARCH.md
@src/booty/reviewer/queue.py
@src/booty/reviewer/job.py
@src/booty/verifier/queue.py
@src/booty/verifier/job.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cancel_event to VerifierJob</name>
  <files>src/booty/verifier/job.py</files>
  <action>
Add cancel_event: asyncio.Event | None = None to VerifierJob dataclass. Mirror ReviewerJob. Import asyncio if not already imported.
</action>
  <verify>grep -n "cancel_event" src/booty/verifier/job.py</verify>
  <done>VerifierJob has cancel_event attribute (default None); queue will set it on enqueue.</done>
</task>

<task type="auto">
  <name>Task 2: Add request_cancel and _cancel_events to VerifierQueue</name>
  <files>src/booty/verifier/queue.py</files>
  <action>
1. Add _cancel_events: dict[tuple[str, int], asyncio.Event] = {} in __init__

2. Add request_cancel(self, repo_full_name: str, pr_number: int) -> None: if (repo_full_name, pr_number) in self._cancel_events, call self._cancel_events[key].set()

3. In enqueue, BEFORE mark_processed:
   - Call self.request_cancel(repo_full_name, job.pr_number)
   - Create event = asyncio.Event()
   - Store self._cancel_events[(repo_full_name, job.pr_number)] = event
   - Attach job.cancel_event = event
   - Then mark_processed, put on queue

4. On enqueue timeout (asyncio.TimeoutError): pop _cancel_events[(repo_full_name, job.pr_number)] and discard from _processed, same as ReviewerQueue

5. In worker's try/finally (after process_fn(job)), add: self._cancel_events.pop((repo_full_name, job.pr_number), None) where repo_full_name = f"{job.owner}/{job.repo_name}"
</action>
  <verify>grep -n "request_cancel\|_cancel_events\|cancel_event" src/booty/verifier/queue.py</verify>
  <done>VerifierQueue has request_cancel; enqueue cancels prior run for same PR and attaches cancel_event to job; worker clears _cancel_events on completion.</done>
</task>

</tasks>

<verification>
- request_cancel exists and sets event when (repo, pr) in _cancel_events
- enqueue calls request_cancel before put; creates event; attaches to job
- worker clears _cancel_events in finally block
</verification>

<success_criteria>
- DEDUP-03 (partial): New head_sha triggers cancel signal for prior run
- VerifierQueue mirrors ReviewerQueue cancel pattern
</success_criteria>

<output>
After completion, create .planning/phases/46-cancel-semantics/46-01-SUMMARY.md
</output>
