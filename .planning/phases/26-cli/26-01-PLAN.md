---
phase: 26-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/cli.py
  - tests/test_memory_cli.py
autonomous: true

must_haves:
  truths:
    - "booty memory status prints enabled, record count, retention_days (MEM-27)"
    - "booty memory query --pr <n> prints matches for PR changed files; supports --json (MEM-28)"
    - "booty memory query --sha <sha> prints matches after resolving PR for commit; supports --json (MEM-28)"
    - "Memory disabled shows 'Memory disabled' and exits appropriately"
    - "GITHUB_TOKEN required for query; clear error when missing"
  artifacts:
    - path: src/booty/cli.py
      provides: booty memory status, booty memory query
      contains: def memory_status, def memory_query
    - path: tests/test_memory_cli.py
      provides: CLI unit tests
  key_links:
    - from: memory_status
      to: memory.store.read_records
      via: get_memory_state_dir, memory.jsonl path
    - from: memory_query
      to: memory.lookup.query
      via: paths from pr.get_files or commit.get_pulls
---

<objective>
Implement booty memory status and booty memory query per MEM-27, MEM-28.

Purpose: Operators can inspect memory state (enabled, record count, retention) and query related history by PR or SHA.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-cli/26-RESEARCH.md
@src/booty/cli.py
@src/booty/memory/__init__.py
@src/booty/memory/lookup.py
@src/booty/memory/store.py
@src/booty/memory/config.py
@src/booty/memory/surfacing.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: booty memory status</name>
  <files>src/booty/cli.py</files>
  <action>
Add `booty memory status` subcommand to the existing `@cli.group() def memory()` group:

1. Signature: `@memory.command()` def `memory_status(workspace, as_json)`
   - `--workspace`: `click.Path(exists=True, file_okay=False)`, default `.`
   - `--json`: `is_flag=True` for machine-readable output

2. Logic:
   - `ws = Path(workspace).resolve()`
   - `config = load_booty_config(ws)` — catch Exception → echo "Memory disabled", exit 0
   - `mem_config = get_memory_config(config)` — None → "Memory disabled", exit 0
   - `mem_config = apply_memory_env_overrides(mem_config)`
   - If `not mem_config.enabled`: echo "Memory disabled", exit 0
   - `state_dir = get_memory_state_dir()` from booty.memory.store
   - Record count: `path = state_dir / "memory.jsonl"`; `records = read_records(path)`; filter by `within_retention(rec, mem_config.retention_days)` from lookup module; count = len(filtered)
   - Output: enabled=true, records={count}, retention_days={mem_config.retention_days}
   - Human format: "enabled: true\nrecords: 42\nretention_days: 90"
   - JSON: `{"enabled":true,"records":42,"retention_days":90}`

3. Import: `from booty.memory.store import get_memory_state_dir, read_records`; `from booty.memory.lookup import within_retention`; `from booty.memory.config import get_memory_config, apply_memory_env_overrides`
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && pip install -e . -q 2>/dev/null; booty memory status --help 2>/dev/null
booty memory status 2>/dev/null || true
  </verify>
  <done>booty memory status prints enabled, records, retention_days per MEM-27</done>
</task>

<task type="auto">
  <name>Task 2: booty memory query</name>
  <files>src/booty/cli.py</files>
  <action>
Add `booty memory query` subcommand:

1. Signature:
   - `--pr`: optional int, PR number
   - `--sha`: optional str, commit SHA
   - `--repo`: required when cannot infer; optional otherwise
   - `--workspace`: default `.`
   - `--json`: is_flag=True
   - Mutually exclusive: require exactly one of --pr or --sha; raise click.UsageError if both or neither

2. Logic:
   - Resolve repo: `--repo` or `_infer_repo_from_git(Path(workspace))`; if missing → "Use --repo owner/repo", exit 1
   - GITHUB_TOKEN from `get_settings().GITHUB_TOKEN`; if empty → "GITHUB_TOKEN required", exit 1
   - Config: load_booty_config(ws), get_memory_config, apply_memory_env_overrides; if disabled → "Memory disabled", exit 0
   - Resolve paths:
     - If --pr: `gh_repo.get_pull(pr_number)`, `paths = [f.filename for f in pr.get_files()]`
     - If --sha: `commit = gh_repo.get_commit(sha)`; `pulls = list(commit.get_pulls())`; if empty → "No PR found for sha", exit 1; `pr = pulls[0]`; paths = [f.filename for f in pr.get_files()]
   - Query: `matches = memory.query(paths=paths, repo=repo_name, config=mem_config, state_dir=get_memory_state_dir())`
   - Output: Human — per match "**{type}** ({date}) — {summary} [link]" (reuse format from surfacing.format_matches_for_pr or inline similar logic); JSON — list of {type, timestamp, summary, links, id}

3. Import: `from booty.memory import query as memory_query` or `from booty.memory.lookup import query`; `from booty.memory.store import get_memory_state_dir`
</action>
  <verify>
booty memory query --help 2>/dev/null
# With repo + pr (or sha) in a repo with memory enabled:
booty memory query --repo owner/repo --pr 1 --json 2>/dev/null || true
  </verify>
  <done>booty memory query --pr and --sha work; --json supported per MEM-28</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for memory CLI</name>
  <files>tests/test_memory_cli.py</files>
  <action>
Create tests/test_memory_cli.py:

1. Test memory status:
   - With no .booty.yml / missing memory block: status prints "Memory disabled"
   - With memory enabled in config: status prints enabled, records, retention_days (mock or temp state dir)
   - Use Click's CliRunner for invoking `booty memory status` and `booty memory query`

2. Test memory query:
   - --pr and --sha mutual exclusivity: invoking with both or neither raises
   - With --repo required when not in git repo
   - Output format (human vs --json) — can mock GitHub API or use fixtures

3. Follow existing test patterns in tests/ (e.g. test_memory_lookup.py, test_memory_surfacing.py)
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -m pytest tests/test_memory_cli.py -v 2>/dev/null
  </verify>
  <done>test_memory_cli.py exists; pytest passes</done>
</task>

</tasks>

<verification>
- booty memory status shows enabled, records, retention_days
- booty memory query --pr N and --sha SHA work with GITHUB_TOKEN
- booty memory query --json outputs valid JSON
- Memory disabled exits cleanly
</verification>

<success_criteria>
- MEM-27: booty memory status implemented
- MEM-28: booty memory query --pr/--sha with --json
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-cli/26-01-SUMMARY.md`
</output>
