---
phase: 42-event-router
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/router/__init__.py
  - src/booty/router/events.py
  - src/booty/router/normalizer.py
autonomous: true

must_haves:
  truths:
    - IssueEvent, PREvent, WorkflowRunEvent structs carry action, routing fields, raw_payload
    - normalizer converts GitHub payloads to internal events before routing
    - Router events are observable (operator can see normalized events)
  artifacts:
    - path: src/booty/router/events.py
      provides: Internal event structs for routing
      min_lines: 60
    - path: src/booty/router/normalizer.py
      provides: GitHub → internal event conversion
      min_lines: 80
  key_links:
    - from: src/booty/router/normalizer.py
      to: src/booty/router/events.py
      via: normalize_* functions returning typed events
      pattern: IssueEvent|PREvent|WorkflowRunEvent
---

<objective>
Create internal event structs and normalizer. ROUTE-01: extracted normalization layer before enqueue.

Purpose: Typed internal events with routing fields + raw_payload; single entry point for GitHub → internal conversion.
Output: src/booty/router/events.py, src/booty/router/normalizer.py
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-event-router/42-CONTEXT.md
@.planning/phases/42-event-router/42-RESEARCH.md
@src/booty/webhooks.py
</context>

<tasks>

<task type="auto">
  <name>Create router/events.py</name>
  <files>src/booty/router/events.py</files>
  <action>
Create src/booty/router/events.py with typed internal event structs:

1. Base: shared fields — action (str), delivery_id (str | None), sender (str | None)

2. IssueEvent: owner, repo_name, full_name, issue_number, labels, repo_url, raw_payload (dict)
   - Used for issues.labeled, issues.opened → planner | builder

3. PREvent: owner, repo_name, full_name, pr_number, head_sha, head_ref, repo_url, installation_id, labels, is_agent_pr, raw_payload (dict)
   - Used for pull_request opened/synchronize/reopened → reviewer | verifier | security

4. WorkflowRunEvent: full_name, workflow_run_id, workflow_name, workflow_path, head_sha, head_branch, conclusion, raw_payload (dict)
   - Used for workflow_run completed → governor.evaluate | governor.observe_deploy

Use dataclass for type safety. Keep raw_payload for agent-specific parsing.
</action>
  <verify>python -c "from booty.router.events import IssueEvent, PREvent, WorkflowRunEvent; print('ok')"</verify>
  <done>events.py exists; IssueEvent, PREvent, WorkflowRunEvent importable</done>
</task>

<task type="auto">
  <name>Create router/normalizer.py</name>
  <files>src/booty/router/normalizer.py</files>
  <action>
Create src/booty/router/normalizer.py:

1. normalize_issue_event(payload: dict, delivery_id: str | None) -> IssueEvent | None
   - Extract owner, repo_name, full_name, issue_number, labels from payload
   - Return None if missing required fields
   - action from payload.action; repo_url from repository.html_url

2. normalize_pr_event(payload: dict, delivery_id: str | None) -> PREvent | None
   - Extract from pull_request, repository
   - is_agent_pr: TRIGGER_LABEL in labels OR user.type==Bot OR head_ref.startswith("agent/issue-")
   - Requires settings for TRIGGER_LABEL — pass as arg or get_settings()

3. normalize_workflow_run_event(payload: dict, delivery_id: str | None) -> WorkflowRunEvent | None
   - Extract workflow_run fields: id, name, path, head_sha, head_branch, conclusion

4. Public: normalize(event_type: str, payload: dict, delivery_id: str | None) -> IssueEvent | PREvent | WorkflowRunEvent | None
   - Dispatch by event_type; return None for unsupported types
</action>
  <verify>python -c "from booty.router.normalizer import normalize; e = normalize('issues', {'action':'opened','issue':{'number':1,'labels':[]},'repository':{'owner':{'login':'o'},'name':'r','full_name':'o/r','html_url':'x'}}, 'd1'); assert e is not None and hasattr(e, 'issue_number'); print('ok')"</verify>
  <done>normalizer converts issues, pull_request, workflow_run to internal events</done>
</task>

<task type="auto">
  <name>Router package init</name>
  <files>src/booty/router/__init__.py</files>
  <action>
Create src/booty/router/__init__.py exporting:
- IssueEvent, PREvent, WorkflowRunEvent from .events
- normalize, normalize_issue_event, normalize_pr_event, normalize_workflow_run_event from .normalizer
</action>
  <verify>python -c "from booty.router import normalize, IssueEvent; print('ok')"</verify>
  <done>router package importable</done>
</task>

</tasks>

<verification>
- ROUTE-01: Normalization layer exists; internal events typed
- Events carry routing fields + raw_payload
</verification>

<success_criteria>
- router/events.py with IssueEvent, PREvent, WorkflowRunEvent
- router/normalizer.py with normalize() dispatching by event_type
- router package exports events and normalizer
</success_criteria>

<output>
After completion, create .planning/phases/42-event-router/42-01-SUMMARY.md
</output>
