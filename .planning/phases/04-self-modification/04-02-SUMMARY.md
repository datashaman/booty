---
phase: 04-self-modification
plan: 02
subsystem: quality-and-github
tags: [ruff, quality-gates, github-api, pull-requests, code-review]

dependencies:
  requires:
    - 02-03-SUMMARY.md  # PR creation foundation
    - 03-01-SUMMARY.md  # Test execution patterns
  provides:
    - Quality gate runner for ruff formatting and linting checks
    - Enhanced PR creation with label and reviewer support
    - Self-modification PR body with safety summary
    - Rejection comment for disabled self-modification
  affects:
    - 04-03-SUMMARY.md  # Will use quality checks in self-mod workflow

tech-stack:
  added:
    - ruff: Code formatter and linter (quality gate checks)
  patterns:
    - Graceful degradation when optional tools missing (ruff availability check)
    - Label creation on-demand (create if 404 during add)
    - Non-blocking reviewer requests (log warning on failure, don't fail)
    - Safety-first PR body structure (safety summary at top)

key-files:
  created:
    - src/booty/test_runner/quality.py: Quality check runner
  modified:
    - src/booty/github/pulls.py: Added label/reviewer support, safety PR body
    - src/booty/github/comments.py: Added self-modification disabled comment

decisions:
  - slug: graceful-ruff-skip
    what: Skip quality checks gracefully when ruff not installed
    why: Quality checks are enhancement for self-modification, not blocker for regular builds
    how: Check "which ruff" first, return success if not found
    alternatives: Require ruff installation (too strict for non-self-mod scenarios)

  - slug: label-create-on-demand
    what: Create "self-modification" label automatically if doesn't exist
    why: First self-mod PR should work without manual label setup
    how: Catch 404 GithubException, create label with color ff6b6b, retry add
    alternatives: Require manual label creation (worse DX)

  - slug: non-blocking-reviewer
    what: Log warning but don't fail if reviewer request fails
    why: Invalid username shouldn't block PR creation (user can add manually)
    how: Try/except around create_review_request, log warning on failure
    alternatives: Fail on invalid reviewer (too strict, breaks self-mod flow)

  - slug: safety-summary-first
    what: Put safety summary at top of self-mod PR body
    why: Most critical info for human reviewer - what changed, what's protected
    how: Format safety section with file count, changed files list, protected paths, then standard PR body
    alternatives: Put at bottom (less visible, defeats purpose)

metrics:
  duration: 2 minutes
  completed: 2026-02-14
---

# Phase 04 Plan 02: Quality Gate Runner and PR Enhancements Summary

**One-liner:** Ruff-based quality gate runner with graceful skip, enhanced PR creation with self-modification label/reviewer/safety-summary, and rejection comment.

## What Was Built

### Quality Gate Runner (src/booty/test_runner/quality.py)

Created async quality check runner that:
- Checks ruff availability via `which ruff` subprocess
- Runs `ruff format --check .` for formatting validation
- Runs `ruff check .` for linting validation
- Returns `QualityCheckResult` with passed/formatting_ok/linting_ok/errors
- Gracefully skips all checks if ruff not installed (returns success)
- Uses `errors='replace'` for robust UTF-8 decoding
- Structured logging at each step (availability, format check, lint check, result)

Pattern follows existing `src/booty/test_runner/executor.py` subprocess handling.

### Enhanced PR Creation (src/booty/github/pulls.py)

Added `add_self_modification_metadata`:
- Adds "self-modification" label to PR
- Creates label automatically if doesn't exist (catches 404, creates with color ff6b6b)
- Requests review from specified username
- Gracefully handles invalid reviewer (logs warning, doesn't fail)

Added `format_self_modification_pr_body`:
- Safety summary section at top showing:
  - File change count
  - List of changed files (max 10, with "and N more" if overflow)
  - Protected paths that were verified
  - Confirmation no protected paths modified
- Standard PR body below (approach, changes table, testing notes, issue reference)
- Footer notes "Generated by Booty (self-modification)"

### Self-Modification Rejection Comment (src/booty/github/comments.py)

Added `post_self_modification_disabled_comment`:
- Posts clear explanation that self-modification detected but disabled
- Tells user to set `BOOTY_SELF_MODIFY_ENABLED=true`
- Explains self-modification requires explicit opt-in
- Notes draft PR requirement for human review

## Deviations from Plan

None - plan executed exactly as written.

## Decisions Made

**1. Graceful ruff skip**
- Quality checks return success when ruff not installed
- Prevents blocking regular builds that don't need quality gates
- Self-modification will check ruff availability separately before using

**2. Label creation on-demand**
- First self-mod PR creates "self-modification" label automatically
- Better DX than requiring manual setup
- Uses 404 detection + retry pattern

**3. Non-blocking reviewer requests**
- Invalid username logs warning but doesn't fail PR creation
- User can add reviewer manually if needed
- Prevents self-mod flow breakage from config issues

**4. Safety summary first**
- Most critical info at top of PR body for immediate visibility
- Human reviewer sees file changes + protected path verification first
- Standard PR details below for full context

## Testing

**Import verification:**
```bash
python -c "from booty.test_runner.quality import run_quality_checks; from booty.github.pulls import add_self_modification_metadata, format_self_modification_pr_body; from booty.github.comments import post_self_modification_disabled_comment; print('All imports OK')"
```

**QualityCheckResult verification:**
```bash
python -c "from booty.test_runner.quality import QualityCheckResult; r = QualityCheckResult(passed=True, formatting_ok=True, linting_ok=True, errors=[]); print(r.passed)"
# Output: True
```

**Safety summary verification:**
```bash
python -c "from booty.github.pulls import format_self_modification_pr_body; body = format_self_modification_pr_body('approach', [], 'notes', 1, ['.env'], ['src/foo.py']); print('Safety Summary' in body)"
# Output: True
```

All imports work correctly. No circular dependencies.

## Commits

| Commit | Message | Files |
|--------|---------|-------|
| 36de867 | feat(04-02): create quality gate runner for ruff checks | src/booty/test_runner/quality.py |
| 8e34baf | feat(04-02): enhance PR creation and add self-modification comment | src/booty/github/pulls.py, src/booty/github/comments.py |

## Integration Points

**Upstream dependencies:**
- `src/booty/test_runner/executor.py` - Subprocess pattern reference
- `src/booty/github/pulls.py` - Base PR creation
- `src/booty/github/comments.py` - Comment posting infrastructure

**Downstream consumers:**
- Plan 04-03 will integrate quality checks into self-modification workflow
- Self-modification PRs will use enhanced metadata and safety body
- Disabled self-mod detection will post rejection comment

## Next Phase Readiness

**Phase 04 Plan 03 can proceed:**
- Quality gate runner ready for integration
- PR enhancement supports self-mod label, reviewer, safety summary
- Rejection comment ready for disabled scenarios

**No blockers identified.**

## Technical Notes

**Subprocess handling:**
- Follows established pattern from executor.py
- Uses `asyncio.create_subprocess_shell` for async execution
- Decodes with `errors='replace'` for robustness

**GitHub API patterns:**
- On-demand label creation prevents setup friction
- Non-blocking reviewer requests prevent config issues from blocking flow
- PyGithub GithubException handling for 404 detection

**Safety-first design:**
- Safety summary prominently placed at top of PR body
- Clear confirmation of protected path verification
- File change visibility for quick human review

## Success Criteria Met

- [x] Quality gate runner executes ruff checks and handles missing ruff gracefully
- [x] PR creation supports adding self-modification label and requesting reviewer
- [x] PR body includes safety summary for self-modification PRs
- [x] Issue comment posted when self-modification is detected but disabled
- [x] All imports work without circular dependencies
- [x] QualityCheckResult properly tracks formatting and linting results

**Plan 04-02 complete.**
