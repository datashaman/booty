---
phase: 04-self-modification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/test_runner/quality.py
  - src/booty/github/pulls.py
  - src/booty/github/comments.py
autonomous: true

must_haves:
  truths:
    - "Quality checks run ruff format --check and ruff check, returning structured results"
    - "Quality checks skip gracefully if ruff is not installed"
    - "PR creation supports adding labels and requesting reviewers for self-modification PRs"
    - "Self-modification PRs include safety summary showing changed files and verified protected paths"
    - "Issue comments can explain when self-modification is rejected (disabled)"
  artifacts:
    - path: "src/booty/test_runner/quality.py"
      provides: "QualityCheckResult dataclass and run_quality_checks async function"
      contains: "async def run_quality_checks"
    - path: "src/booty/github/pulls.py"
      provides: "Enhanced create_pull_request with label/reviewer support, format_self_modification_pr_body"
      contains: "def format_self_modification_pr_body"
    - path: "src/booty/github/comments.py"
      provides: "post_self_modification_disabled_comment function"
      contains: "def post_self_modification_disabled_comment"
  key_links:
    - from: "src/booty/test_runner/quality.py"
      to: "asyncio.create_subprocess_shell"
      via: "Subprocess execution for ruff commands"
      pattern: "create_subprocess_shell"
    - from: "src/booty/github/pulls.py"
      to: "PyGithub"
      via: "PR labels and review requests"
      pattern: "add_to_labels|create_review_request"
---

<objective>
Create quality gate runner (ruff checks) and enhance GitHub PR/comment modules for self-modification: label adding, reviewer requesting, safety summary in PR body, and rejection comment posting.

Purpose: Self-modification PRs need stricter quality gates (linting + formatting) and enhanced GitHub interactions (draft PR with label, reviewer, safety summary) to ensure human oversight.
Output: Quality check module, enhanced PR creation, self-modification rejection comment.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-self-modification/04-RESEARCH.md
@.planning/phases/04-self-modification/04-CONTEXT.md

@src/booty/github/pulls.py
@src/booty/github/comments.py
@src/booty/test_runner/executor.py
@src/booty/logging.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quality gate runner for ruff checks</name>
  <files>src/booty/test_runner/quality.py</files>
  <action>
    Create `src/booty/test_runner/quality.py` with:

    1. `QualityCheckResult` dataclass with fields:
       - `passed: bool` — overall pass/fail
       - `formatting_ok: bool` — ruff format check result
       - `linting_ok: bool` — ruff check result
       - `errors: list[str]` — collected error messages

    2. `async def run_quality_checks(workspace_path: Path) -> QualityCheckResult`:
       - First checks if ruff is available via `which ruff` subprocess. If not installed, log warning and return `QualityCheckResult(passed=True, formatting_ok=True, linting_ok=True, errors=[])` — skip gracefully.
       - Runs `ruff format --check .` via `asyncio.create_subprocess_shell()` with `cwd=str(workspace_path)`. Captures stdout/stderr. If returncode != 0, record error.
       - Runs `ruff check .` via same pattern. If returncode != 0, record error.
       - Returns `QualityCheckResult` with combined results.
       - Decode output with `errors='replace'` for robustness.
       - Log at each step: checking availability, running format check, running lint check, final result.

    Follow existing pattern from `src/booty/test_runner/executor.py` for subprocess handling. Use structlog logger from `booty.logging`.
  </action>
  <verify>
    - `python -c "from booty.test_runner.quality import QualityCheckResult, run_quality_checks; print('OK')"` succeeds
    - `python -c "from booty.test_runner.quality import QualityCheckResult; r = QualityCheckResult(passed=True, formatting_ok=True, linting_ok=True, errors=[]); print(r.passed)"` prints `True`
  </verify>
  <done>run_quality_checks executes ruff format --check and ruff check, returns structured QualityCheckResult, skips gracefully when ruff not installed</done>
</task>

<task type="auto">
  <name>Task 2: Enhance GitHub PR creation and add self-modification comment</name>
  <files>src/booty/github/pulls.py, src/booty/github/comments.py</files>
  <action>
    1. In `src/booty/github/pulls.py`, add a new function `add_self_modification_metadata`:
       - `def add_self_modification_metadata(github_token: str, repo_url: str, pr_number: int, reviewer_username: str) -> None`:
         - Gets the repo and PR objects via PyGithub
         - Adds "self-modification" label to PR. Use try/except: if label doesn't exist (GithubException with status 404 or similar), create the label first with `repo.create_label("self-modification", "ff6b6b", "Self-modification PR requiring manual review")` then retry `pr.add_to_labels()`.
         - Requests review from `reviewer_username` if not empty. Use try/except to handle invalid usernames gracefully (log warning, don't fail).
         - Log each action.

    2. In `src/booty/github/pulls.py`, add `format_self_modification_pr_body`:
       - `def format_self_modification_pr_body(approach: str, file_changes: list[dict], testing_notes: str, issue_number: int, protected_paths_checked: list[str], changed_files: list[str]) -> str`:
         - Generates PR body with safety summary section at the top showing: file count, list of changed files (max 10 shown), protected paths verified, confirmation no protected paths were modified
         - Below safety summary, includes standard PR body (approach, changes table, testing notes, issue reference)
         - Footer notes "Generated by Booty (self-modification)"
         - Do NOT use emojis in the output

    3. In `src/booty/github/comments.py`, add `post_self_modification_disabled_comment`:
       - `def post_self_modification_disabled_comment(github_token: str, repo_url: str, issue_number: int) -> None`:
         - Posts comment explaining self-modification is not enabled
         - Message: "Self-modification disabled — This issue was labeled for processing, but self-modification is not enabled for this Booty instance. Set BOOTY_SELF_MODIFY_ENABLED=true to allow Booty to process issues against its own repository. Self-modification requires explicit opt-in and will always create draft PRs requiring human review."
         - Uses existing `_get_repo` helper
         - Logs success/failure

    Import `GithubException` in pulls.py (already imported). Use structlog logger from `booty.logging`.
  </action>
  <verify>
    - `python -c "from booty.github.pulls import add_self_modification_metadata, format_self_modification_pr_body; print('OK')"` succeeds
    - `python -c "from booty.github.comments import post_self_modification_disabled_comment; print('OK')"` succeeds
    - `python -c "from booty.github.pulls import format_self_modification_pr_body; body = format_self_modification_pr_body('approach', [], 'notes', 1, ['.env'], ['src/foo.py']); print('Safety Summary' in body)"` prints `True`
  </verify>
  <done>add_self_modification_metadata adds label and reviewer to self-PRs; format_self_modification_pr_body includes safety summary; post_self_modification_disabled_comment explains rejection</done>
</task>

</tasks>

<verification>
- All imports work: `python -c "from booty.test_runner.quality import run_quality_checks; from booty.github.pulls import add_self_modification_metadata, format_self_modification_pr_body; from booty.github.comments import post_self_modification_disabled_comment; print('All imports OK')"`
- QualityCheckResult properly tracks formatting and linting results
- PR body includes safety summary section with changed files and protected paths
- Self-modification disabled comment clearly explains the situation and how to enable
- No circular imports
</verification>

<success_criteria>
- Quality gate runner executes ruff checks and handles missing ruff gracefully
- PR creation supports adding self-modification label and requesting reviewer
- PR body includes safety summary for self-modification PRs
- Issue comment posted when self-modification is detected but disabled
</success_criteria>

<output>
After completion, create `.planning/phases/04-self-modification/04-02-SUMMARY.md`
</output>
