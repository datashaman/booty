---
phase: 04-self-modification
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/booty/jobs.py
  - src/booty/webhooks.py
  - src/booty/code_gen/generator.py
  - src/booty/main.py
autonomous: true

must_haves:
  truths:
    - "Webhook handler detects self-modification and rejects with comment when disabled"
    - "Webhook handler passes self-modification flag to job when enabled"
    - "Pipeline validates changes against protected paths for self-modification jobs"
    - "Pipeline runs quality checks (ruff) for self-modification jobs before creating PR"
    - "Self-modification PRs are always draft with label and reviewer, regardless of test results"
    - "Standard (non-self) jobs continue working exactly as before"
  artifacts:
    - path: "src/booty/webhooks.py"
      provides: "Self-modification detection in webhook handler"
      contains: "is_self_modification"
    - path: "src/booty/code_gen/generator.py"
      provides: "Self-modification pipeline extensions (protected paths, quality checks, draft PR)"
      contains: "run_quality_checks"
    - path: "src/booty/main.py"
      provides: "Self-modification comment posting on disabled rejection"
      contains: "post_self_modification_disabled_comment"
  key_links:
    - from: "src/booty/webhooks.py"
      to: "src/booty/self_modification/detector.py"
      via: "is_self_modification call in webhook handler"
      pattern: "is_self_modification"
    - from: "src/booty/code_gen/generator.py"
      to: "src/booty/self_modification/safety.py"
      via: "validate_changes_against_protected_paths before file writes"
      pattern: "validate_changes_against_protected_paths"
    - from: "src/booty/code_gen/generator.py"
      to: "src/booty/test_runner/quality.py"
      via: "run_quality_checks after test refinement for self-modification"
      pattern: "run_quality_checks"
    - from: "src/booty/code_gen/generator.py"
      to: "src/booty/github/pulls.py"
      via: "add_self_modification_metadata after PR creation"
      pattern: "add_self_modification_metadata"
---

<objective>
Wire self-modification detection into the webhook handler and pipeline: detect self-targeting in webhooks, add protected path validation and quality checks to the pipeline, create self-modification PRs as draft with label/reviewer.

Purpose: This is the integration plan that connects all Phase 4 components into the existing pipeline, making self-modification actually work end-to-end while keeping non-self jobs unchanged.
Output: Modified webhooks.py, generator.py, and main.py with self-modification pipeline flow.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-self-modification/04-RESEARCH.md
@.planning/phases/04-self-modification/04-CONTEXT.md
@.planning/phases/04-self-modification/04-01-SUMMARY.md
@.planning/phases/04-self-modification/04-02-SUMMARY.md

@src/booty/webhooks.py
@src/booty/code_gen/generator.py
@src/booty/main.py
@src/booty/jobs.py
@src/booty/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add self-modification detection to webhook handler and Job</name>
  <files>src/booty/jobs.py, src/booty/webhooks.py</files>
  <action>
    1. Extend `Job` dataclass in `src/booty/jobs.py`:
       - Add `is_self_modification: bool = False` field
       - Add `repo_url: str = ""` field — stores the webhook payload's repository URL for use in pipeline (currently the pipeline uses settings.TARGET_REPO_URL, but for self-modification the repo URL comes from the webhook payload)

    2. Modify webhook handler in `src/booty/webhooks.py`:
       - Import `is_self_modification` from `booty.self_modification.detector`
       - After payload parsing and label filtering (after line ~100, before job creation), add self-modification detection:
         - Extract `repo_url = payload.get("repository", {}).get("html_url", "")`
         - Call `is_self = is_self_modification(repo_url, settings.BOOTY_OWN_REPO_URL)`
         - If `is_self` and NOT `settings.BOOTY_SELF_MODIFY_ENABLED`:
           - Log `"self_modification_rejected"` with issue_number
           - Return `{"status": "ignored", "reason": "self_modification_disabled", "issue_number": issue["number"]}`
           - Note: the comment posting happens in main.py's process_job, NOT here — keep webhook handler fast
         - Wait, actually per CONTEXT.md: "When self-modification is detected but disabled: log the rejection internally AND comment on the issue". But webhook handler must return fast. Instead:
           - If `is_self` and NOT enabled: still create and enqueue the job with `is_self_modification=True` but mark it for rejection. Actually, simpler approach: post the comment asynchronously and return ignored. Import `post_self_modification_disabled_comment` and call it in a fire-and-forget manner. But that adds GitHub import to webhooks.
           - Simplest correct approach: Return `{"status": "ignored", "reason": "self_modification_disabled", "issue_number": issue["number"]}` from the webhook. The comment posting will be handled separately — add a `background_tasks` parameter or just accept the tradeoff that the comment won't be posted from the webhook handler. Actually, use FastAPI's `BackgroundTasks`:
             - Add `background_tasks: BackgroundTasks` parameter to `github_webhook`
             - When self-modification is detected but disabled, add `background_tasks.add_task(post_self_modification_disabled_comment, settings.GITHUB_TOKEN, settings.TARGET_REPO_URL, issue["number"])` before returning
             - Import `BackgroundTasks` from `fastapi`
       - When creating Job, set `is_self_modification=is_self` and `repo_url=repo_url`

    Keep the webhook handler fast — no blocking GitHub API calls in the request path.
  </action>
  <verify>
    - `python -c "from booty.jobs import Job; j = Job(job_id='1', issue_url='u', issue_number=1, payload={}); print(j.is_self_modification, j.repo_url)"` prints `False `
    - `python -c "from booty.webhooks import router; print('OK')"` succeeds (no import errors)
  </verify>
  <done>Job carries is_self_modification flag; webhook handler detects self-modification, rejects with background comment when disabled, passes flag when enabled</done>
</task>

<task type="auto">
  <name>Task 2: Wire self-modification safety and quality gates into pipeline</name>
  <files>src/booty/code_gen/generator.py, src/booty/main.py</files>
  <action>
    1. Modify `process_issue_to_pr` in `src/booty/code_gen/generator.py`:
       - Add `is_self_modification: bool = False` parameter (default False for backward compatibility)
       - Import `validate_changes_against_protected_paths` from `booty.self_modification.safety`
       - Import `run_quality_checks` from `booty.test_runner.quality`
       - Import `add_self_modification_metadata` and `format_self_modification_pr_body` from `booty.github.pulls`

       After Step 4 (path security check), add Step 4b for self-modification:
       - If `is_self_modification`:
         - Call `validate_changes_against_protected_paths(changes_dicts, workspace_path)` where changes_dicts are built from analysis paths
         - Actually, at this point we have `all_paths` list. Build changes list as `[{"path": p} for p in all_paths]`
         - If validation fails (returns False), raise `ValueError(f"Self-modification blocked: {reason}")`
         - Log "protected_paths_validated" on success

       After Step 10 (refinement loop), add Step 10b for self-modification quality checks:
       - If `is_self_modification`:
         - Call `quality_result = await run_quality_checks(workspace_path)`
         - Log quality check results
         - If quality checks fail, append quality errors to error_message and set tests_passed to False
         - This means self-modification PRs that fail quality checks become draft PRs (same as test failures)

       In Step 13 (PR creation):
       - If `is_self_modification`:
         - Load booty config to get protected_paths list
         - Use `format_self_modification_pr_body()` instead of `format_pr_body()` for the PR body
         - Force `draft=True` regardless of test results (self-PRs are always draft)
         - After `create_pull_request()`, call `add_self_modification_metadata()` with reviewer from settings

       Non-self-modification jobs must remain completely unchanged — all self-modification logic is gated behind `if is_self_modification:` checks.

    2. Modify `process_job` in `src/booty/main.py`:
       - Pass `is_self_modification=job.is_self_modification` to `process_issue_to_pr()`
       - No other changes needed — the pipeline handles everything else
  </action>
  <verify>
    - `python -c "from booty.code_gen.generator import process_issue_to_pr; import inspect; sig = inspect.signature(process_issue_to_pr); print('is_self_modification' in sig.parameters)"` prints `True`
    - `python -c "from booty.main import process_job; print('OK')"` succeeds (no import errors)
    - `python -c "from booty.code_gen.generator import process_issue_to_pr; print('OK')"` succeeds (no import errors)
  </verify>
  <done>Pipeline validates protected paths and runs quality checks for self-modification jobs; self-PRs always created as draft with label/reviewer; non-self jobs unchanged</done>
</task>

</tasks>

<verification>
- All imports work without errors across modified files
- Job dataclass has is_self_modification and repo_url fields
- Webhook handler detects self-modification and rejects when disabled (with background comment)
- Pipeline path: webhook detects -> job carries flag -> pipeline validates protected paths -> runs quality checks -> creates draft PR with label/reviewer
- Non-self-modification flow is completely unchanged (backward compatible)
- Self-modification PRs always draft, always have label, always request reviewer
</verification>

<success_criteria>
- End-to-end self-modification flow works: webhook detection -> protected path validation -> quality checks -> draft PR with label and reviewer
- Self-modification rejection posts explanatory comment on issue
- Standard pipeline unaffected — all self-modification logic behind conditional checks
- Self-PRs are always draft regardless of test results
</success_criteria>

<output>
After completion, create `.planning/phases/04-self-modification/04-03-SUMMARY.md`
</output>
