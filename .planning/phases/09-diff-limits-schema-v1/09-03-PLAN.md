---
phase: 09-diff-limits-schema-v1
plan: 03
type: execute
wave: 2
depends_on: ["01", "02"]
files_modified:
  - src/booty/verifier/runner.py
autonomous: true

must_haves:
  truths:
    - "For agent PRs: schema validation and diff limits run BEFORE clone (fail fast)"
    - "Invalid .booty.yml or limit violation → check failure with formatted output"
    - "Order: 1) Schema (blocking), 2) Safety limits — then clone and run tests"
    - "Non-agent PRs skip limits; schema validation still applies after clone"
  artifacts:
    - path: src/booty/verifier/runner.py
      provides: early validation + limits for agent PRs
      contains: "get_verifier_repo|load_booty_config_from_content|check_diff_limits"
  key_links:
    - from: verifier/runner.py
      to: github/checks.py
      via: get_verifier_repo for PR + .booty.yml fetch
      pattern: get_verifier_repo
    - from: verifier/runner.py
      to: verifier/limits.py
      via: get_pr_diff_stats, check_diff_limits
      pattern: get_pr_diff_stats|check_diff_limits
---

<objective>
Wire schema validation and diff limits into process_verifier_job. For agent PRs: fetch .booty.yml via API, validate schema, check limits before clone. Fail check with formatted output on violation.

Purpose: VERIFY-06 through VERIFY-10 — full Phase 9 integration.
Output: Runner with early validation path; schema and limit failures block check.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-diff-limits-schema-v1/09-RESEARCH.md
@.planning/phases/09-diff-limits-schema-v1/09-CONTEXT.md
@src/booty/verifier/runner.py
@src/booty/github/checks.py
@src/booty/verifier/limits.py
@src/booty/test_runner/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch .booty.yml and validate schema before clone (agent PRs)</name>
  <files>src/booty/verifier/runner.py</files>
  <action>
Add early validation path in process_verifier_job for agent PRs:

1. After create_check_run(queued), before prepare_verification_workspace:
   - If not job.is_agent_pr: skip to clone (existing flow)
   - If job.is_agent_pr:
     a. repo = get_verifier_repo(job.owner, job.repo_name, job.installation_id, settings)
     b. If repo is None: continue to clone (verifier disabled case already handled)
     c. Try: fc = repo.get_contents(".booty.yml", ref=job.head_sha)
        - github.UnknownObjectException: no .booty.yml, use defaults (LimitsConfig with defaults; config = BootyConfig(test_command="echo 'No tests configured'") for later)
        - Else: content = fc.decoded_content.decode()
     d. load_booty_config_from_content(content) — may raise ValidationError
     e. If ValidationError: edit_check_run(conclusion="failure", output with title "Schema validation failed", summary with error message, details with full error). Return (no clone).
     f. Store config for limits extraction

2. Extract LimitsConfig from config: if has max_files_changed/max_diff_loc/max_loc_per_file use them, else defaults. Need helper limits_config_from_booty_config(config).
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.verifier.runner import process_verifier_job
import inspect
source = inspect.getsource(process_verifier_job)
assert 'get_verifier_repo' in source or 'get_contents' in source
assert 'load_booty_config_from_content' in source
print('OK: early validation path')
"
  </verify>
  <done>Agent PR path fetches and validates .booty.yml before clone.</done>
</task>

<task type="auto">
  <name>Task 2: Check diff limits before clone (agent PRs)</name>
  <files>src/booty/verifier/runner.py</files>
  <action>
Add diff limits check after schema validation:

1. If job.is_agent_pr and repo is not None (from Task 1):
   - pr = repo.get_pull(job.pr_number)
   - stats = get_pr_diff_stats(repo, job.pr_number)
   - limits = limits_config_from_booty_config(config)  # or LimitsConfig() if no config
   - failures = check_diff_limits(stats, limits)
   - If failures:
     - output_text = format_limit_failures(failures)
     - edit_check_run(check_run, status="completed", conclusion="failure", output={"title": "Diff limits exceeded", "summary": output_text[:65535]})
     - Return (no clone)

2. Add limits_config_from_booty_config in limits.py or runner: extracts LimitsConfig from BootyConfig/BootyConfigV1. If config has max_files_changed etc use; else default LimitsConfig().
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.verifier.runner import process_verifier_job
import inspect
source = inspect.getsource(process_verifier_job)
assert 'check_diff_limits' in source or 'get_pr_diff_stats' in source
print('OK: limits check in runner')
"
  </verify>
  <done>Diff limits checked before clone; violations fail check.</done>
</task>

<task type="auto">
  <name>Task 3: Schema validation for non-agent PRs (after clone)</name>
  <files>src/booty/verifier/runner.py</files>
  <action>
Ensure schema validation applies to all PRs when loading config:

1. Existing flow: load_booty_config(Path(workspace.path)) after clone
2. load_booty_config must use same v0/v1 logic as load_booty_config_from_content
3. If .booty.yml exists with schema_version 1 and has unknown keys: load_booty_config will raise ValidationError
4. Wrap load_booty_config in try/except: on ValidationError, edit_check_run failure with schema error, return
5. This ensures both agent PRs (early path) and non-agent PRs (clone path) get schema validation
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
# load_booty_config should validate schema when loading from path
from booty.test_runner.config import load_booty_config
from pathlib import Path
import tempfile
with tempfile.TemporaryDirectory() as d:
    p = Path(d) / '.booty.yml'
    p.write_text('schema_version: 1\\ntest_command: pytest\\nbad_key: x')
    try:
        load_booty_config(Path(d))
        assert False, 'Should raise'
    except Exception:
        pass
print('OK: load_booty_config validates schema')
"
  </verify>
  <done>Schema validation on load_booty_config for clone path.</done>
</task>

</tasks>

<verification>
- Agent PRs: schema + limits before clone
- Schema failure or limit failure: check fails, no clone
- Non-agent PRs: limits skipped; schema validated on load
- Output format: FAILED/Observed/Limit/Fix for limit failures
</verification>

<success_criteria>
- [ ] Early validation for agent PRs (no clone on fail)
- [ ] Schema validation blocks invalid .booty.yml
- [ ] Diff limits block oversized agent PRs
- [ ] Check output uses formatted failure messages
</success_criteria>

<output>
After completion, create `.planning/phases/09-diff-limits-schema-v1/09-03-SUMMARY.md`
</output>
