---
phase: 09-diff-limits-schema-v1
plan: 02
type: execute
wave: 1
depends_on: ["01"]
files_modified:
  - src/booty/verifier/limits.py
autonomous: true

must_haves:
  truths:
    - "get_pr_diff_stats fetches files_changed, additions, deletions, per-file stats from PyGithub PR"
    - "check_diff_limits enforces max_files_changed, max_diff_loc, max_loc_per_file"
    - "Limit failures use format: FAILED / Observed / Limit / Fix"
    - "max_loc_per_file uses pathspec for scope (default exclude tests/)"
  artifacts:
    - path: src/booty/verifier/limits.py
      provides: get_pr_diff_stats, check_diff_limits, format_limit_failures, limits_config_from_booty_config
      contains: "get_pr_diff_stats|check_diff_limits|format_limit_failures|limits_config_from_booty_config"
  key_links:
    - from: verifier/limits.py
      to: github/checks.py
      via: get_verifier_repo for repo access
      pattern: get_verifier_repo
---

<objective>
Create verifier/limits.py with PR diff stat fetching and limit enforcement. Used by runner before clone for agent PRs.

Purpose: VERIFY-06, VERIFY-07, VERIFY-08 — max_files_changed, max_diff_loc, max_loc_per_file.
Output: limits.py with get_pr_diff_stats, check_diff_limits, format_limit_failures.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-diff-limits-schema-v1/09-RESEARCH.md
@.planning/phases/09-diff-limits-schema-v1/09-CONTEXT.md
@src/booty/github/checks.py
@src/booty/verifier/job.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiffStats and limit check dataclasses</name>
  <files>src/booty/verifier/limits.py</files>
  <action>
Create src/booty/verifier/limits.py:

1. Dataclasses:
   - DiffStats: files_changed: int, additions: int, deletions: int, files: list[FileDiff]
   - FileDiff: filename: str, additions: int, deletions: int
   - LimitFailure: rule: str, observed: int, limit: int, fix_hint: str
   - LimitsConfig: max_files_changed: int, max_diff_loc: int, max_loc_per_file: int | None, max_loc_per_file_pathspec: list[str] | None

2. Default limits (from CONTEXT): max_files_changed=12, max_diff_loc=600, max_loc_per_file=250
3. max_loc_per_file_pathspec default: ["!tests/**"] (exclude tests) — use pathspec to match; file matches if NOT in exclusion
   - Actually: "scope: everywhere except tests/" means we CHECK max_loc_per_file for files that match the inclusion
   - Simpler: pathspec defines which paths ARE subject to limit. Default: all except tests = ["**/*"] with exclusion of tests.
   - pathspec: use gitignore. "!tests/**" means exclude tests. So patterns that INCLUDE files to check: we want "all except tests". Use two patterns: include "**" and exclude "tests/**". Pathspec can do "!tests/**" as negation in gitignore style. Check pathspec docs.
   - Per CONTEXT: "pathspec defining where it applies" — single global max_loc_per_file with optional pathspec. Default scope: everywhere except tests/. So we need: match_file = True for files we check. "Everywhere except tests" = not matches("tests/**"). Use pathspec with patterns ["tests/**"] as EXCLUDE: if file matches exclude, skip; else check. So include_patterns = ["**"] and exclude_patterns = ["tests/**"] or use single "!tests/**" if supported.
   - pathspec.PathSpec: "tests/" would match tests dir. "!tests/**" in gitignore means "don't ignore" (include). For "apply limit to everywhere except tests": we need "match_file(path) returns True for src/foo.py, False for tests/bar.py". Use from_lines with ["*", "!tests/**"] or equivalent. Simpler: use one PathSpec with exclude pattern; we check files that do NOT match. So: scope_spec = PathSpec.from_lines('gitwildmatch', ["tests/**"]) — if scope_spec.match_file(path), file is EXCLUDED (in tests). So we only apply limit when not scope_spec.match_file(path).
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.verifier.limits import DiffStats, LimitFailure, LimitsConfig
# LimitsConfig with defaults
lc = LimitsConfig()
assert lc.max_files_changed == 12 and lc.max_diff_loc == 600
print('OK: limits dataclasses')
"
  </verify>
  <done>DiffStats, LimitFailure, LimitsConfig dataclasses exist.</done>
</task>

<task type="auto">
  <name>Task 2: Implement get_pr_diff_stats and check_diff_limits</name>
  <files>src/booty/verifier/limits.py</files>
  <action>
Implement get_pr_diff_stats and check_diff_limits:

1. get_pr_diff_stats(repo: Repository, pr_number: int) -> DiffStats:
   - pr = repo.get_pull(pr_number)
   - files_changed = pr.changed_files
   - additions = pr.additions
   - deletions = pr.deletions
   - files = [FileDiff(f.filename, f.additions, f.deletions) for f in pr.get_files()]
   - Return DiffStats(files_changed, additions, deletions, files)

2. check_diff_limits(stats: DiffStats, limits: LimitsConfig) -> list[LimitFailure]:
   - failures = []
   - If stats.files_changed > limits.max_files_changed: append LimitFailure("max_files_changed", stats.files_changed, limits.max_files_changed, "split PR or raise limit in .booty.yml")
   - If (stats.additions + stats.deletions) > limits.max_diff_loc: append LimitFailure("max_diff_loc", stats.additions + stats.deletions, limits.max_diff_loc, "reduce diff or raise limit in .booty.yml")
   - If limits.max_loc_per_file is not None:
     - Excluded = limits.max_loc_per_file_pathspec or ["tests/**"]
     - spec = PathSpec.from_lines('gitwildmatch', excluded)
     - For each f in stats.files: if not spec.match_file(f.filename): total = f.additions + f.deletions; if total > limits.max_loc_per_file: append LimitFailure("max_loc_per_file", total, limits.max_loc_per_file, f"{f.filename}: split or raise limit")
   - Return failures

3. LimitsConfig from BootyConfig: extract max_files_changed, max_diff_loc, max_loc_per_file, max_loc_per_file_pathspec; use defaults when None.

4. format_limit_failures(failures: list[LimitFailure]) -> str:
   - Per CONTEXT format, each failure:
     FAILED: {rule}
     Observed: {observed}
     Limit: {limit}
     Fix: {fix_hint}
   - Join with newlines between failures.

5. limits_config_from_booty_config(config: BootyConfig | BootyConfigV1) -> LimitsConfig:
   - Extract max_files_changed, max_diff_loc, max_loc_per_file, max_loc_per_file_pathspec via getattr(config, name, None)
   - Use defaults (12, 600, 250, ["tests/**"]) when None
   - Return LimitsConfig
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.verifier.limits import check_diff_limits, format_limit_failures, DiffStats, LimitsConfig, LimitFailure
stats = DiffStats(files_changed=18, additions=300, deletions=200, files=[])
limits = LimitsConfig()
failures = check_diff_limits(stats, limits)
assert len(failures) >= 1
assert any('max_files_changed' in str(f.rule) for f in failures)
s = format_limit_failures(failures)
assert 'FAILED' in s and 'Observed' in s and 'Limit' in s
print('OK: check_diff_limits and format')
"
  </verify>
  <done>get_pr_diff_stats, check_diff_limits, format_limit_failures implemented.</done>
</task>

</tasks>

<verification>
- get_pr_diff_stats returns DiffStats from PyGithub PR
- check_diff_limits returns list[LimitFailure] for violations
- format_limit_failures produces CONTEXT-specified format
- max_loc_per_file pathspec excludes tests/ by default
</verification>

<success_criteria>
- [ ] verifier/limits.py with DiffStats, check_diff_limits, format_limit_failures
- [ ] Limits use defaults; config overrides supported
- [ ] Failure format matches CONTEXT
</success_criteria>

<output>
After completion, create `.planning/phases/09-diff-limits-schema-v1/09-02-SUMMARY.md`
</output>
