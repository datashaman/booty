---
phase: 35-idempotency
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/github/comments.py
  - tests/test_github_comments.py
autonomous: true

must_haves:
  truths:
    - "get_plan_comment_body returns body of comment containing <!-- booty-plan -->"
    - "update_plan_comment_with_architect_section_if_changed updates only when booty-architect block differs"
  artifacts:
    - path: src/booty/github/comments.py
      provides: get_plan_comment_body, update_plan_comment_with_architect_section_if_changed
      min_lines: 30
  key_links:
    - from: update_plan_comment_with_architect_section_if_changed
      to: update_plan_comment_with_architect_section
      via: calls after diff check
      pattern: "update_plan_comment_with_architect_section"
---

<objective>
Add comment diff helper: get_plan_comment_body, update_plan_comment_with_architect_section_if_changed.

Purpose: ARCH-25 â€” update comment only if changed on cache hit.
Output: github/comments.py with diff-before-update; tests.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/35-idempotency/35-RESEARCH.md
@src/booty/github/comments.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add get_plan_comment_body</name>
  <files>src/booty/github/comments.py</files>
  <action>
Add get_plan_comment_body(github_token: str, repo_url: str, issue_number: int) -> str | None to github/comments.py.

Logic: Use _get_repo; issue.get_comments(); iterate (newest last if needed); find first comment containing "<!-- booty-plan -->"; return comment.body or None if not found.

Mirror the iteration used in update_plan_comment_with_architect_section. That function iterates issue.get_comments() and finds body with "<!-- booty-plan -->". Extract that into a helper or implement get_plan_comment_body to return that body. Place near update_plan_comment_with_architect_section.
</action>
  <verify>cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.github.comments import get_plan_comment_body
# Smoke test - will fail without token on real repo, but import should work
assert callable(get_plan_comment_body)
print('get_plan_comment_body OK')
"</verify>
  <done>get_plan_comment_body returns body or None</done>
</task>

<task type="auto">
  <name>Task 2: Add update_plan_comment_with_architect_section_if_changed</name>
  <files>src/booty/github/comments.py</files>
  <action>
Add update_plan_comment_with_architect_section_if_changed(
  github_token: str, repo_url: str, issue_number: int, architect_section: str
) -> bool to github/comments.py.

Logic:
1. body = get_plan_comment_body(github_token, repo_url, issue_number)
2. If not body: return False (nothing to update)
3. Extract existing: re.search(r'<!-- booty-architect -->.*?<!-- /booty-architect -->', body, re.DOTALL)
4. existing_block = match.group(0) if match else None
5. If existing_block == architect_section: return False (no update)
6. Else: call update_plan_comment_with_architect_section(...), return True
</action>
  <verify>cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.github.comments import update_plan_comment_with_architect_section_if_changed
assert callable(update_plan_comment_with_architect_section_if_changed)
print('update_plan_comment_with_architect_section_if_changed OK')
"</verify>
  <done>Function returns False when unchanged, True when updated</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for diff helper</name>
  <files>tests/test_github_comments.py</files>
  <action>
Add tests for the new functions. If tests/test_github_comments.py does not exist, create it. Use unittest.mock or pytest fixtures to mock _get_repo, issue.get_comments().

1. test_get_plan_comment_body_found: Mock issue with one comment containing <!-- booty-plan -->; assert returns that body.
2. test_get_plan_comment_body_not_found: Mock issue with no plan comment; assert returns None.
3. test_update_if_changed_skips_when_identical: Mock get_plan_comment_body to return body with existing booty-architect block; architect_section same; assert update_plan_comment_with_architect_section NOT called; function returns False.
4. test_update_if_changed_calls_when_different: Mock get_plan_comment_body returning body with different block; assert update_plan_comment_with_architect_section called; returns True.

Check existing test file patterns (e.g. tests/test_planner_cache.py) for mocking GitHub.
</action>
  <verify>cd /Users/marlinf/Projects/datashaman/booty && python -m pytest tests/test_github_comments.py -v -k "plan_comment or architect_section_if_changed" 2>/dev/null || python -m pytest tests/test_github_comments.py -v</verify>
  <done>Tests pass for get_plan_comment_body and update_plan_comment_with_architect_section_if_changed</done>
</task>

</tasks>

<verification>
- get_plan_comment_body returns body of comment with <!-- booty-plan -->
- update_plan_comment_with_architect_section_if_changed diffs exact string
- No update when blocks identical
</verification>

<success_criteria>
- ARCH-25: Update comment only when booty-architect block differs
- Tests cover found/not-found and same/different cases
</success_criteria>

<output>
After completion, create `.planning/phases/35-idempotency/35-02-SUMMARY.md`
</output>
