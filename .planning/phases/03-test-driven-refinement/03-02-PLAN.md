---
phase: 03-test-driven-refinement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/github/pulls.py
  - src/booty/github/comments.py
autonomous: true

must_haves:
  truths:
    - "System can create draft PRs on GitHub for partial/failed work"
    - "System can post failure details as comments on GitHub issues"
    - "Draft PR and issue comment include meaningful error context"
  artifacts:
    - path: "src/booty/github/pulls.py"
      provides: "Draft PR creation support via draft parameter"
      contains: "draft"
    - path: "src/booty/github/comments.py"
      provides: "Issue comment creation for failure notifications"
      exports: ["post_failure_comment"]
  key_links:
    - from: "src/booty/github/pulls.py"
      to: "repo.create_pull"
      via: "PyGithub draft parameter"
      pattern: "draft="
    - from: "src/booty/github/comments.py"
      to: "issue.create_comment"
      via: "PyGithub issue comment API"
      pattern: "create_comment"
---

<objective>
Extend GitHub integration with draft PR support and issue comment notifications for failure scenarios.

Purpose: When tests fail after all retries, the system needs to notify the issue with error details and open a draft PR with partial work. When tests pass, the PR should be non-draft (ready for review).
Output: Modified `pulls.py` with draft parameter, new `comments.py` for issue failure comments.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-test-driven-refinement/03-RESEARCH.md

@src/booty/github/__init__.py
@src/booty/github/pulls.py
@src/booty/logging.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add draft PR support to pulls.py</name>
  <files>src/booty/github/pulls.py</files>
  <action>
    Modify `create_pull_request()` in `src/booty/github/pulls.py`:
    - Add `draft: bool = False` parameter to function signature
    - Pass `draft=draft` to `repo.create_pull()` call
    - Log `draft` status in the `pull_request_created` log entry
    - Update docstring to document the draft parameter

    This is a minimal change â€” add one parameter, pass it through, log it.
  </action>
  <verify>
    - `python -c "from booty.github.pulls import create_pull_request; import inspect; sig = inspect.signature(create_pull_request); assert 'draft' in sig.parameters; print('OK')"` succeeds
  </verify>
  <done>create_pull_request accepts draft parameter, passes it to PyGithub, logs draft status</done>
</task>

<task type="auto">
  <name>Task 2: Create issue comment module for failure notifications</name>
  <files>src/booty/github/comments.py</files>
  <action>
    Create `src/booty/github/comments.py` with:

    1. Helper `_get_repo(github_token: str, repo_url: str)`:
       - Parse owner/repo from URL (same pattern as pulls.py: urlparse, strip leading `/`, strip trailing `.git`)
       - Authenticate with `Auth.Token(github_token)`
       - Return `Github(auth=auth).get_repo(owner_repo)`
       - This avoids duplicating URL parsing logic in each function

    2. `post_failure_comment(github_token: str, repo_url: str, issue_number: int, error_message: str, attempts: int, max_retries: int) -> None`:
       - Gets repo via `_get_repo()`
       - Gets issue via `repo.get_issue(issue_number)`
       - Creates comment with markdown body:
         ```
         ## Booty Build Failed

         After {attempts}/{max_retries} attempt(s), the generated code did not pass tests.

         ### Error Details

         ```
         {error_message}
         ```

         A draft PR has been opened with the latest attempt for manual review.

         ---
         *Generated by [Booty](https://github.com/datashaman/booty)*
         ```
       - Log comment creation with issue_number
       - Handle GithubException with logging and re-raise

    Use structlog logger from `booty.logging`. Follow the same import/auth pattern as `pulls.py`.
  </action>
  <verify>
    - `python -c "from booty.github.comments import post_failure_comment; print('OK')"` succeeds
    - `python -c "import inspect; from booty.github.comments import post_failure_comment; sig = inspect.signature(post_failure_comment); assert 'error_message' in sig.parameters; print('OK')"` succeeds
  </verify>
  <done>post_failure_comment creates formatted markdown comment on GitHub issue with error details, attempt count, and link to draft PR</done>
</task>

</tasks>

<verification>
- `python -c "from booty.github.pulls import create_pull_request; from booty.github.comments import post_failure_comment; print('All imports OK')"`
- `create_pull_request` has `draft` parameter defaulting to `False` (backward compatible)
- `post_failure_comment` accepts token, repo URL, issue number, error message, attempt counts
- No circular imports
</verification>

<success_criteria>
- create_pull_request supports `draft=True` for failed builds, `draft=False` (default) for passing builds
- post_failure_comment posts structured markdown to GitHub issue with error context
- Both functions handle GitHub API errors with logging
- Changes are backward-compatible (existing callers of create_pull_request unaffected)
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-driven-refinement/03-02-SUMMARY.md`
</output>
