---
phase: 15-trigger-risk-decision-logic
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/release_governor/store.py
  - src/booty/release_governor/decision.py
  - tests/test_release_governor_decision.py
autonomous: true

must_haves:
  truths:
    - "Hard holds: deploy not configured; first deploy without approval; degraded + high-risk"
    - "LOW risk: auto-ALLOW"
    - "MEDIUM risk: ALLOW if no incident, else HOLD"
    - "HIGH risk: HOLD unless approval (env/label/comment)"
    - "Cooldown: no re-deploy same SHA within N min after failure"
    - "Rate limit: max M deploys per hour enforced"
  artifacts:
    - path: src/booty/release_governor/decision.py
      provides: compute_decision with all rules
      min_lines: 80
    - path: tests/test_release_governor_decision.py
      provides: Decision logic unit tests
  key_links:
    - from: decision.py
      to: store.ReleaseState
      via: load state for cooldown/rate limit checks
      pattern: load_release_state|deploy_history
---

<objective>
Implement decision engine with hard holds, approval policy, cooldown, and rate limit (GOV-08 to GOV-13).

Purpose: Governor applies rules to produce ALLOW or HOLD. Phase 16 acts on the decision.
Output: decision.py with compute_decision; store extended for deploy_history; tests.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-trigger-risk-decision-logic/15-CONTEXT.md
@.planning/phases/15-trigger-risk-decision-logic/15-RESEARCH.md
@src/booty/release_governor/store.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend store for deploy_history (rate limit)</name>
  <files>src/booty/release_governor/store.py</files>
  <action>
    Add deploy_history to ReleaseState and JSON schema:
    - deploy_history: list[dict] = []  # [{sha, time_iso8601, result}]
    - Max 24 entries; evict oldest when appending
    - Add append_deploy_to_history(state_dir, sha, time_iso8601, result) - loads, appends, evicts, saves
    - Add get_deploys_in_last_hour(state_dir) -> int

    For Phase 15 decision only: we READ deploy_history. Phase 16 will call append_deploy_to_history when deploy completes. For testing cooldown/rate limit, we need the read functions and store shape. append_deploy_to_history can be a no-op placeholder that just defines the interface, or implement fully. Implement fully - decision tests may seed state.
  </action>
  <verify>grep -E "deploy_history|append_deploy|get_deploys_in_last" src/booty/release_governor/store.py</verify>
  <done>Store supports deploy_history for rate limit; get_deploys_in_last_hour returns count</done>
</task>

<task type="auto">
  <name>Task 2: Create decision.py with compute_decision</name>
  <files>src/booty/release_governor/decision.py</files>
  <action>
    Create decision.py with:

    @dataclass
    class Decision:
      outcome: Literal["ALLOW", "HOLD"]
      reason: str  # Reason code for UX
      risk_class: str
      sha: str

    def compute_decision(
      head_sha: str,
      risk_class: Literal["LOW","MEDIUM","HIGH"],
      config: ReleaseGovernorConfig,
      state: ReleaseState,
      state_dir: Path,
      degraded: bool | None,  # True=degraded, False=ok, None=unknown. In-process stub returns None.
      approval_context: dict,  # {"env_approved": bool, "label_approved": bool, "comment_approved": bool}
      is_first_deploy: bool,
    ) -> Decision:

    Rules (from CONTEXT and GOV-08 to GOV-13):
    1. Hard holds: (a) deploy not configured - check config.deploy_workflow_name non-empty; (b) first deploy + require_approval + no approval -> HOLD; (c) degraded + HIGH risk -> HOLD. CONTEXT: "Unknown degraded: hold HIGH only; degraded + LOW always allow."
    2. Cooldown (GOV-12): If state.last_deploy_attempt_sha == head_sha and state.last_deploy_result == "failure" and (now - last_deploy_time) < cooldown_minutes -> HOLD
    3. Rate limit (GOV-13): If get_deploys_in_last_hour(state_dir) >= config.max_deploys_per_hour -> HOLD
    4. LOW: ALLOW (GOV-09)
    5. MEDIUM: ALLOW if not degraded, else HOLD (GOV-10). CONTEXT: degraded + MEDIUM = hold
    6. HIGH: HOLD unless any(approval_context values True). Approval = env OR label OR comment (GOV-11)

    Return Decision with outcome, reason (e.g. "cooldown", "rate_limit", "high_risk_no_approval", "first_deploy_required", "degraded_high_risk", "allow_low", "allow_medium", "allow_high_approved").
  </action>
  <verify>python -c "from booty.release_governor.decision import compute_decision, Decision; print('OK')"</verify>
  <done>compute_decision returns Decision with correct outcome for all rule cases</done>
</task>

<task type="auto">
  <name>Task 3: Add decision tests</name>
  <files>tests/test_release_governor_decision.py</files>
  <action>
    Create tests for compute_decision:
    - test_low_risk_allow: risk=LOW -> ALLOW
    - test_medium_no_incident_allow: risk=MEDIUM, degraded=False -> ALLOW
    - test_medium_degraded_hold: risk=MEDIUM, degraded=True -> HOLD
    - test_high_no_approval_hold: risk=HIGH, approval all False -> HOLD
    - test_high_env_approval_allow: risk=HIGH, env_approved=True -> ALLOW
    - test_cooldown_hold: same sha, last result failure, within cooldown -> HOLD
    - test_rate_limit_hold: get_deploys_in_last_hour returns max -> HOLD
    - test_first_deploy_required_hold: is_first_deploy, require_approval, no approval -> HOLD
    - test_degraded_high_hold: degraded=True, risk=HIGH -> HOLD

    Use temp dir for state, seed release.json for cooldown/rate limit tests.
  </action>
  <verify>pytest tests/test_release_governor_decision.py -v</verify>
  <done>All decision tests pass</done>
</task>

</tasks>

<verification>
- pytest tests/test_release_governor_decision.py passes
- All rule branches tested
- Cooldown and rate limit enforced
</verification>

<success_criteria>
- Decision engine implements all GOV-08 to GOV-13 rules
- Store supports deploy_history
- Tests pass
</success_criteria>

<output>
After completion, create .planning/phases/15-trigger-risk-decision-logic/15-02-SUMMARY.md
</output>
