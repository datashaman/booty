---
phase: 15-trigger-risk-decision-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/test_runner/config.py
  - src/booty/release_governor/risk.py
  - src/booty/release_governor/__init__.py
  - tests/test_release_governor_risk.py
autonomous: true

must_haves:
  truths:
    - "Risk class computed from diff vs production_sha (LOW/MEDIUM/HIGH)"
    - "HIGH risk: workflow dirs, infra, lockfiles, migrations (configurable)"
    - "MEDIUM risk: dependency manifests (configurable)"
    - "Empty diff treated as LOW"
    - "Multi-category match takes highest risk"
  artifacts:
    - path: src/booty/release_governor/risk.py
      provides: compute_risk_class from comparison and config
      min_lines: 40
    - path: tests/test_release_governor_risk.py
      provides: Risk scoring unit tests
  key_links:
    - from: risk.py
      to: config.high_risk_paths
      via: pathspec matching
      pattern: PathSpec|high_risk_paths|medium_risk_paths
---

<objective>
Implement risk scoring from paths touched vs production_sha (GOV-05, GOV-06, GOV-07).

Purpose: Governor computes risk_class (LOW | MEDIUM | HIGH) from diff. Phase 16 uses this for decision rules.
Output: risk.py with compute_risk_class; medium_risk_paths in config; tests.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-trigger-risk-decision-logic/15-CONTEXT.md
@.planning/phases/15-trigger-risk-decision-logic/15-RESEARCH.md
@src/booty/test_runner/config.py
@src/booty/verifier/limits.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add medium_risk_paths and extend config</name>
  <files>src/booty/test_runner/config.py</files>
  <action>
    Add to ReleaseGovernorConfig:
    - medium_risk_paths: list[str] = Field(default_factory=lambda: ["**/package.json", "**/requirements*.txt", "**/pyproject.toml", "**/Cargo.toml", "**/go.mod", "**/go.sum"])
    - Add RELEASE_GOVERNOR_MEDIUM_RISK_PATHS env override in apply_release_governor_env_overrides (comma-separated, optional)

    Follow existing high_risk_paths pattern. MEDIUM = dependency manifests without lockfiles per GOV-07.
  </action>
  <verify>grep -E "medium_risk_paths|RELEASE_GOVERNOR_MEDIUM" src/booty/test_runner/config.py</verify>
  <done>ReleaseGovernorConfig has medium_risk_paths; env override exists when applicable</done>
</task>

<task type="auto">
  <name>Task 2: Create risk.py with compute_risk_class</name>
  <files>src/booty/release_governor/risk.py</files>
  <action>
    Create risk.py with:

    def compute_risk_class(comparison, config: ReleaseGovernorConfig) -> Literal["LOW", "MEDIUM", "HIGH"]:
      - comparison is PyGithub Compare object (repo.compare(base, head)); has .files with .filename
      - If no files or empty comparison.files: return "LOW" (empty diff per CONTEXT)
      - Build PathSpec from config.high_risk_paths and config.medium_risk_paths (pathspec.PathSpec.from_lines('gitwildmatch', patterns))
      - For each file in comparison.files: path = file.filename
        - If path matches high_risk_paths: return "HIGH" immediately (or track max)
        - If path matches medium_risk_paths: at least MEDIUM
        - Unlisted: LOW
      - Return highest: HIGH > MEDIUM > LOW
      - CONTEXT: "Multi-category match: take highest risk"

    Use pathspec like verifier/limits.py. Import from pathspec.
  </action>
  <verify>python -c "from booty.release_governor.risk import compute_risk_class; print('OK')"</verify>
  <done>compute_risk_class returns LOW/MEDIUM/HIGH from comparison and config</done>
</task>

<task type="auto">
  <name>Task 3: Add risk scoring tests</name>
  <files>tests/test_release_governor_risk.py</files>
  <action>
    Create tests:
    - test_empty_diff_returns_low: Mock comparison with empty files list -> LOW
    - test_high_risk_path_returns_high: Mock comparison with .github/workflows/foo.yml -> HIGH
    - test_medium_risk_path_returns_medium: Mock comparison with pyproject.toml -> MEDIUM
    - test_mixed_paths_returns_highest: Both medium and high in files -> HIGH
    - test_unlisted_path_returns_low: Random file like src/foo.py -> LOW

    Use unittest.mock.MagicMock for comparison object (has .files = [object with .filename]).
  </action>
  <verify>pytest tests/test_release_governor_risk.py -v</verify>
  <done>All risk scoring tests pass</done>
</task>

</tasks>

<verification>
- pytest tests/test_release_governor_risk.py passes
- compute_risk_class handles empty diff (LOW)
- HIGH/MEDIUM pathspecs matched correctly
</verification>

<success_criteria>
- Risk module computes class from diff
- Config has medium_risk_paths
- Tests pass
</success_criteria>

<output>
After completion, create .planning/phases/15-trigger-risk-decision-logic/15-01-SUMMARY.md
</output>
