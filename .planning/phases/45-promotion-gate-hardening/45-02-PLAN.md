---
phase: 45-promotion-gate-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/verifier/promotion_gates.py
  - src/booty/verifier/runner.py
  - src/booty/verifier/__init__.py
autonomous: true

must_haves:
  truths:
    - Plan-originated PRs with Architect enabled require Architect approval at promote-time
    - Verifier logs promotion_waiting_architect when Architect gate blocks
    - Gate order: Reviewer first, then Architect (CONTEXT)
  artifacts:
    - path: src/booty/verifier/promotion_gates.py
      provides: is_plan_originated_pr, architect_approved_for_issue
      min_lines: 80
    - path: src/booty/verifier/runner.py
      provides: Architect gate in promotion flow
  key_links:
    - from: src/booty/verifier/runner.py
      to: promotion_gates
      via: architect_approved_for_issue, is_plan_originated_pr
      pattern: promotion_gates|architect_approved|is_plan_originated
    - from: src/booty/verifier/promotion_gates.py
      to: get_plan_comment_body
      via: github.comments
      pattern: get_plan_comment_body
    - from: src/booty/verifier/promotion_gates.py
      to: load_architect_plan_for_issue
      via: architect.artifact
      pattern: load_architect_plan_for_issue
---

<objective>
Add Architect approval gate for plan-originated PRs (PROMO-02). When Verifier promotes and Architect is enabled, require Architect approval when PR is plan-originated. Create promotion_gates.py with helpers; wire into runner after Reviewer gate.

Purpose: Plan PRs must have Architect approval before promotion.
Output: verifier/promotion_gates.py; runner.py updated with Architect gate
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-promotion-gate-hardening/45-CONTEXT.md
@.planning/phases/45-promotion-gate-hardening/45-RESEARCH.md
@src/booty/verifier/runner.py
@src/booty/github/comments.py
@src/booty/architect/artifact.py
@src/booty/architect/config.py
@src/booty/architect/output.py
</context>

<tasks>

<task type="auto">
  <name>Create verifier/promotion_gates.py</name>
  <files>src/booty/verifier/promotion_gates.py</files>
  <action>
Create src/booty/verifier/promotion_gates.py with:

1. is_plan_originated_pr(github_token: str, repo_url: str, issue_number: int | None) -> bool
   - If issue_number is None: return False (indeterminate, skip Architect gate)
   - Call get_plan_comment_body(github_token, repo_url, issue_number)
   - Return True if body is not None and "<!-- booty-plan -->" in body
   - Fallback: if get_plan_comment_body returns None, check load_architect_plan_for_issue(owner, repo, issue_number) — parse owner/repo from repo_url (e.g. https://github.com/owner/repo -> owner, repo). If artifact exists, treat as plan-originated
   - Use booty.planner.store to get owner/repo from repo_url or use github.comments._get_repo pattern to parse

2. architect_approved_for_issue(github_token: str, repo_url: str, issue_number: int, owner: str, repo: str, state_dir=None) -> bool
   - Call get_plan_comment_body(github_token, repo_url, issue_number)
   - If body exists: extract <!-- booty-architect --> block with regex r"<!-- booty-architect -->.*?<!-- /booty-architect -->" (re.DOTALL). Return True if "✓ Approved" in matched content
   - Fallback: load_architect_plan_for_issue(owner, repo, issue_number, state_dir). If returns non-None, return True (disk is advisory per CONTEXT)
   - Return False if neither source shows approval

3. Import: get_plan_comment_body from booty.github.comments; load_architect_plan_for_issue from booty.architect.artifact

4. Parse owner/repo from repo_url: use urllib.parse or regex. Pattern: github.com/owner/repo or https://github.com/owner/repo. Extract last two path segments.
</action>
  <verify>python -c "
from booty.verifier.promotion_gates import is_plan_originated_pr, architect_approved_for_issue
# Smoke test
print(is_plan_originated_pr('x','https://github.com/o/r',None) == False)
print('OK')
"</verify>
  <done>promotion_gates.py exists; is_plan_originated_pr and architect_approved_for_issue callable with correct signatures.</done>
</task>

<task type="auto">
  <name>Wire Architect gate into Verifier runner</name>
  <files>src/booty/verifier/runner.py</files>
  <action>
In process_verifier_job, after Reviewer gate (can_promote from reviewer_check_success):

1. Import: get_architect_config, apply_architect_env_overrides from booty.architect.config; ArchitectConfigError; is_plan_originated_pr, architect_approved_for_issue from booty.verifier.promotion_gates

2. Determine architect_enabled:
   - ac = get_architect_config(config) if config else None
   - If ac is not None: ac = apply_architect_env_overrides(ac); architect_enabled = ac.enabled
   - On ArchitectConfigError: architect_enabled = False (same pattern as Reviewer)

3. If architect_enabled and can_promote and repo is not None:
   - If job.issue_number is None: skip Architect gate (not plan-originated determinable)
   - Else: is_plan_orig = is_plan_originated_pr(settings.GITHUB_TOKEN, job.repo_url, job.issue_number)
   - If is_plan_orig: architect_ok = architect_approved_for_issue(settings.GITHUB_TOKEN, job.repo_url, job.issue_number, job.owner, job.repo_name)
   - If is_plan_orig and not architect_ok: can_promote = False; logger.info("promotion_waiting_architect", job_id=job.job_id, pr_number=job.pr_number)

4. Gate order: Reviewer first (existing), Architect second (new). Both blocking when applicable.

5. Export promotion_gates from verifier/__init__.py if needed for tests; runner imports directly.
</action>
  <verify>grep -n "promotion_waiting_architect\|architect_approved_for_issue\|is_plan_originated_pr" src/booty/verifier/runner.py</verify>
  <done>Architect gate wired; promotion_waiting_architect logged when plan-originated and Architect not approved.</done>
</task>

<task type="auto">
  <name>Verify PROMO-03 and export promotion_gates</name>
  <files>src/booty/verifier/__init__.py</files>
  <action>
1. Add promotion_gates to verifier __init__.py exports if tests need it (optional).

2. verification: grep that only Verifier calls promote_to_ready_for_review:
   rg "promote_to_ready_for_review" src/ --type py
   Expected: promotion.py (definition), verifier/runner.py (call). No other callers (generator, main, etc.).
   If any other caller found, document or fix.
</action>
  <verify>rg 'promote_to_ready_for_review' src/ --type py -A0 | grep -v promotion.py | grep -v runner.py | wc -l outputs 0</verify>
  <done>PROMO-03 verified: only Verifier calls promote. promotion_gates exported if useful.</done>
</task>

</tasks>

<verification>
- PROMO-02: Architect gate for plan-originated PRs
- PROMO-03: Only Verifier calls promote (grep)
- PROMO-04: Gates checked at promote-time (deterministic)
</verification>

<success_criteria>
- Plan-originated PRs with Architect enabled require Architect approval
- promotion_waiting_architect logged when blocked
- Gate order: Reviewer then Architect
- Only Verifier calls promote_to_ready_for_review
</success_criteria>

<output>
After completion, create `.planning/phases/45-promotion-gate-hardening/45-02-SUMMARY.md`
</output>
