---
phase: 45-promotion-gate-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/github/promotion.py
autonomous: true

must_haves:
  truths:
    - promote_to_ready_for_review skips when PR is already ready (not draft)
    - promote_to_ready_for_review logs pr_already_ready when PR not draft
    - promote_to_ready_for_review re-fetches PR draft state before promote
  artifacts:
    - path: src/booty/github/promotion.py
      provides: idempotent promote_to_ready_for_review
      min_lines: 55
  key_links:
    - from: src/booty/github/promotion.py
      to: pr.draft check before mark_ready_for_review
      via: repo.get_pull(pr_number); if not pr.draft return
      pattern: pr\.draft|pr_already_ready
---

<objective>
Make promote_to_ready_for_review idempotent (PROMO-05). Re-fetch PR draft state before promote; if not draft (already ready), log pr_already_ready and return without calling mark_ready_for_review.

Purpose: Second-finisher or retries must not double-promote or cause API errors.
Output: promotion.py updated with idempotency check
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-promotion-gate-hardening/45-CONTEXT.md
@.planning/phases/45-promotion-gate-hardening/45-RESEARCH.md
@src/booty/github/promotion.py
</context>

<tasks>

<task type="auto">
  <name>Add idempotency to promote_to_ready_for_review</name>
  <files>src/booty/github/promotion.py</files>
  <action>
In promote_to_ready_for_review, before calling pr.mark_ready_for_review():

1. After repo = _get_repo(...) and pr = repo.get_pull(pr_number), add:
   - if not pr.draft: logger.info("pr_already_ready", pr_number=pr_number); return
   - This makes the call idempotent: if PR was already promoted (e.g. by a prior run or second-finisher), skip

2. Keep existing retry decorator and _should_retry_promotion (5xx/network only)

3. On PR missing/inaccessible: PyGithub raises GithubException. Per CONTEXT, caller (Verifier) handles. Do NOT add try/except here that swallows and returns — let exception propagate so Verifier can log agent_promotion_failed. Idempotency handles already-ready only.

4. Update docstring to mention idempotent behavior: "Re-fetches PR; if not draft, logs pr_already_ready and returns without promoting."
</action>
  <verify>grep -n "pr\.draft\|pr_already_ready" src/booty/github/promotion.py</verify>
  <done>promote_to_ready_for_review checks pr.draft; logs pr_already_ready when not draft; skips mark_ready_for_review in that case.</done>
</task>

</tasks>

<verification>
- promote_to_ready_for_review exists with idempotency
- Call flow: get repo → get pull → check draft → if not draft return → else mark_ready_for_review
</verification>

<success_criteria>
- PROMO-05: promote_to_ready_for_review is idempotent
- Re-fetch before promote; no-op when PR already ready
</success_criteria>

<output>
After completion, create `.planning/phases/45-promotion-gate-hardening/45-01-SUMMARY.md`
</output>
