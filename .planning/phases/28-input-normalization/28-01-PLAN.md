---
phase: 28-input-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/planner/input.py
  - tests/test_planner_input.py
autonomous: true

must_haves:
  truths:
    - Planner accepts full GitHub Issue (title, body, labels) into normalized structure
    - Planner accepts operator CLI text via goal + body split
    - Planner detects Observability incident format (label agent:incident or body markers **Severity:** + **Sentry:**)
    - source_type derived from labels or heuristics (incident, feature_request, bug, unknown)
    - Single PlannerInput structure with goal, body, labels, source_type, metadata
  artifacts:
    - path: src/booty/planner/input.py
      provides: PlannerInput, normalize_github_issue, normalize_cli_text, normalize_from_job
  key_links:
    - from: input.py
      to: booty.github.issues (build_sentry_issue_body markers)
      via: Detection heuristics reference Sentry format
      pattern: Severity|Sentry|Location
---

<objective>
Create PlannerInput Pydantic model and normalizers for GitHub issue and CLI text. Detect Observability (Sentry) incident format via label or body heuristics. Single normalized structure consumed by worker and CLI.

Purpose: PLAN-01, PLAN-02, PLAN-03 — Planner accepts all three input types; Phase 29 consumes PlannerInput.
Output: src/booty/planner/input.py with PlannerInput, normalizers, incident detection.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-input-normalization/28-CONTEXT.md
@.planning/phases/28-input-normalization/28-RESEARCH.md
@src/booty/github/issues.py
@src/booty/planner/jobs.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: PlannerInput model and incident detection</name>
  <files>src/booty/planner/input.py</files>
  <action>
Create src/booty/planner/input.py.

1. **PlannerInput** (Pydantic):
   - goal: str (primary objective)
   - body: str (full context; trim to 8000 chars max per RESEARCH)
   - labels: list[str] (pass-through)
   - source_type: Literal["incident","feature_request","bug","unknown"]
   - metadata: dict (repo owner/repo, issue_url, issue_number when present)
   - incident_fields: dict | None (when source_type=incident: location, sentry_url extracted)
   - repo_context: dict | None (optional; Phase 28-03 will populate)

2. **_looks_like_sentry_body(body: str) -> bool**: Return True if body contains BOTH "**Severity:**" AND "**Sentry:**" (2+ markers per RESEARCH pitfall).

3. **_looks_like_sentry_title(title: str) -> bool**: Return True if title matches r"^\[(error|warning|info|debug)\]" (bracket-prefix pattern from build_sentry_issue_title).

4. **derive_source_type(labels, body, title) -> str**: Label map: agent:incident→incident, bug→bug, enhancement→feature_request. If no label match and (_looks_like_sentry_body or _looks_like_sentry_title) → incident. Else unknown.

5. **_extract_incident_fields(body: str) -> dict**: Extract location from "**Location:**" line, sentry_url from "**Sentry:**" line; return {"location": str, "sentry_url": str}. Regex or simple split; handle missing gracefully.
  </action>
  <verify>python -c "
from booty.planner.input import PlannerInput, derive_source_type, _extract_incident_fields
t = derive_source_type(['agent:incident'], '', '')
assert t == 'incident'
t2 = derive_source_type([], '**Severity:** x\n**Sentry:** https://a.b', '')
assert t2 == 'incident'
fields = _extract_incident_fields('**Location:** foo.py\n**Sentry:** https://sentry.io/x')
assert fields.get('location') == 'foo.py' and 'sentry' in (fields.get('sentry_url') or '')
"</verify>
  <done>PlannerInput model, incident detection (label + heuristics), incident field extraction</done>
</task>

<task type="auto">
  <name>Task 2: normalizers for GitHub issue and CLI text</name>
  <files>src/booty/planner/input.py</files>
  <action>
Add to input.py:

1. **normalize_github_issue(issue: dict, repo_info: dict | None = None, repo_context: dict | None = None) -> PlannerInput**:
   - title = issue.get("title") or "Untitled"
   - body = issue.get("body") or ""
   - Trim body to 8000 chars if longer
   - labels = [l.get("name","") for l in issue.get("labels", [])]
   - source_type = derive_source_type(labels, body, title)
   - incident_fields = _extract_incident_fields(body) if source_type=="incident" else None
   - metadata = {repo_info keys (owner, repo), issue_url, issue_number from issue}
   - Return PlannerInput(goal=title, body=body, labels=labels, source_type=source_type, metadata=metadata, incident_fields=incident_fields, repo_context=repo_context)

2. **normalize_cli_text(text: str, repo_info: dict | None = None, repo_context: dict | None = None) -> PlannerInput**:
   - First line (up to newline) as goal; remainder as body. If no newline, all as goal, body=""
   - Truncate goal to 200 chars if longer (match current CLI behavior)
   - Trim body to 8000 chars
   - source_type = "unknown" (CLI free text)
   - labels = []
   - metadata = {repo_info} if repo_info else {}
   - Return PlannerInput(...)

3. **normalize_from_job(job: PlannerJob, repo_context: dict | None = None) -> PlannerInput**:
   - issue = job.payload.get("issue", {})
   - repo_info = {"owner": job.owner, "repo": job.repo}
   - return normalize_github_issue(issue, repo_info, repo_context)
  </action>
  <verify>python -c "
from booty.planner.input import normalize_github_issue, normalize_cli_text, normalize_from_job
from booty.planner.jobs import PlannerJob
i = normalize_github_issue({'title':'Fix bug','body':'Desc','labels':[{'name':'bug'}]})
assert i.goal=='Fix bug' and i.source_type=='bug'
c = normalize_cli_text('First line\nRest of text')
assert c.goal=='First line' and 'Rest' in c.body
j = PlannerJob('x',1,'','','o','r',{'issue':{'title':'T','body':'','labels':[]}})
n = normalize_from_job(j)
assert n.goal=='T'
"</verify>
  <done>normalize_github_issue, normalize_cli_text, normalize_from_job produce valid PlannerInput</done>
</task>

<task type="auto">
  <name>Task 3: Tests for input normalization</name>
  <files>tests/test_planner_input.py</files>
  <action>
Add tests: (1) PlannerInput validation; (2) derive_source_type for incident (label, heuristics), bug, enhancement, unknown; (3) _extract_incident_fields with Location and Sentry; (4) normalize_github_issue with full issue dict; (5) normalize_cli_text goal/body split (single line, multi-line); (6) body trim 8000 chars; (7) normalize_from_job with PlannerJob payload.
  </action>
  <verify>pytest tests/test_planner_input.py -v</verify>
  <done>All planner input tests pass</done>
</task>

</tasks>

<verification>
- pytest tests/test_planner_input.py passes
- python -c "from booty.planner.input import PlannerInput, normalize_github_issue, normalize_cli_text, normalize_from_job; ..." runs without error
</verification>

<success_criteria>
- PlannerInput has goal, body, labels, source_type, metadata, incident_fields, repo_context
- Incident detected by agent:incident label or **Severity:**+**Sentry:** in body
- GitHub issue and CLI text normalize to PlannerInput
</success_criteria>

<output>
After completion, create .planning/phases/28-input-normalization/28-01-SUMMARY.md
</output>
