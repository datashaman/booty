---
phase: 28-input-normalization
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/booty/planner/input.py
autonomous: true

must_haves:
  truths:
    - Optional repo context (default branch, shallow tree 2-3 levels) fetched when repo available
    - get_repo_context returns {default_branch, tree} for PlannerInput.repo_context
    - CLI plan --text infers repo from cwd when in git repo; omit repo context otherwise
  artifacts:
    - path: src/booty/planner/input.py
      contains: get_repo_context (or in dedicated module)
  key_links:
    - from: get_repo_context
      to: PyGithub repo.get_contents, default_branch
      via: Fetch tree up to 2 levels
      pattern: get_contents|default_branch
---

<objective>
Add optional repo context fetch: default branch and file tree (2-3 levels). Used when normalizing GitHub issue or CLI with repo. PLAN-04.

Purpose: Enrich PlannerInput with repo structure for Phase 29 context.
Output: get_repo_context(owner, repo, token) -> dict; integrate into normalizers.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-input-normalization/28-CONTEXT.md
@.planning/phases/28-input-normalization/28-RESEARCH.md
@src/booty/cli.py
@src/booty/webhooks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: get_repo_context function</name>
  <files>src/booty/planner/input.py</files>
  <action>
Add get_repo_context(owner: str, repo: str, token: str, max_depth: int = 2) -> dict | None to input.py.

1. Use Github(auth=Auth.Token(token)).get_repo(f"{owner}/{repo}")
2. default_branch = gh_repo.default_branch or "main"
3. Tree: recursive get_contents. For path="" get root; for each ContentFile with type=="dir", recurse up to max_depth (2). Return list of {"path": c.path, "type": c.type}
4. Handle GithubException (404, auth) â†’ return None
5. Return {"default_branch": default_branch, "tree": list}
  </action>
  <verify>python -c "
from booty.planner.input import get_repo_context
# Requires GITHUB_TOKEN - skip if not set
import os
t = os.environ.get('GITHUB_TOKEN')
if t:
    ctx = get_repo_context('datashaman','booty',t)
    assert ctx and 'default_branch' in ctx and 'tree' in ctx
else:
    print('Skip: no GITHUB_TOKEN')
"</verify>
  <done>get_repo_context returns default_branch and tree (2 levels); None on error</done>
</task>

<task type="auto">
  <name>Task 2: Verify normalizers accept repo_context</name>
  <files>src/booty/planner/input.py</files>
  <action>
28-01 normalizers already accept repo_context: dict | None. Verify normalize_github_issue and normalize_cli_text pass repo_context into PlannerInput. No code change if already correct. Integration (calling get_repo_context when wiring) is in 28-03.
  </action>
  <verify>normalize_github_issue(issue, repo_info={"owner":"o","repo":"r"}, repo_context={"default_branch":"main","tree":[]}) produces PlannerInput with repo_context set</verify>
  <done>repo_context flows through normalizers when provided</done>
</task>

</tasks>

<verification>
- get_repo_context returns expected shape or None
- Normalizers accept and pass repo_context
</verification>

<success_criteria>
- Optional repo context (default branch, tree) available for PlannerInput
- Graceful None when token missing or repo unreachable
</success_criteria>

<output>
After completion, create .planning/phases/28-input-normalization/28-02-SUMMARY.md
</output>
