---
phase: 43-dedup-alignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/verifier/queue.py
  - src/booty/security/queue.py
  - src/booty/router/router.py
autonomous: true

must_haves:
  truths:
    - All PR agents use dedup key (repo_full_name, pr_number, head_sha)
    - VerifierQueue and SecurityQueue accept repo_full_name in is_duplicate and mark_processed
    - Router passes internal.full_name to all PR queue dedup calls
  artifacts:
    - path: src/booty/verifier/queue.py
      provides: VerifierQueue with repo-scoped dedup
    - path: src/booty/security/queue.py
      provides: SecurityQueue with repo-scoped dedup
  key_links:
    - from: src/booty/router/router.py
      to: src/booty/verifier/queue.py
      via: verifier_queue.is_duplicate(repo_full_name, pr_number, head_sha)
    - from: src/booty/router/router.py
      to: src/booty/security/queue.py
      via: security_queue.is_duplicate(repo_full_name, pr_number, head_sha)
---

<objective>
Add repo_full_name to VerifierQueue and SecurityQueue dedup. DEDUP-01, DEDUP-04.

Purpose: Standardize PR agent dedup to (repo_full_name, pr_number, head_sha) to avoid multi-repo collision.
Output: Updated VerifierQueue, SecurityQueue, router call sites.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/43-dedup-alignment/43-CONTEXT.md
@.planning/phases/43-dedup-alignment/43-RESEARCH.md
@src/booty/reviewer/queue.py
@src/booty/router/router.py
</context>

<tasks>

<task type="auto">
  <name>Update VerifierQueue dedup to include repo</name>
  <files>src/booty/verifier/queue.py</files>
  <action>
In src/booty/verifier/queue.py:

1. Change _dedup_key(pr_number, head_sha) to _dedup_key(repo_full_name: str, pr_number: int, head_sha: str) -> str
   - Return f"{repo_full_name}:{pr_number}:{head_sha}"

2. is_duplicate(pr_number, head_sha) -> is_duplicate(repo_full_name: str, pr_number: int, head_sha: str) -> bool

3. mark_processed(pr_number, head_sha) -> mark_processed(repo_full_name: str, pr_number: int, head_sha: str) -> None

4. enqueue(job): derive repo_full_name = f"{job.owner}/{job.repo_name}"; use it for key checks and mark_processed
</action>
  <verify>python -c "
from booty.verifier.queue import VerifierQueue
q = VerifierQueue()
assert not q.is_duplicate('o/r', 1, 'abc')
q.mark_processed('o/r', 1, 'abc')
assert q.is_duplicate('o/r', 1, 'abc')
assert not q.is_duplicate('o/r2', 1, 'abc')
print('ok')
"</verify>
  <done>VerifierQueue uses (repo_full_name, pr_number, head_sha)</done>
</task>

<task type="auto">
  <name>Update SecurityQueue dedup to include repo</name>
  <files>src/booty/security/queue.py</files>
  <action>
In src/booty/security/queue.py:

1. Change _dedup_key(pr_number, head_sha) to _dedup_key(repo_full_name: str, pr_number: int, head_sha: str) -> str
   - Return f"{repo_full_name}:{pr_number}:{head_sha}"

2. is_duplicate(pr_number, head_sha) -> is_duplicate(repo_full_name: str, pr_number: int, head_sha: str) -> bool

3. mark_processed(pr_number, head_sha) -> mark_processed(repo_full_name: str, pr_number: int, head_sha: str) -> None

4. enqueue(job): derive repo_full_name = f"{job.owner}/{job.repo_name}"; use it for key checks and mark_processed
</action>
  <verify>python -c "
from booty.security.queue import SecurityQueue
q = SecurityQueue()
assert not q.is_duplicate('o/r', 1, 'abc')
q.mark_processed('o/r', 1, 'abc')
assert q.is_duplicate('o/r', 1, 'abc')
assert not q.is_duplicate('o/r2', 1, 'abc')
print('ok')
"</verify>
  <done>SecurityQueue uses (repo_full_name, pr_number, head_sha)</done>
</task>

<task type="auto">
  <name>Update router to pass repo_full_name to Verifier and Security</name>
  <files>src/booty/router/router.py</files>
  <action>
In _route_pull_request:

1. Verifier: change verifier_queue.is_duplicate(internal.pr_number, internal.head_sha) to verifier_queue.is_duplicate(internal.full_name, internal.pr_number, internal.head_sha)

2. Security: change security_queue.is_duplicate(internal.pr_number, internal.head_sha) to security_queue.is_duplicate(internal.full_name, internal.pr_number, internal.head_sha)

3. Verifier enqueue: queue now derives repo from job internally; no change needed at call site.

4. Security enqueue: same â€” queue derives from job.

5. Update verifier_already_processed log to include repo if helpful (optional).
</action>
  <verify>grep -n "is_duplicate.*full_name" src/booty/router/router.py | grep -E "verifier|security"</verify>
  <done>Router passes internal.full_name to Verifier and Security is_duplicate</done>
</task>

</tasks>

<verification>
- DEDUP-01: PR agents use (repo_full_name, pr_number, head_sha)
- DEDUP-04: VerifierQueue and SecurityQueue accept repo in dedup
- ReviewerQueue unchanged (already correct)
</verification>

<success_criteria>
- VerifierQueue.is_duplicate(repo_full_name, pr_number, head_sha)
- SecurityQueue.is_duplicate(repo_full_name, pr_number, head_sha)
- Router passes internal.full_name to both
</success_criteria>

<output>
After completion, create .planning/phases/43-dedup-alignment/43-01-SUMMARY.md
</output>
