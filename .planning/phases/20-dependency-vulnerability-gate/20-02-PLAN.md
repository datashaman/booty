---
phase: 20-dependency-vulnerability-gate
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/booty/security/runner.py
autonomous: true

must_haves:
  truths:
    - "Dependency audit runs after secret scan in process_security_job"
    - "FAIL when AuditResult.ok=False: title 'Security failed — high vulnerability' or 'Security failed — critical vulnerability'"
    - "Summary: group by ecosystem; failed ecosystems first; cap 100 findings in output"
    - "Success: 'All dependency audits passed (N ecosystems)' or include low/medium note"
    - "No file+line annotations for dependency vulns (summary text only)"
  artifacts:
    - path: src/booty/security/runner.py
      provides: process_security_job with dependency audit integration
      contains: "run_dependency_audit"
  key_links:
    - from: runner.process_security_job
      to: audit.run_dependency_audit
      via: after run_secret_scan
      pattern: "run_dependency_audit"
---

<objective>
Wire dependency audit into security runner: after secret scan, run run_dependency_audit; FAIL check when severity >= HIGH with appropriate title and summary.

Purpose: SEC-05, SEC-06, SEC-07, SEC-16 — complete dependency vulnerability gate in booty/security check.
Output: process_security_job runs audit after secrets; FAIL with "Security failed — high/critical vulnerability" + summary.
</objective>

<execution_context>
@.planning/phases/20-dependency-vulnerability-gate/20-RESEARCH.md
@.planning/phases/20-dependency-vulnerability-gate/20-CONTEXT.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/booty/security/runner.py
@src/booty/security/audit.py
@src/booty/github/checks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run audit after secret scan</name>
  <files>src/booty/security/runner.py</files>
  <action>
In process_security_job, after the secret scan block (both success and before the final success edit_check_run):

1. Import run_dependency_audit from booty.security.audit
2. If secret scan passed (no findings) or failed (already returned): after secret scan handling, run audit:
   - audit_result = await asyncio.to_thread(run_dependency_audit, workspace.path, security_config)
3. If audit_result.ok is False:
   - title = "Security failed — critical vulnerability" if audit_result.worst_severity == "critical" else "Security failed — high vulnerability"
   - summary = build_audit_summary(audit_result) — see Task 2
   - edit_check_run(conclusion="failure", output={title, summary})
   - Return (do not fall through to success)
4. If audit_result.ok is True:
   - Include in success summary: "All dependency audits passed (N ecosystems)." + low/medium note if findings below threshold
   - Merge with existing "No secrets detected" or "Security check complete" message
5. If audit has errors (tool missing) but no high/critical findings: still FAIL with "pip-audit not found — install to enable Python dependency audit" etc. per CONTEXT
6. Order: secret scan first, then dependency audit; both must pass for overall success
  </action>
  <verify>Read runner.py — ensure run_dependency_audit called after run_secret_scan, before success path</verify>
  <done>Audit runs after secret scan; failure path uses edit_check_run.</done>
</task>

<task type="auto">
  <name>Task 2: Build audit summary format</name>
  <files>src/booty/security/runner.py</files>
  <action>
Add build_audit_summary(audit_result: AuditResult) -> str:

1. Group by ecosystem; failed ecosystems first (have findings with severity >= high)
2. Per ecosystem line: "Ecosystem: N high, M critical. Affected: path1, path2, ..."
3. If errors: "Errors: pip-audit not found — ..."
4. Cap findings at 100 in displayed output
5. Format per CONTEXT: "Dependency audit failed — HIGH vulnerability detected. Affected: packages/lib/package-lock.json, packages/app/yarn.lock"
6. For success: "All dependency audits passed (3 ecosystems). 5 low/medium advisories found." when applicable
  </action>
  <verify>python -c "
from booty.security.audit import AuditResult
# Mock AuditResult with failures; call build_audit_summary if in runner
print('OK')
"</verify>
  <done>build_audit_summary produces CONTEXT-compliant summary text.</done>
</task>

<task type="auto">
  <name>Task 3: Combined success path</name>
  <files>src/booty/security/runner.py</files>
  <action>
7. When both secret scan and dependency audit pass:
   - title: "Security check complete"
   - summary: "No secrets detected. All dependency audits passed (N ecosystems)." or with low/medium note
8. Ensure no annotations for dependency findings (CONTEXT: summary text only)
9. Handle timeout: wrap audit in try/except; on timeout or exception, edit_check_run(conclusion="failure", title="Security failed — high vulnerability", summary="Audit timed out" or error msg)
10. Total check budget 60s (SEC-17): secret scan + audit; if audit module has per-run timeout, keep it within remaining budget
  </action>
  <verify>pytest tests/ -v -k "security" --ignore=tests/e2e/ 2>/dev/null | head -40</verify>
  <done>Combined success/failure paths; no annotations for deps; timeout handled.</done>
</task>

</tasks>

<verification>
- SEC-05: Ecosystem auto-detected from lockfiles
- SEC-06: Correct audit tool per ecosystem
- SEC-07: FAIL only on severity >= HIGH
- SEC-16: Title "Security failed — critical vulnerability" vs "Security failed — high vulnerability"
- No file+line annotations for dependency vulns
</verification>

<success_criteria>
- Dependency audit integrated in security check
- Fail path with correct title and summary
- Success path includes audit summary
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-dependency-vulnerability-gate/20-02-SUMMARY.md`
</output>
