# Phase 20: Dependency Vulnerability Gate - Context

**Gathered:** 2026-02-16
**Status:** Ready for planning

<domain>
## Phase Boundary

Auto-detect ecosystem from lockfiles and manifests; run the appropriate audit tool per ecosystem; FAIL the check when any vulnerability has severity >= HIGH. Support pip, npm, composer, cargo; optionally yarn and pnpm. Security boundary is the repository — audit all detected lockfiles, never short-circuit.

</domain>

<decisions>
## Implementation Decisions

### Lockfile detection

- **Python manifests (not lockfiles):** requirements*.txt, pyproject.toml — audit with pip-audit; do NOT classify as lockfiles (Phase 21: MEDIUM risk for Governor)
- **Python lockfiles:** poetry.lock, Pipfile.lock, uv.lock — true lockfiles (Phase 21: HIGH risk)
- **Node:** package-lock.json, yarn.lock, pnpm-lock.yaml — all valid; run npm audit, yarn audit, pnpm audit respectively
- **Monorepo:** Audit ALL detected lockfiles; fail if any has HIGH/CRITICAL. Deduplicate identical lockfiles (hash compare). Run audits in parallel. Aggregate into single check summary listing all affected lockfiles. Never short-circuit on first failure — operators need full blast radius. Security boundary = repository, not package
- **pyproject.toml without lockfile:** Still audit with pip-audit (avoid blind spot). If lockfile exists → audit lockfile (authoritative). If only pyproject.toml → run pip-audit; CRITICAL→FAIL; HIGH→FAIL with "no lockfile present — versions may drift". Emit advisory in check summary: "No Python lockfile detected. Dependency graph is not reproducible. Recommend adding poetry.lock / uv.lock / Pipfile.lock." Lack of lockfile is supply-chain risk

### Tool availability & failures

- **Tool not installed:** FAIL with clear message (e.g. "pip-audit not found — install to enable Python dependency audit")
- **Audit timeout:** FAIL with "audit timed out"
- **Network/registry error:** Retry 2 times with exponential backoff, then FAIL
- **Only low/medium vulns:** Check passes; include "X low/medium advisories found" in summary

### Severity display & check output

- **Title:** Distinguish "Security failed — high vulnerability" vs "Security failed — critical vulnerability"
- **Format:** Summary text only in check output (no file+line annotations)
- **Per-vuln:** Package name + severity + CVE ID
- **Cap:** 100 findings (vs 50 for secrets)

### Multi-ecosystem behavior

- **Output structure:** Group by ecosystem in summary
- **Title severity:** Use worst severity found across all ecosystems
- **Success summary:** Include ecosystem count; include low/medium note when present (e.g. "All dependency audits passed (3 ecosystems). 5 low/medium advisories found.")
- **Order:** Failed ecosystems first, then passed

### Claude's Discretion

- Exact retry backoff timing
- Hash algorithm for lockfile deduplication
- Timeout threshold (within 60s total check budget from SEC-17)

</decisions>

<specifics>
## Specific Ideas

- "The security boundary is the repository, not the package"
- "Never short-circuit on the first failure — operators need the full blast radius immediately"
- "Dependency audit failed — HIGH vulnerability detected. Affected: packages/lib/package-lock.json, packages/app/yarn.lock"
- "Lack of a lockfile is itself a supply-chain risk. Do NOT skip the audit — that creates a blind spot"

</specifics>

<deferred>
## Deferred Ideas

- **Phase 21:** requirements*.txt = MEDIUM risk for Governor; poetry.lock, Pipfile.lock, uv.lock = HIGH risk. Avoids over-triggering Governor approvals while capturing dependency surface changes.

</deferred>

---

*Phase: 20-dependency-vulnerability-gate*
*Context gathered: 2026-02-16*
