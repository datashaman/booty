---
phase: 20-dependency-vulnerability-gate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/security/audit.py
  - tests/test_security_audit.py
autonomous: true

must_haves:
  truths:
    - "Lockfile discovery: requirements*.txt, pyproject.toml, poetry.lock, Pipfile.lock, uv.lock (Python); package-lock.json, yarn.lock, pnpm-lock.yaml (Node); composer.lock (PHP); Cargo.lock (Rust)"
    - "Deduplicate identical lockfiles by content hash"
    - "Per-ecosystem audit: pip-audit, npm/yarn/pnpm audit, composer audit, cargo audit"
    - "FAIL only when severity >= HIGH (config fail_severity)"
    - "Parse JSON output where available; filter by severity"
    - "Tool not installed → clear FAIL message per ecosystem"
    - "Run audits in parallel; never short-circuit"
  artifacts:
    - path: src/booty/security/audit.py
      provides: discover_lockfiles, run_dependency_audit, AuditResult
      contains: "run_dependency_audit"
    - path: tests/test_security_audit.py
      provides: Unit tests for audit logic
      contains: "discover_lockfiles"
  key_links:
    - from: audit.run_dependency_audit
      to: subprocess
      via: pip-audit, npm audit, etc.
      pattern: "subprocess|asyncio"
---

<objective>
Create dependency audit module: discover_lockfiles, run_dependency_audit with parallel execution, severity filtering, and AuditResult for runner consumption.

Purpose: SEC-05, SEC-06, SEC-07 — auto-detect ecosystems, run correct audit tool, FAIL on severity >= HIGH.
Output: booty.security.audit with run_dependency_audit(workspace_path, config) -> AuditResult.
</objective>

<execution_context>
@.planning/phases/20-dependency-vulnerability-gate/20-RESEARCH.md
@.planning/phases/20-dependency-vulnerability-gate/20-CONTEXT.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@src/booty/security/scanner.py
@src/booty/test_runner/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lockfile patterns and discovery</name>
  <files>src/booty/security/audit.py</files>
  <action>
Create src/booty/security/audit.py:

1. Define LOCKFILE_PATTERNS: dict[ecosystem -> list[glob]]:
   - python: requirements*.txt, pyproject.toml, poetry.lock, Pipfile.lock, uv.lock
   - node: package-lock.json, yarn.lock, pnpm-lock.yaml
   - php: composer.lock
   - rust: Cargo.lock

2. discover_lockfiles(workspace_path: Path) -> list[tuple[str, Path]]:
   - Returns [(ecosystem, path), ...] for each found file
   - Use pathlib rglob; resolve ecosystem from filename (package-lock.json->node, etc.)
   - For python: pyproject.toml/requirements*.txt = manifest (not lockfile); poetry.lock/Pipfile.lock/uv.lock = lockfile
   - Deduplicate by content hash: hashlib.sha256(path.read_bytes()); skip if hash already seen
   - Return sorted by (ecosystem, path) for deterministic order
  </action>
  <verify>python -c "
from pathlib import Path
from booty.security.audit import discover_lockfiles
found = discover_lockfiles(Path('.'))
assert isinstance(found, list)
for e, p in found:
    assert e in ('python','node','php','rust')
    assert p.exists()
print('OK')
"</verify>
  <done>discover_lockfiles returns ecosystem-path pairs, deduped by hash.</done>
</task>

<task type="auto">
  <name>Task 2: AuditResult and tool mapping</name>
  <files>src/booty/security/audit.py</files>
  <action>
3. AuditResult dataclass:
   - ok: bool (no high/critical failures)
   - findings: list[dict] with keys: ecosystem, path, package, severity, cve_id
   - errors: list[str] (tool missing, timeout, parse error)
   - summary_by_ecosystem: dict[str, str] (ecosystem -> "N high, M critical" or "passed")
   - worst_severity: "critical" | "high" | "medium" | "low" | None

4. TOOL_BY_ECOSystem: node package-lock.json->npm, yarn.lock->yarn, pnpm-lock.yaml->pnpm; python->pip-audit; php->composer; rust->cargo

5. _run_python_audit(path, fail_severity), _run_node_audit(path, tool, fail_severity), _run_composer_audit(path, fail_severity), _run_cargo_audit(path, fail_severity):
   - Check shutil.which(binary) before run; if missing append to errors "pip-audit not found — install to enable Python dependency audit"
   - subprocess.run with timeout=30, capture_output=True, cwd=path.parent for relative paths
   - Parse stdout JSON; filter vulns by severity >= fail_severity (high, critical)
   - pip-audit: no severity in JSON — treat any vuln as high for fail_severity high/critical
   - npm: metadata.vulnerabilities; --audit-level=high for exit code OR parse JSON
   - Return list of findings dicts
  </action>
  <verify>python -c "
from booty.security.audit import AuditResult
r = AuditResult(ok=True, findings=[], errors=[], summary_by_ecosystem={}, worst_severity=None)
assert r.ok
print('OK')
"</verify>
  <done>AuditResult and per-tool runners with severity filter.</done>
</task>

<task type="auto">
  <name>Task 3: run_dependency_audit orchestration</name>
  <files>src/booty/security/audit.py</files>
  <action>
6. run_dependency_audit(workspace_path: str | Path, config: SecurityConfig | None) -> AuditResult:
   - Resolve fail_severity from config.fail_severity if config else "high"
   - lockfiles = discover_lockfiles(Path(workspace_path))
   - Group by ecosystem for batching; run each audit via asyncio.to_thread or ThreadPoolExecutor (parallel)
   - Aggregate findings (cap 100), errors, summary_by_ecosystem
   - worst_severity = max found severity across all
   - ok = worst_severity not in ("high","critical") and not errors that indicate audit failure
   - If pyproject.toml/requirements present but no Python lockfile: still run pip-audit; add advisory to summary "No Python lockfile detected. Recommend adding poetry.lock/uv.lock."
   - Retry: on network/registry error retry 2x with exponential backoff before adding to errors
  </action>
  <verify>python -c "
from booty.security.audit import run_dependency_audit
from pathlib import Path
r = run_dependency_audit('.', None)
assert hasattr(r, 'ok') and hasattr(r, 'findings') and hasattr(r, 'errors')
print('OK')
"</verify>
  <done>run_dependency_audit orchestrates parallel audits and returns AuditResult.</done>
</task>

<task type="auto">
  <name>Task 4: Add audit tests</name>
  <files>tests/test_security_audit.py</files>
  <action>
Add tests:
1. discover_lockfiles in booty repo — should find pyproject.toml, possibly package-lock.json if present
2. discover_lockfiles deduplication — two identical files → one result
3. run_dependency_audit with missing tool (mock or isolated) — errors list includes clear message
4. run_dependency_audit in clean project — ok=True or minimal findings
5. Mock subprocess for pip-audit/npm audit JSON output — assert parsing and severity filter
  </action>
  <verify>pytest tests/test_security_audit.py -v</verify>
  <done>Audit tests pass.</done>
</task>

</tasks>

<verification>
- Lockfile detection matches CONTEXT patterns
- Deduplication by hash works
- fail_severity respected (high = fail on high/critical only)
- Tool missing produces clear error
- Parallel execution; no short-circuit
</verification>

<success_criteria>
- Audit module complete
- discover_lockfiles + run_dependency_audit
- AuditResult with findings, errors, worst_severity
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-dependency-vulnerability-gate/20-01-SUMMARY.md`
</output>
