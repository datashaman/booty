---
phase: 47-operator-visibility
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/operator/last_run.py
  - src/booty/cli.py
  - src/booty/verifier/runner.py
  - src/booty/security/runner.py
  - src/booty/reviewer/queue.py
  - src/booty/planner/worker.py
  - src/booty/architect/review.py
  - src/booty/main.py
autonomous: true

must_haves:
  truths:
    - booty status shows enabled, last_run_completed_at, queue_depth per agent
    - Builder and Reviewer included in status output
    - last_run_completed_at is ISO-8601 UTC or N/A
    - queue_depth is integer or N/A when unavailable
  artifacts:
    - path: src/booty/operator/last_run.py
      provides: record_agent_completed, get_last_run
    - path: src/booty/cli.py
      provides: extended status with new fields
  key_links:
    - from: verifier/runner, security/runner, reviewer, planner/worker, architect, main
      to: operator/last_run.py
      via: record_agent_completed on job completion
      pattern: record_agent_completed
    - from: cli.py status
      to: operator/last_run
      via: get_last_run
      pattern: get_last_run
---

<objective>
OPS-03: booty status CLI shows enabled agents, last_run_completed_at, queue_depth. Add Builder and Reviewer. Per 47-CONTEXT: key/value style, ISO-8601 UTC, N/A when unknown.

Purpose: Operator visibility of agent state. Queue depth N/A when status runs standalone (no app_state). Last-run from JSON store written by workers on completion.
Output: operator/last_run.py, CLI extended, workers wired.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-operator-visibility/47-CONTEXT.md
@.planning/phases/47-operator-visibility/47-RESEARCH.md
@src/booty/cli.py
@src/booty/architect/metrics.py
</context>

<tasks>

<task type="auto">
  <name>Create operator last_run store</name>
  <files>src/booty/operator/__init__.py</files>
  <files>src/booty/operator/last_run.py</files>
  <action>
Create src/booty/operator/ with __init__.py and last_run.py.
last_run.py:
1. Use booty.planner.store.get_planner_state_dir for base path; store at state_dir/operator/last_run.json.
2. Format: {"verifier": "2026-02-17T12:00:00Z", "security": "...", "reviewer": "...", "planner": "...", "architect": "...", "builder": "..."}. ISO-8601 UTC.
3. def record_agent_completed(agent: str) -> None: load JSON, update agent key with datetime.now(timezone.utc).isoformat(), save atomically (write to temp, os.replace). Thread-safe enough for single-process.
4. def get_last_run(agent: str) -> str | None: load JSON, return value or None.
5. Follow architect/metrics.py atomic write pattern.
</action>
  <verify>python -c "from booty.operator.last_run import record_agent_completed, get_last_run; record_agent_completed('test'); print(get_last_run('test')[:4])"</verify>
  <done>operator/last_run.py provides record_agent_completed and get_last_run</done>
</task>

<task type="auto">
  <name>Wire workers to record completion</name>
  <files>src/booty/verifier/runner.py</files>
  <files>src/booty/security/runner.py</files>
  <files>src/booty/reviewer/queue.py</files>
  <files>src/booty/planner/worker.py</files>
  <files>src/booty/architect/review.py</files>
  <files>src/booty/main.py</files>
  <action>
Call record_agent_completed(agent) when each agent finishes a job (success, failure, or cancelled).
- Verifier: In runner.py, after check completes (success/failure/cancelled). Find the final exit path before return.
- Security: In runner.py, after check completes.
- Reviewer: In reviewer queue worker completion path (reviewer/queue.py or runner—locate where job completes).
- Planner: In planner/worker.py when plan is stored (job complete).
- Architect: In architect/review.py when review completes (approved/rewritten/blocked).
- Builder: In main.py process_job, after job_completed_successfully or job_completed_with_failures or pipeline_exception return.
Use agent names: "verifier", "security", "reviewer", "planner", "architect", "builder".
</action>
  <verify>for f in src/booty/verifier/runner.py src/booty/security/runner.py src/booty/reviewer/queue.py src/booty/planner/worker.py src/booty/architect/review.py src/booty/main.py; do grep -q record_agent_completed "$f" || exit 1; done; echo ok</verify>
  <done>All six agents call record_agent_completed on completion</done>
</task>

<task type="auto">
  <name>Extend booty status CLI</name>
  <files>src/booty/cli.py</files>
  <action>
Extend status command per 47-CONTEXT:
1. Add Builder and Reviewer to agent list. Use builder_enabled (job_queue/config) and reviewer from config (existing reviewer_status pattern).
2. For each agent, output: enabled, last_run_completed_at, queue_depth.
3. last_run_completed_at: from get_last_run(agent) or "N/A" if None.
4. queue_depth: "N/A" (status runs standalone; no app_state—per RESEARCH).
5. Key-value format: agent_name.enabled, agent_name.last_run_completed_at, agent_name.queue_depth. Or flatten: verifier: enabled, verifier_last_run: ISO|N/A, verifier_queue_depth: N/A. Per CONTEXT "key/value style per agent" use sub-keys or separate lines. Example output:
   verifier: enabled
   verifier_last_run_completed_at: 2026-02-17T12:00:00Z
   verifier_queue_depth: N/A
   (repeat for security, planner, architect, governor, memory, builder, reviewer)
6. --json: include last_run_completed_at and queue_depth per agent in JSON object.
7. Preserve existing enabled logic for verifier, security, planner, architect, governor, memory. Add builder (planner+config), reviewer (from review config).
</action>
  <verify>booty status --json 2>/dev/null | python -c "import json,sys; d=json.load(sys.stdin); assert 'verifier' in d or 'last_run' in str(d)"</verify>
  <done>booty status shows all agents with last_run_completed_at and queue_depth</done>
</task>

</tasks>

<verification>
- OPS-03: booty status shows enabled agents, last run timestamps, queue depth
- Builder and Reviewer in output
- N/A when unknown
</verification>

<success_criteria>
- operator/last_run.py created
- Six agents wired to record completion
- status CLI extended with new fields
</success_criteria>

<output>
After completion, create `.planning/phases/47-operator-visibility/47-02-SUMMARY.md`
</output>
