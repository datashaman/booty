---
phase: 47-operator-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/router/router.py
  - src/booty/router/skip_reasons.py
autonomous: true

must_haves:
  truths:
    - Every router skip emits structured log with agent, repo, event_type, decision=skip, reason (five-bucket)
    - Operator-actionable skips (disabled, missing_config, normalize_failed) use INFO
    - High-volume skips (not_agent_pr, dedup_hit) use DEBUG
  artifacts:
    - path: src/booty/router/skip_reasons.py
      provides: reason-to-bucket mapping, INFO vs DEBUG selection
    - path: src/booty/router/router.py
      provides: event_skip calls using skip_reasons
  key_links:
    - from: router.py
      to: skip_reasons.py
      via: import _log_event_skip
      pattern: _log_event_skip|skip_reasons
---

<objective>
OPS-01, OPS-02: Structured skip logs with five-bucket vocabulary and INFO/DEBUG split.

Purpose: Operator visibility when router ignores events. Per 47-CONTEXT: INFO for disabled, missing_config, normalize_failed; DEBUG for not_agent_pr, dedup_hit, expected routing misses. Add decision=skip to all event_skip. Map all router reasons to five buckets.
Output: skip_reasons.py helper, router.py updated.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-operator-visibility/47-CONTEXT.md
@.planning/phases/47-operator-visibility/47-RESEARCH.md
@src/booty/router/router.py
</context>

<tasks>

<task type="auto">
  <name>Create skip_reasons helper</name>
  <files>src/booty/router/skip_reasons.py</files>
  <action>
Create skip_reasons.py with:
1. REASON_TO_BUCKET dict mapping all granular router reasons to five buckets: disabled, not_agent_pr, missing_config, dedup_hit, normalize_failed.
   Map: normalize_failed, unsupported_event->not_agent_pr, not_plan_or_builder_trigger->not_agent_pr, unhandled_action->not_agent_pr, all_pr_agents_disabled->disabled, governor_disabled->disabled, workflow_not_completed->not_agent_pr, workflow_not_matched->not_agent_pr, no_trigger_label->not_agent_pr. Add any other reasons found in router to appropriate bucket.
2. INFO_BUCKETS = frozenset({"disabled", "missing_config", "normalize_failed"}).
3. def _log_event_skip(agent, repo, event_type, reason, *, _reason_raw=None) that: computes bucket = REASON_TO_BUCKET.get(reason, "not_agent_pr"); uses logger.info if bucket in INFO_BUCKETS else logger.debug; calls with agent=, repo=, event_type=, decision="skip", reason=bucket, _reason_raw=reason or bucket.
4. Export _log_event_skip.
</action>
  <verify>python -c "from booty.router.skip_reasons import _log_event_skip; print('ok')"</verify>
  <done>skip_reasons module exports _log_event_skip with bucket mapping and INFO/DEBUG split</done>
</task>

<task type="auto">
  <name>Update router to use structured skip logging</name>
  <files>src/booty/router/router.py</files>
  <action>
Replace every logger.info("event_skip", ...) and any similar skip log in router.py with _log_event_skip(agent=..., repo=..., event_type=..., reason=...).
- Import _log_event_skip from booty.router.skip_reasons.
- For each event_skip site: pass agent (str or None), repo (str or None), event_type (str), reason (granular reason string).
- Add event_skip for dedup_hit cases: when verifier_queue.is_duplicate returns True, replace logger.info("verifier_already_processed") with _log_event_skip(agent="verifier", repo=internal.full_name, event_type="pull_request", reason="dedup_hit"). Similarly for reviewer and security when is_duplicate blocks enqueue (they don't currently logâ€”add _log_event_skip).
- Ensure planner_is_duplicate and architect_is_duplicate paths emit event_skip with reason=dedup_hit when applicable.
- Preserve all return values and control flow; only change logging.
</action>
  <verify>grep -c "_log_event_skip" src/booty/router/router.py | grep -q [1-9]</verify>
  <done>All router skip paths use _log_event_skip with decision=skip and five-bucket reason</done>
</task>

</tasks>

<verification>
- OPS-01: Every skip emits event_skip with agent, repo, event_type, decision=skip, reason
- OPS-02: Reasons map to disabled, not_agent_pr, missing_config, dedup_hit, normalize_failed
- CONTEXT: INFO for operator-actionable; DEBUG for high-volume
</verification>

<success_criteria>
- skip_reasons.py exists with _log_event_skip
- Router uses _log_event_skip for all skip paths
- dedup_hit covered for verifier, reviewer, security
</success_criteria>

<output>
After completion, create `.planning/phases/47-operator-visibility/47-01-SUMMARY.md`
</output>
