---
phase: 08-pull-request-webhook-verifier-runner
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/verifier/__init__.py
  - src/booty/verifier/job.py
  - src/booty/verifier/workspace.py
  - src/booty/verifier/runner.py
autonomous: true

must_haves:
  truths:
    - "VerifierJob can be created with PR context (owner, repo, pr_number, head_sha, installation_id)"
    - "Verifier clones repo at head_sha in clean temp dir and runs execute_tests()"
    - "Check run transitions: queued → in_progress → completed (success/failure)"
  artifacts:
    - path: src/booty/verifier/job.py
      provides: VerifierJob dataclass
      contains: "VerifierJob"
    - path: src/booty/verifier/workspace.py
      provides: prepare_verification_workspace context manager
      contains: "prepare_verification_workspace"
    - path: src/booty/verifier/runner.py
      provides: process_verifier_job async function
      contains: "process_verifier_job"
  key_links:
    - from: verifier/runner.py
      to: checks.py
      via: create_check_run, edit_check_run
      pattern: create_check_run|edit_check_run
    - from: verifier/runner.py
      to: test_runner
      via: load_booty_config, execute_tests
      pattern: load_booty_config|execute_tests
---

<objective>
Create Verifier runner: VerifierJob, prepare_verification_workspace, and process_verifier_job that clones PR head, loads .booty.yml, runs tests, and posts booty/verifier check run with lifecycle queued → in_progress → completed.

Purpose: VERIFY-03 — Verifier runs tests in clean env; foundation for PR-triggered verification.
Output: verifier/ module with job, workspace, runner; reusable by webhook (Plan 02).
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-pull-request-webhook-verifier-runner/08-RESEARCH.md
@.planning/phases/08-pull-request-webhook-verifier-runner/08-CONTEXT.md
@src/booty/github/checks.py
@src/booty/test_runner/executor.py
@src/booty/test_runner/config.py
@src/booty/repositories.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VerifierJob and prepare_verification_workspace</name>
  <files>src/booty/verifier/__init__.py, src/booty/verifier/job.py, src/booty/verifier/workspace.py</files>
  <action>
Create verifier module:

1. src/booty/verifier/job.py:
   - VerifierJob dataclass: job_id (str), owner (str), repo_name (str), pr_number (int), head_sha (str), head_ref (str), repo_url (str), installation_id (int), payload (dict), is_agent_pr (bool)
   - job_id format: f"verifier-{pr_number}-{head_sha[:7]}" for uniqueness

2. src/booty/verifier/workspace.py:
   - prepare_verification_workspace(repo_url: str, head_sha: str, github_token: str = "") -> AsyncContextManager[Workspace]
   - Clone repo into temp dir (tempfile.TemporaryDirectory, prefix="booty-verifier-")
   - Use git.Repo.clone_from with clone_url (inject token for HTTPS)
   - After clone: repo.git.fetch("origin", head_sha) then repo.git.checkout(head_sha)
   - For shallow clone: use depth=50 in clone_from; fetch may need --depth 1 for the ref
   - Alternative: clone branch if head_ref provided, or clone default then fetch and checkout head_sha
   - Yield Workspace(path=temp_dir.name, repo=repo, branch=head_sha)
   - Cleanup: repo.close(), temp_dir.cleanup() in finally
   - Reuse booty.logging.get_logger()

3. src/booty/verifier/__init__.py:
   - Export VerifierJob, prepare_verification_workspace
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.verifier import VerifierJob, prepare_verification_workspace
# VerifierJob fields
j = VerifierJob(job_id='v-1', owner='o', repo_name='r', pr_number=1, head_sha='abc123', head_ref='branch', repo_url='https://github.com/o/r', installation_id=1, payload={}, is_agent_pr=True)
assert j.pr_number == 1 and j.head_sha == 'abc123'
print('OK: VerifierJob and prepare_verification_workspace import')
"
  </verify>
  <done>VerifierJob dataclass and prepare_verification_workspace exist; verifier module imports.</done>
</task>

<task type="auto">
  <name>Task 2: Create process_verifier_job with check lifecycle</name>
  <files>src/booty/verifier/runner.py</files>
  <action>
Create src/booty/verifier/runner.py:

1. process_verifier_job(job: VerifierJob, settings: Settings) -> None (async)
   - If not verifier_enabled(settings): log and return
   - create_check_run(owner, repo_name, head_sha, installation_id, settings, status="queued") — store returned check_run
   - If check_run is None: return (Verifier disabled)
   - async with prepare_verification_workspace(repo_url, head_sha, settings.GITHUB_TOKEN) as workspace:
     - edit_check_run(check_run, status="in_progress", output={"title": "Booty Verifier", "summary": "Running tests..."})
     - config = load_booty_config(Path(workspace.path))
     - result = await execute_tests(config.test_command, config.timeout, Path(workspace.path))
     - tests_passed = result.exit_code == 0 and not result.timed_out
     - conclusion = "success" if tests_passed else "failure"
     - output_summary = f"Tests {'passed' if tests_passed else 'failed'} (exit={result.exit_code})" + (f". {result.stderr[:200]}" if not tests_passed else "")
     - edit_check_run(check_run, status="completed", conclusion=conclusion, output={"title": "Booty Verifier", "summary": output_summary})
   - Use try/except: on any exception, edit_check_run(conclusion="failure", output with error)
   - Log all transitions (check_created, check_in_progress, check_completed)

2. Do NOT post PR comment or call promote in this plan — Plan 03 handles that.
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.verifier.runner import process_verifier_job
import inspect
sig = inspect.signature(process_verifier_job)
params = list(sig.parameters)
assert 'job' in params and 'settings' in params
print('OK: process_verifier_job exists with correct signature')
"
  </verify>
  <done>process_verifier_job clones, runs tests, transitions check: queued → in_progress → completed.</done>
</task>

</tasks>

<verification>
- VerifierJob has required fields
- prepare_verification_workspace clones and checkouts head_sha
- process_verifier_job calls create_check_run, edit_check_run for lifecycle
- process_verifier_job uses load_booty_config and execute_tests
</verification>

<success_criteria>
- [ ] verifier/ module with job, workspace, runner
- [ ] Check run lifecycle: queued → in_progress → completed (success/failure)
- [ ] Tests run via execute_tests in clean workspace
</success_criteria>

<output>
After completion, create `.planning/phases/08-pull-request-webhook-verifier-runner/08-01-SUMMARY.md`
</output>
