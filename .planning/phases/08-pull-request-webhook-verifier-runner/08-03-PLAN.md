---
phase: 08-pull-request-webhook-verifier-runner
plan: 03
type: execute
wave: 2
depends_on: ["01", "02"]
files_modified:
  - src/booty/code_gen/generator.py
  - src/booty/github/pulls.py
  - src/booty/github/comments.py
  - src/booty/verifier/runner.py
autonomous: true

must_haves:
  truths:
    - "Builder adds agent:builder label to every PR it creates"
    - "Builder never promotes PRs — Verifier promotes agent PRs when check passes"
    - "Agent PR with Verifier failure gets PR comment (truncated output)"
    - "Agent PR with Verifier success gets promoted to ready-for-review"
  artifacts:
    - path: src/booty/github/pulls.py
      provides: add_agent_builder_label helper
      contains: "agent:builder|add_agent_builder"
    - path: src/booty/github/comments.py
      provides: post_verifier_failure_comment
      contains: "post_verifier_failure"
    - path: src/booty/code_gen/generator.py
      provides: Builder never promotes; adds agent:builder
  key_links:
    - from: generator.py
      to: pulls.py
      via: add_agent_builder_label after create_pull_request
      pattern: add_agent_builder|agent:builder
    - from: generator.py
      to: promotion
      via: should_promote = False always (Builder never promotes)
      pattern: should_promote|promote
    - from: verifier/runner.py
      to: comments.py
      via: post_verifier_failure_comment when agent PR and failure
      pattern: post_verifier_failure
    - from: verifier/runner.py
      to: promotion.py
      via: promote_to_ready_for_review when agent PR and success
      pattern: promote_to_ready
---

<objective>
Builder never promotes; add agent:builder label to PRs; Verifier promotes on success and posts comment on failure.

Purpose: VERIFY-04 (Builder skips promotion), VERIFY-05 (PR comment on failure).
Output: agent:builder label on all Builder PRs; Builder promotion removed; Verifier handles promotion and failure comment.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-pull-request-webhook-verifier-runner/08-CONTEXT.md
@src/booty/code_gen/generator.py
@src/booty/github/pulls.py
@src/booty/github/comments.py
@src/booty/github/promotion.py
@src/booty/verifier/runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent:builder label and remove Builder promotion</name>
  <files>src/booty/github/pulls.py, src/booty/code_gen/generator.py</files>
  <action>
1. In src/booty/github/pulls.py:
   - Add add_agent_builder_label(github_token: str, repo_url: str, pr_number: int, label: str = None) -> None
   - label defaults to settings.TRIGGER_LABEL — but fn takes (token, url, pr_number); get label from config or pass "agent:builder"
   - Use TRIGGER_LABEL from a passed setting or default "agent:builder" — simpler: add_agent_builder_label(..., label: str = "agent:builder")
   - Add label to PR (create if doesn't exist, like add_self_modification_metadata does for "self-modification")
   - Parse owner/repo from repo_url same as create_pull_request

2. In src/booty/code_gen/generator.py:
   - After create_pull_request and before add_self_modification_metadata (if that runs): call add_agent_builder_label for EVERY PR Builder creates
   - Use settings.TRIGGER_LABEL for the label name
   - Change promotion logic: Builder NEVER promotes. Remove the promote_to_ready_for_review call and the should_promote logic entirely. Set should_promote = False always, or simply delete the promotion block.
   - Per CONTEXT: "Builder never promotes agent PRs; Verifier promotes when it passes" — all Builder PRs are agent PRs, so Builder never promotes.
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.github.pulls import add_agent_builder_label
import inspect
assert 'add_agent_builder_label' in dir()
# generator should not call promote
with open('src/booty/code_gen/generator.py') as f:
    c = f.read()
assert 'add_agent_builder_label' in c
# Builder should not promote - either no promote call or should_promote always False
assert 'promote_to_ready_for_review' not in c or 'should_promote = False' in c or 'promote' not in c
print('OK: label and no-Builder-promotion')
"
  </verify>
  <done>Builder adds agent:builder to all PRs; Builder never promotes.</done>
</task>

<task type="auto">
  <name>Task 2: Verifier promotion and PR comment on failure</name>
  <files>src/booty/github/comments.py, src/booty/verifier/runner.py</files>
  <action>
1. In src/booty/github/comments.py:
   - Add post_verifier_failure_comment(github_token: str, repo_url: str, pr_number: int, summary: str, truncated_output: str) -> None
   - Post a single comment: "## Verifier Results\n\n{summary}\n\n```\n{truncated_output}\n```"
   - Per CONTEXT: "Update single Verifier results comment per PR (edit/replace, not append)"
   - To update: list issue comments, find one with "## Verifier Results" by current user/bot, edit it; else create new
   - Use PyGithub: repo.get_issue(pr_number).get_comments(); find comment body containing "Verifier Results"; edit with issue_comment.edit(body=...)
   - Truncate output to ~50 lines (CONTEXT: "last ~50 lines")

2. In src/booty/verifier/runner.py:
   - After edit_check_run(conclusion=...), if job.is_agent_pr:
     - If tests_passed: call promote_to_ready_for_review(settings.GITHUB_TOKEN, job.repo_url, job.pr_number)
     - If not tests_passed: call post_verifier_failure_comment(settings.GITHUB_TOKEN, job.repo_url, job.pr_number, output_summary, result.stderr[-50 lines])
   - Verifier needs GITHUB_TOKEN for promotion and comment — use settings.GITHUB_TOKEN (Builder path already has it)
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.github.comments import post_verifier_failure_comment
# Runner imports promotion and comment
with open('src/booty/verifier/runner.py') as f:
    c = f.read()
assert 'promote_to_ready_for_review' in c
assert 'post_verifier_failure_comment' in c
assert 'is_agent_pr' in c
print('OK: Verifier promotion and comment wiring')
"
  </verify>
  <done>Verifier promotes agent PRs on success; posts comment on failure.</done>
</task>

</tasks>

<verification>
- Builder adds agent:builder to all PRs
- Builder never calls promote_to_ready_for_review
- Verifier calls promote when agent PR and success
- Verifier calls post_verifier_failure_comment when agent PR and failure
</verification>

<success_criteria>
- [ ] agent:builder label on Builder PRs
- [ ] Builder promotion removed
- [ ] Verifier promotes on success (agent PR)
- [ ] Verifier posts comment on failure (agent PR)
</success_criteria>

<output>
After completion, create `.planning/phases/08-pull-request-webhook-verifier-runner/08-03-SUMMARY.md`
</output>
