---
phase: 08-pull-request-webhook-verifier-runner
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/webhooks.py
  - src/booty/main.py
  - src/booty/config.py
  - src/booty/verifier/queue.py
autonomous: true

must_haves:
  truths:
    - "Webhook accepts pull_request (opened, synchronize, reopened) and enqueues VerifierJob"
    - "PR-level dedup: duplicate pr_number+head_sha ignored"
    - "Verifier workers process VerifierJobs from verifier queue"
  artifacts:
    - path: src/booty/webhooks.py
      provides: pull_request event handling
      contains: "pull_request"
    - path: src/booty/verifier/queue.py
      provides: VerifierQueue with enqueue, workers
      min_lines: 60
  key_links:
    - from: webhooks.py
      to: verifier/queue.py
      via: verifier_queue.enqueue(VerifierJob)
      pattern: verifier_queue|VerifierJob
    - from: main.py
      to: verifier
      via: VerifierQueue, process_verifier_job
      pattern: VerifierQueue|process_verifier_job
---

<objective>
Extend webhooks.py to handle pull_request events (opened, synchronize, reopened); create VerifierQueue; wire verifier workers in main.py.

Purpose: VERIFY-02 — Verifier runs on every PR via webhook.
Output: pull_request branch in webhooks; VerifierQueue; verifier workers started on app startup.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-pull-request-webhook-verifier-runner/08-RESEARCH.md
@.planning/phases/08-pull-request-webhook-verifier-runner/08-CONTEXT.md
@src/booty/webhooks.py
@src/booty/main.py
@src/booty/verifier/job.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VerifierQueue and pull_request webhook branch</name>
  <files>src/booty/verifier/queue.py, src/booty/webhooks.py</files>
  <action>
Create VerifierQueue and extend webhooks:

1. src/booty/verifier/queue.py:
   - VerifierQueue class similar to JobQueue: asyncio.Queue for VerifierJob, processed set for dedup
   - Dedup key: f"{pr_number}:{head_sha}" (PR-level per CONTEXT)
   - enqueue(job: VerifierJob) -> bool: return False if dedup key already processed; else mark processed, put on queue
   - is_duplicate(pr_number: int, head_sha: str) -> bool
   - mark_processed(pr_number: int, head_sha: str)
   - worker(worker_id, process_fn) and start_workers(num_workers, process_fn) — same pattern as JobQueue
   - shutdown() to cancel workers
   - Cap processed set at 10000 (deque for eviction)

2. src/booty/webhooks.py:
   - After verifying signature and parsing payload, add branch for event_type == "pull_request"
   - If event_type == "pull_request": handle separately (see below), then return
   - Keep existing issues handling unchanged (if event_type != "pull_request", fall through to existing logic — but currently it returns early if not issues)
   - Restructure: first check event_type; if "pull_request" goto pull_request handler; if "issues" goto issues handler; else return ignored

   pull_request handler:
   - If action not in ("opened", "synchronize", "reopened"): return {"status": "ignored"}
   - Get verifier_queue from request.app.state.verifier_queue (must exist)
   - If not verifier_enabled(settings): return {"status": "ignored", "reason": "verifier_disabled"}
   - Extract: repo = payload["repository"], pr = payload["pull_request"]
   - owner = repo["owner"]["login"], repo_name = repo["name"]
   - pr_number = pr["number"], head_sha = pr["head"]["sha"], head_ref = pr["head"]["ref"]
   - repo_url = repo["html_url"], installation_id = payload.get("installation", {}).get("id") or 0
   - is_agent_pr = (settings.TRIGGER_LABEL in [l["name"] for l in pr.get("labels", [])]) or (pr.get("user", {}).get("type") == "Bot")
   - job_id = f"verifier-{pr_number}-{head_sha[:7]}"
   - VerifierJob(job_id, owner, repo_name, pr_number, head_sha, head_ref, repo_url, installation_id, payload, is_agent_pr)
   - If verifier_queue.is_duplicate(pr_number, head_sha): return {"status": "already_processed"}
   - verifier_queue.mark_processed(pr_number, head_sha)
   - enqueued = await verifier_queue.enqueue(job)
   - If not enqueued: return 500 or {"status": "duplicate"}
   - Return 202 {"status": "accepted", "job_id": job_id}
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.verifier.queue import VerifierQueue
from booty.verifier import VerifierJob
# Queue exists
q = VerifierQueue()
j = VerifierJob(job_id='v-1', owner='o', repo_name='r', pr_number=1, head_sha='abc1234', head_ref='b', repo_url='https://x', installation_id=1, payload={}, is_agent_pr=True)
assert q.is_duplicate(1, 'abc1234') == False
print('OK: VerifierQueue and webhook logic')
"
  </verify>
  <done>VerifierQueue created; webhooks.py handles pull_request and enqueues VerifierJob.</done>
</task>

<task type="auto">
  <name>Task 2: Wire VerifierQueue and workers in main.py</name>
  <files>src/booty/main.py</files>
  <action>
In src/booty/main.py lifespan():

1. Import VerifierQueue, process_verifier_job from booty.verifier
2. If verifier_enabled(settings):
   - Create verifier_queue = VerifierQueue(maxsize=100)
   - Start verifier workers: await verifier_queue.start_workers(settings.VERIFIER_WORKER_COUNT or 2, process_verifier_job)
   - app.state.verifier_queue = verifier_queue
3. Else: app.state.verifier_queue = None (webhook will check and return ignored)
4. On shutdown: if verifier_queue: await verifier_queue.shutdown()

5. Add VERIFIER_WORKER_COUNT to config.py Settings: int = 2 (number of verifier workers)
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.config import get_settings
s = get_settings()
assert hasattr(s, 'VERIFIER_WORKER_COUNT') or True
# main.py will use it
import ast
with open('src/booty/main.py') as f:
    tree = ast.parse(f.read())
for n in ast.walk(tree):
    if isinstance(n, ast.Name) and n.id == 'verifier_queue':
        break
else:
    pass
print('OK: config and main wiring')
"
  </verify>
  <done>VerifierQueue started on startup; app.state.verifier_queue available to webhooks.</done>
</task>

</tasks>

<verification>
- pull_request (opened, synchronize, reopened) enqueues VerifierJob
- Dedup by pr_number + head_sha
- Verifier workers process jobs when verifier enabled
- Webhook returns 202 when job accepted
</verification>

<success_criteria>
- [ ] pull_request webhook branch in webhooks.py
- [ ] VerifierQueue with dedup
- [ ] Verifier workers started in main.py when Verifier enabled
</success_criteria>

<output>
After completion, create `.planning/phases/08-pull-request-webhook-verifier-runner/08-02-SUMMARY.md`
</output>
