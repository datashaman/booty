---
phase: 36-builder-handoff-cli
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/architect/metrics.py
  - src/booty/main.py
autonomous: true

must_haves:
  truths:
    - Architect emits metrics: plans_reviewed, plans_rewritten, architect_blocks, cache_hits
    - Metrics persisted under ~/.booty/state/architect/ with rolling 24h
    - Status command can read breakdown from persisted metrics
  artifacts:
    - path: src/booty/architect/metrics.py
      provides: increment_reviewed, increment_rewritten, increment_blocked, increment_cache_hit, get_24h_stats
  key_links:
    - from: main.py _planner_worker_loop
      to: architect metrics
      via: call increment_* at approve/rewrite/block/cache_hit
      pattern: increment_
---

<objective>
Architect metrics: plans_reviewed, plans_rewritten, architect_blocks, cache_hits.

Purpose: ARCH-33 — Architect emits metrics; persisted under ~/.booty/state/architect/; rolling 24h window. CONTEXT: both structured logs + metrics; status includes approved/rewritten/blocked/cache_hits breakdown.
Output: architect/metrics.py with increment + get_24h_stats; main.py calls increment at appropriate points.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-builder-handoff-cli/36-CONTEXT.md
@.planning/phases/36-builder-handoff-cli/36-RESEARCH.md
@src/booty/main.py
@src/booty/release_governor/store.py
</context>

<tasks>

<task type="auto">
  <name>Create architect/metrics.py with persist and increment</name>
  <files>src/booty/architect/metrics.py</files>
  <action>
Create src/booty/architect/metrics.py.
- get_architect_metrics_dir(state_dir=None) -> Path: state_dir/architect or get_planner_state_dir()/architect.
- Persist to architect/metrics.json (or events.jsonl for rolling append). Per CONTEXT: "counters and small rolling window store so status survives restarts". Use JSON object: { "events": [ { "ts": iso, "type": "reviewed"|"rewritten"|"blocked"|"cache_hit" }, ... ] } with max N events or prune events older than 24h on each read.
- increment_reviewed(), increment_rewritten(), increment_blocked(), increment_cache_hit() — append event with datetime.now(timezone.utc).isoformat() and type. Thread-safe optional; single-threaded worker is fine.
- get_24h_stats(state_dir=None) -> dict: {"approved": N, "rewritten": N, "blocked": N, "cache_hits": N} for events within last 24h. Rolling window: now - 24h. Filter events by ts.
</action>
  <verify>python -c "from booty.architect.metrics import increment_reviewed, get_24h_stats; increment_reviewed(); s = get_24h_stats(); assert 'approved' in s"</verify>
  <done>Metrics module exists; increment and get_24h_stats work; events persist across restarts</done>
</task>

<task type="auto">
  <name>Wire metrics increment in main.py</name>
  <files>src/booty/main.py</files>
  <action>
In _planner_worker_loop, call increment at:
1. Architect cache hit + approved: increment_cache_hit()
2. Architect cache hit + blocked: increment_cache_hit() — no, blocked cache hit means we're reusing a prior block. Actually cache hit can be approved or blocked. For approved cache hit: increment_cache_hit. For blocked cache hit: increment_cache_hit (we're reusing cached block). So both: increment_cache_hit only (cache hit = we didn't run Architect).
3. Architect fresh approved (no rewrite): increment_reviewed() — when notes don't have "ambiguous" or "overreach"
4. Architect fresh approved (rewritten): increment_rewritten()
5. Architect fresh blocked: increment_blocked()
Import and call from booty.architect.metrics.
</action>
  <verify>grep -n "increment_reviewed\|increment_rewritten\|increment_blocked\|increment_cache_hit" src/booty/main.py</verify>
  <done>All four outcomes (approved/rewritten/blocked/cache_hit) increment correct metric</done>
</task>

</tasks>

<verification>
- architect/metrics.py: increment_* and get_24h_stats
- main.py: 4 increment call sites
- Rolling 24h from now (not calendar day)
</verification>

<success_criteria>
- ARCH-33: Metrics plans_reviewed, plans_rewritten, architect_blocks, cache_hits
- Persisted; status can read
</success_criteria>

<output>
After completion, create `.planning/phases/36-builder-handoff-cli/36-03-SUMMARY.md`
</output>
