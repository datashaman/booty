---
phase: 17-cli-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/cli.py
  - src/booty/release_governor/risk.py
  - src/booty/release_governor/handler.py
autonomous: true

must_haves:
  truths:
    - "booty governor simulate --sha <sha> runs decision dry-run (no deploy)"
    - "booty governor trigger --sha <sha> dispatches deploy when ALLOW; exits 1 on HOLD"
    - "On HOLD: CLI prints decision, reason, unblock hint; no status/issue"
    - "GITHUB_TOKEN required for simulate and trigger; fail with clear message when missing"
    - "status, simulate, trigger support --json for machine-readable output"
  artifacts:
    - path: src/booty/cli.py
      provides: governor simulate, governor trigger, --json for status
    - path: src/booty/release_governor/risk.py
      provides: optional risk paths (or new helper for simulate --show-paths)
  key_links:
    - from: cli.py governor simulate
      to: handler/decision/risk
      via: shared decision logic (extract or reuse)
    - from: cli.py governor trigger
      to: release_governor.deploy.dispatch_deploy
      via: call when decision ALLOW
---

<objective>
Governor CLI: simulate, trigger, and --json (GOV-32).

Add `booty governor simulate [--sha] <sha>` — dry-run decision, no deploy. Add `booty governor trigger [--sha] <sha>` — manual deploy when ALLOW; on HOLD exit 1 with unblock hint. Add `--json` to status, simulate, trigger for machine-readable output.

Purpose: Operators can test decisions and manually trigger deploys without webhook. Output style: key/value lines (per 17-CONTEXT); optional --show-paths for simulate when risk paths desired.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-cli-documentation/17-CONTEXT.md
@.planning/phases/17-cli-documentation/17-RESEARCH.md
@src/booty/cli.py
@src/booty/release_governor/handler.py
@src/booty/release_governor/decision.py
@src/booty/release_governor/risk.py
@src/booty/release_governor/deploy.py
@src/booty/release_governor/store.py
@src/booty/test_runner/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add simulate_decision helper for CLI</name>
  <files>src/booty/release_governor/handler.py or new cli_simulate.py</files>
  <action>
Create a reusable function for CLI simulate/trigger that:
- Accepts: repo (owner/repo), head_sha, config, workspace Path
- Loads state from get_state_dir(); gets production_sha from state
- Uses Github(get_settings().GITHUB_TOKEN) — raise/exit with clear message if GITHUB_TOKEN missing
- Calls gh_repo.compare(production_sha, head_sha)
- Calls compute_risk_class(comparison, config)
- Builds approval_context: env_approved from RELEASE_GOVERNOR_APPROVED; label_approved/comment_approved=False for CLI
- Calls compute_decision(...)
- Returns (Decision, risk_class, optionally paths if needed)

Prefer adding to handler.py as `simulate_decision_for_cli(repo: str, head_sha: str, config, workspace: Path) -> tuple[Decision, ...]` or similar. If paths needed for --show-paths, extend risk.py with `get_risk_paths(comparison, config) -> list[str]` that returns filenames matching high/medium risk.
</action>
  <verify>python -c "from booty.release_governor.handler import simulate_decision_for_cli; print('OK')" 2>/dev/null || python -c "from booty.release_governor import *; print('OK')"</verify>
  <done>simulate_decision_for_cli or equivalent exists; CLI can compute decision without webhook payload</done>
</task>

<task type="auto">
  <name>Task 2: Add governor simulate command</name>
  <files>src/booty/cli.py</files>
  <action>
Add @governor.command("simulate") with:
- Option --sha and optional positional sha (e.g. booty governor simulate abc123 or booty governor simulate --sha abc123)
- Option --repo (optional; infer from git remote when in repo cwd)
- Option --show-paths (include paths that drove risk in output)
- Option --json (machine-readable)
- Option --workspace (default cwd)
- Load config from load_booty_config(workspace); check is_governor_enabled
- Require GITHUB_TOKEN; exit with "GITHUB_TOKEN required for simulate; set it to fetch diff" if missing
- Call simulate_decision_for_cli; output key/value: decision, risk_class, reason, sha; on HOLD add unblock_hint per approval mode; if --show-paths add paths section
</action>
  <verify>booty governor simulate --help</verify>
  <done>booty governor simulate exists; outputs decision; fails clearly when GITHUB_TOKEN missing</done>
</task>

<task type="auto">
  <name>Task 3: Add governor trigger command</name>
  <files>src/booty/cli.py</files>
  <action>
Add @governor.command("trigger") with same options as simulate (--sha, positional, --repo, --workspace, --json).
- Call simulate_decision_for_cli first
- If HOLD: print decision, reason, unblock hint (bullet list per 17-CONTEXT); exit 1
- If ALLOW: get gh_repo from config/repo; call dispatch_deploy(gh_repo, config, head_sha); update release state (last_deploy_attempt_sha, last_deploy_time, last_deploy_result=pending); append_deploy_to_history; print success (SHA, timestamp, Actions URL)
- No --force; trigger always respects approval
</action>
  <verify>booty governor trigger --help</verify>
  <done>booty governor trigger exists; exits 1 on HOLD; dispatches on ALLOW</done>
</task>

<task type="auto">
  <name>Task 4: Add --json to governor status</name>
  <files>src/booty/cli.py</files>
  <action>
Add --json option to governor status. When set, output ReleaseState (or equivalent) as JSON. Ensure status still works without --json (existing human-readable output).
</action>
  <verify>booty governor status --json 2>/dev/null | head -1</verify>
  <done>governor status supports --json</done>
</task>

</tasks>

<verification>
- [ ] booty governor simulate <sha> outputs decision (HOLD/ALLOW), risk_class, reason
- [ ] booty governor simulate fails with clear message when GITHUB_TOKEN missing
- [ ] booty governor trigger exits 1 on HOLD; prints unblock hint
- [ ] booty governor trigger dispatches deploy on ALLOW
- [ ] governor status, simulate, trigger support --json
</verification>

<success_criteria>
- simulate: dry-run decision; no deploy
- trigger: respects approval; no --force
- --json on all three commands
- Repo inference from cwd when --repo not given
</success_criteria>

<output>
After completion, create .planning/phases/17-cli-documentation/17-01-SUMMARY.md
</output>
