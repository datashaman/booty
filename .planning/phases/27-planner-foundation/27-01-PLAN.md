---
phase: 27-planner-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/planner/__init__.py
  - src/booty/planner/schema.py
  - src/booty/planner/store.py
  - tests/test_planner_schema.py
autonomous: true

must_haves:
  truths:
    - Plan JSON validates against schema (plan_version, goal, steps, risk_level, touch_paths, handoff_to_builder)
    - Plans store to correct paths (issue: plans/<owner>/<repo>/<issue>.json, ad-hoc: plans/ad-hoc-<ts>-<hash>.json)
    - State dir created automatically (PLANNER_STATE_DIR or $HOME/.booty/state)
  artifacts:
    - path: src/booty/planner/schema.py
      provides: Plan schema (Pydantic), Step, HandoffToBuilder
    - path: src/booty/planner/store.py
      provides: get_planner_state_dir, plan_path_for_issue, plan_path_for_ad_hoc, save_plan
  key_links:
    - from: schema.py
      to: store.save_plan
      via: model_dump() before JSON write
      pattern: Plan\.model_validate|\.model_dump
---

<objective>
Create Plan JSON schema (Pydantic) and storage plumbing for Planner Agent.

Purpose: Schema validates plans; store provides path resolution and atomic write. Required by webhook worker and CLI.
Output: src/booty/planner/ with schema.py, store.py; tests for validation and path logic.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-planner-foundation/27-CONTEXT.md
@.planning/phases/27-planner-foundation/27-RESEARCH.md
@src/booty/memory/store.py
@src/booty/release_governor/store.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plan schema (Pydantic)</name>
  <files>src/booty/planner/__init__.py, src/booty/planner/schema.py</files>
  <action>
Create src/booty/planner/ package with __init__.py and schema.py.

In schema.py define Pydantic models:
1. **Step**: id (Literal["P1".."P12"] or str matching P\d+), action (Literal["read","edit","add","run","verify"]), path (str | None), command (str | None), acceptance (str, required)
2. **HandoffToBuilder**: branch_name_hint, commit_message_hint, pr_title, pr_body_outline (all required str)
3. **Plan**: plan_version (Literal["1"]), goal (str), steps (list[Step], max 12), risk_level (Literal["LOW","MEDIUM","HIGH"]), touch_paths (list[str]), handoff_to_builder (HandoffToBuilder). Optional stubs: assumptions, constraints, tests, rollback (default empty list or sensible default). Use model_config = ConfigDict(extra="forbid") on Plan.

Export Plan, Step, HandoffToBuilder from __init__.py.
  </action>
  <verify>python -c "
from booty.planner import Plan, Step, HandoffToBuilder
p = Plan(plan_version='1', goal='Add login', steps=[Step(id='P1', action='add', path='src/auth.py', command=None, acceptance='File exists')], risk_level='LOW', touch_paths=['src/auth.py'], handoff_to_builder=HandoffToBuilder(branch_name_hint='feat/login', commit_message_hint='Add login', pr_title='Add login', pr_body_outline='Implements auth'))
assert p.plan_version == '1'
assert len(p.steps) == 1
"</verify>
  <done>Plan.model_validate(dict) and Plan.model_dump() work; plan_version fixed "1"; steps max 12; Step.action enum</done>
</task>

<task type="auto">
  <name>Task 2: Planner store and paths</name>
  <files>src/booty/planner/store.py</files>
  <action>
Create store.py with:

1. get_planner_state_dir() -> Path: Precedence PLANNER_STATE_DIR env > $HOME/.booty/state > ./.booty/state. mkdir(parents=True, exist_ok=True). Mirror get_memory_state_dir from memory/store.py.

2. plan_path_for_issue(owner: str, repo: str, issue_number: int, state_dir: Path | None = None) -> Path: Return state_dir/plans/owner/repo/{issue_number}.json. state_dir defaults to get_planner_state_dir(). Create parent dirs in save_plan, not here.

3. plan_path_for_ad_hoc(text: str, state_dir: Path | None = None) -> Path: Timestamp ISO format (compact, no colons: 20260216143022). Short hash: first 8 chars of hashlib.sha256(text.encode()).hexdigest(). Return state_dir/plans/ad-hoc-{timestamp}-{short_hash}.json.

4. save_plan(plan: Plan | dict, path: Path) -> None: If Plan instance, plan.model_dump(). Write JSON via atomic pattern (temp file, fsync, rename) from release_governor/store._atomic_write_json.
  </action>
  <verify>python -c "
from pathlib import Path
from booty.planner.store import get_planner_state_dir, plan_path_for_issue, plan_path_for_ad_hoc
import tempfile
with tempfile.TemporaryDirectory() as d:
    import os
    os.environ['PLANNER_STATE_DIR'] = d
    sd = get_planner_state_dir()
    assert str(sd) == d
    p1 = plan_path_for_issue('owner','repo',123, sd)
    assert 'plans/owner/repo/123.json' in str(p1)
    p2 = plan_path_for_ad_hoc('hello', sd)
    assert 'ad-hoc-' in str(p2) and '.json' in str(p2)
"</verify>
  <done>get_planner_state_dir, plan_path_for_issue, plan_path_for_ad_hoc, save_plan work; paths match CONTEXT layout</done>
</task>

<task type="auto">
  <name>Task 3: Schema and store tests</name>
  <files>tests/test_planner_schema.py</files>
  <action>
Add tests: (1) Plan validation accepts valid dict, rejects invalid plan_version; (2) Plan rejects >12 steps; (3) Step rejects invalid action; (4) get_planner_state_dir uses PLANNER_STATE_DIR; (5) plan_path_for_issue produces correct nested path; (6) plan_path_for_ad_hoc produces ad-hoc path; (7) save_plan writes valid JSON, readable back.
  </action>
  <verify>pytest tests/test_planner_schema.py -v</verify>
  <done>All planner schema and store tests pass</done>
</task>

</tasks>

<verification>
- pytest tests/test_planner_schema.py passes
- python -c "from booty.planner import Plan; from booty.planner.store import save_plan, plan_path_for_issue; ..." runs without error
</verification>

<success_criteria>
- Plan schema validates plan_version, goal, steps, risk_level, touch_paths, handoff_to_builder
- Storage paths match CONTEXT (issue: nested owner/repo; ad-hoc: timestamp-hash)
- save_plan uses atomic write
</success_criteria>

<output>
After completion, create .planning/phases/27-planner-foundation/27-01-SUMMARY.md
</output>
