---
phase: 40-promotion-gating
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/github/checks.py
  - src/booty/verifier/runner.py
  - tests/test_github_checks.py
autonomous: true

must_haves:
  truths:
    - "Agent PR is promoted only when booty/verifier success AND (Reviewer disabled OR booty/reviewer success)"
    - "When Reviewer enabled and booty/reviewer not yet success, Verifier exits with check success but does NOT promote"
    - "Non-agent PRs unchanged; fail-open success (Phase 41) counts as success"
  artifacts:
    - path: src/booty/github/checks.py
      provides: reviewer_check_success helper
      contains: "reviewer_check_success|get_check_runs"
    - path: src/booty/verifier/runner.py
      provides: Promotion gate using reviewer check
  key_links:
    - from: verifier/runner.py
      to: github/checks.py
      via: reviewer_check_success
      pattern: reviewer_check_success
    - from: verifier/runner.py
      to: reviewer/config.py
      via: get_reviewer_config, apply_reviewer_env_overrides
      pattern: get_reviewer_config|apply_reviewer_env_overrides
---

<objective>
Gate Verifier promotion on booty/reviewer success when Reviewer is enabled. Agent PRs require both booty/reviewer and booty/verifier success before promotion. Reviewer-disabled repos keep Verifier-only gate.

Purpose: REV-14 — Builder promotion requires booty/reviewer success AND booty/verifier success for agent PRs.
Output: reviewer_check_success helper in checks.py; Verifier promotion logic updated.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-promotion-gating/40-CONTEXT.md
@.planning/phases/40-promotion-gating/40-RESEARCH.md
@src/booty/verifier/runner.py
@src/booty/github/checks.py
@src/booty/reviewer/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reviewer_check_success helper</name>
  <files>src/booty/github/checks.py</files>
  <action>
Add `reviewer_check_success(repo, head_sha: str) -> bool` to checks.py.

Behavior:
- Call repo.get_check_runs(head_sha=head_sha, check_name="booty/reviewer")
- Return True if any run has status=="completed" and conclusion=="success"
- Return False if no such run, or on any exception (fail closed)
- Use the Repository type from get_verifier_repo (PyGithub)

Add export in github/__init__.py if this module is part of public API.
  </action>
  <verify>grep -n "reviewer_check_success\|get_check_runs" src/booty/github/checks.py</verify>
  <done>reviewer_check_success exists, returns True only when booty/reviewer is completed with conclusion success.</done>
</task>

<task type="auto">
  <name>Task 2: Gate Verifier promotion on reviewer when enabled</name>
  <files>src/booty/verifier/runner.py</files>
  <action>
In process_verifier_job, before calling promote_to_ready_for_review when agent PR and tests_passed:

1. Import: get_reviewer_config, apply_reviewer_env_overrides from booty.reviewer.config; reviewer_check_success from booty.github.checks

2. Determine reviewer_enabled:
   - rc = get_reviewer_config(config)
   - If rc is None: reviewer_enabled = False
   - Else: rc = apply_reviewer_env_overrides(rc); reviewer_enabled = rc.enabled
   - Wrap in try/except ReviewerConfigError: on error, reviewer_enabled = False

3. If reviewer_enabled and repo is not None:
   - Call can_promote = reviewer_check_success(repo, job.head_sha)
   - If not can_promote: do NOT promote; skip the promote block; Verifier check stays success, PR stays draft
   - Log "promotion_waiting_reviewer" when tests_passed but can_promote is False

4. If not reviewer_enabled: promote as today (tests_passed → promote)
5. If reviewer_enabled and can_promote: promote as today

Keep all other behavior: post_verifier_failure_comment on tests_passed=False, _enqueue_builder_retry, etc.
  </action>
  <verify>python -c "
from booty.verifier.runner import process_verifier_job
import inspect
s = inspect.getsource(process_verifier_job)
assert 'reviewer_check_success' in s or 'get_reviewer_config' in s
assert 'promotion_waiting_reviewer' in s or 'can_promote' in s
print('OK: Promotion gate wired')
"</verify>
  <done>Verifier promotes only when tests pass and (reviewer disabled OR reviewer check success).</done>
</task>

<task type="auto">
  <name>Task 3: Add test for reviewer_check_success</name>
  <files>tests/test_github_checks.py</files>
  <action>
Add test_reviewer_check_success_* tests:

1. test_reviewer_check_success_true: Mock repo.get_check_runs to return one CheckRun with status="completed", conclusion="success" → reviewer_check_success returns True

2. test_reviewer_check_success_false_no_runs: get_check_runs returns empty → returns False

3. test_reviewer_check_success_false_not_completed: get_check_runs returns run with status="in_progress" → returns False

4. test_reviewer_check_success_false_failure: get_check_runs returns run with conclusion="failure" → returns False

5. test_reviewer_check_success_exception: get_check_runs raises → returns False (fail closed)

Follow existing test patterns in test_github_checks.py (pytest, mocks).
  </action>
  <verify>pytest tests/test_github_checks.py -v -k reviewer_check_success</verify>
  <done>Tests cover success, no runs, in_progress, failure, exception cases.</done>
</task>

</tasks>

<verification>
- reviewer_check_success returns True only for completed + conclusion success
- Verifier promotion blocked when reviewer enabled and reviewer check not success
- Non-agent PRs unchanged
- Reviewer-disabled: promote on tests_passed (current behavior)
</verification>

<success_criteria>
- [ ] reviewer_check_success in checks.py
- [ ] Verifier promotion gate implemented
- [ ] Tests pass
- [ ] REV-14 satisfied: Builder (via Verifier) requires both checks for agent PRs
</success_criteria>

<output>
After completion, create `.planning/phases/40-promotion-gating/40-01-SUMMARY.md`
</output>
