---
phase: 06-pr-promotion
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/booty/code_gen/generator.py
autonomous: true

must_haves:
  truths:
    - "Quality checks run for ALL jobs before promotion decision"
    - "Draft PR promoted when tests pass, linting clean, and not self-modification"
    - "Self-modification PRs always remain draft"
  artifacts:
    - path: src/booty/code_gen/generator.py
      provides: promotion logic after PR creation
    - path: src/booty/test_runner/quality.py
      provides: run_quality_checks (existing; generator will call it for all jobs)
  key_links:
    - from: generator.py
      to: promotion.py
      via: promote_to_ready_for_review, post_promotion_failure_comment
      pattern: promote_to_ready|post_promotion_failure
    - from: generator.py
      to: quality.py
      via: run_quality_checks for all jobs
      pattern: run_quality_checks
---

<objective>
Wire promotion into the pipeline: run quality checks for all jobs, always create PRs as draft when they are promotion candidates, and call promotion (or post failure comment) after PR creation.

Purpose: PRMO-01, PRMO-03 — multi-criteria validation; promotion when tests+lint pass and not self-mod.
Output: Updated generator.py with promotion flow; quality checks run for all jobs.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-pr-promotion/06-RESEARCH.md
@.planning/phases/06-pr-promotion/06-CONTEXT.md
@src/booty/code_gen/generator.py
@src/booty/test_runner/quality.py
@src/booty/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run quality checks for all jobs</name>
  <files>src/booty/code_gen/generator.py</files>
  <action>
Move quality checks from self-modification-only to ALL jobs:

1. Remove the `if is_self_modification:` guard around `run_quality_checks`
2. Run `quality_result = await run_quality_checks(workspace_path)` for every job (after refinement, before commit)
3. If quality_result.passed is False:
   - Append quality errors to error_message (same pattern as current self-mod block)
   - Set tests_passed = False
4. Update the pipeline docstring: "10b: Run quality checks (ruff)" — remove "self-modification" qualifier
5. Keep the logic that merges quality errors into error_message when not passed
</action>
  <verify>
grep -n "run_quality_checks" src/booty/code_gen/generator.py
# Should show call is NOT inside "if is_self_modification"
  </verify>
  <done>Quality checks run for all jobs; failures set tests_passed=False and append to error_message.</done>
</task>

<task type="auto">
  <name>Task 2: Always create draft PRs, then promote when criteria met</name>
  <files>src/booty/code_gen/generator.py</files>
  <action>
Change PR creation and add promotion step:

1. PR creation: Always create as draft (is_draft = True). Promotion happens after creation when criteria are met.

2. After create_pull_request and add_self_modification_metadata (if applicable):
   - Define should_promote = tests_passed and quality_passed and not is_self_modification
   - quality_passed: use quality_result.passed (ensure quality_result is in scope — it's set for all jobs now)
   - If should_promote:
     - try: promote_to_ready_for_review(...)
     - except Exception: post_promotion_failure_comment(..., reason=str(e), attempts=3)
       - Log warning "promotion_failed_posting_comment" or similar
   - If not should_promote: no-op (PR stays draft)

3. Import promote_to_ready_for_review and post_promotion_failure_comment from booty.github.promotion and booty.github.comments
</action>
  <verify>
grep -n "promote_to_ready_for_review\|post_promotion_failure_comment\|should_promote" src/booty/code_gen/generator.py
pytest
  </verify>
  <done>PRs created as draft; promotion called when tests+lint pass and not self-mod; failure comment on exception.</done>
</task>

</tasks>

<verification>
- pytest passes
- ruff check passes on modified files
- Manual: run a job with passing tests+lint, non-self-mod — PR should be promoted (requires real token)
</verification>

<success_criteria>
- Quality checks run for all jobs
- Draft PR promoted when tests passed, quality passed, not self-modification
- Promotion failure posts comment, leaves PR draft
- Self-modification PRs never promoted
</success_criteria>

<output>
After completion, create `.planning/phases/06-pr-promotion/06-02-SUMMARY.md`
</output>
