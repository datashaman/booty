---
phase: 06-pr-promotion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/github/promotion.py
  - src/booty/github/comments.py
autonomous: true

must_haves:
  truths:
    - "Draft PR is promoted to ready-for-review when promotion criteria are met"
    - "Promotion failures are logged; PR stays draft; optional comment posted"
    - "Retry with backoff on 5xx/network; no retry on 4xx"
  artifacts:
    - path: src/booty/github/promotion.py
      provides: promote_to_ready_for_review with tenacity retry
      min_lines: 80
    - path: src/booty/github/comments.py
      provides: post_promotion_failure_comment (neutral, no Booty branding)
  key_links:
    - from: promotion.py
      to: PyGithub PullRequest
      via: pr.mark_ready_for_review()
      pattern: mark_ready_for_review
    - from: promotion.py
      to: tenacity
      via: retry_if_exception predicate (5xx only)
      pattern: tenacity|retry
---

<objective>
Implement the PR promotion module: promote draft PRs to ready-for-review with retry logic, and post a neutral failure comment when promotion fails after retries.

Purpose: PRMO-01, PRMO-02 — draft PRs promoted when validation passes; failures handled gracefully.
Output: promotion.py with promote_to_ready_for_review(); comments.py with post_promotion_failure_comment().
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-pr-promotion/06-RESEARCH.md
@.planning/phases/06-pr-promotion/06-CONTEXT.md
@src/booty/github/pulls.py
@src/booty/github/comments.py
@src/booty/llm/prompts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create promotion module with promote_to_ready_for_review</name>
  <files>src/booty/github/promotion.py</files>
  <action>
Create `src/booty/github/promotion.py` with:

1. `promote_to_ready_for_review(github_token: str, repo_url: str, pr_number: int) -> None`
   - Parse owner/repo from repo_url (reuse pattern from pulls.py or comments.py _get_repo)
   - Use Auth.Token(github_token), Github(auth=auth)
   - repo = g.get_repo(owner_repo), pr = repo.get_pull(pr_number)
   - Call pr.mark_ready_for_review()
   - If PyGithub lacks this method: use _requester.graphql_named_mutation with markPullRequestReadyForReview and pullRequestId=pr.node_id (see RESEARCH.md fallback)

2. Wrap with tenacity retry:
   - 3 attempts total (2 retries). Use stop_after_attempt(3)
   - wait_exponential(multiplier=1, min=2, max=10)
   - Retry ONLY on: GithubException with status is None or status >= 500, ConnectionError, TimeoutError
   - Do NOT retry on 4xx (auth, not found)
   - Use retry_if_exception with a predicate that checks:
     - if isinstance(exc, GithubException): return getattr(exc, 'status', None) is None or (exc.status is not None and exc.status >= 500)
     - return isinstance(exc, (ConnectionError, TimeoutError, OSError))

3. On success: log "pr_promoted", pr_number=pr_number
4. On final failure after retries: raise the exception (caller catches and posts failure comment per CONTEXT)
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.github.promotion import promote_to_ready_for_review
# Cannot test against real GitHub without token; verify module loads and has expected signature
import inspect
sig = inspect.signature(promote_to_ready_for_review)
assert 'github_token' in sig.parameters and 'repo_url' in sig.parameters and 'pr_number' in sig.parameters
print('OK: promote_to_ready_for_review exists with correct signature')
"
  </verify>
  <done>promotion.py exists; promote_to_ready_for_review has correct signature and tenacity retry; retries only on 5xx/network.</done>
</task>

<task type="auto">
  <name>Task 2: Add post_promotion_failure_comment to comments.py</name>
  <files>src/booty/github/comments.py</files>
  <action>
Add function to src/booty/github/comments.py:

`post_promotion_failure_comment(github_token: str, repo_url: str, pr_number: int, reason: str, attempts: int = 3) -> None`

- Reuse _get_repo pattern from existing functions
- Get repo, then pr = repo.get_pull(pr_number)
- Use pr.as_issue().create_comment(body) — PRs are issues
- Body template (CONTEXT: neutral, no Booty branding):
  """
  ## Could not promote to ready for review

  Promotion was not completed after {attempts} attempt(s).

  {reason}

  ---
  PR remains in draft for manual review.
  """
- Wrap in try/except GithubException: log error, do NOT re-raise (CONTEXT: "If posting the comment fails: fall back to logs only, no UI change")
- Log "promotion_failure_comment_posted" or "promotion_failure_comment_failed" on exception
</action>
  <verify>
cd /Users/marlinf/Projects/datashaman/booty && python -c "
from booty.github.comments import post_promotion_failure_comment
import inspect
sig = inspect.signature(post_promotion_failure_comment)
assert 'github_token' in sig.parameters and 'repo_url' in sig.parameters and 'pr_number' in sig.parameters and 'reason' in sig.parameters
print('OK: post_promotion_failure_comment exists with correct signature')
"
  </verify>
  <done>post_promotion_failure_comment added; neutral body; logs on comment failure, does not re-raise.</done>
</task>

</tasks>

<verification>
- pytest passes
- promotion.py and comments.py have no lint errors (ruff check)
</verification>

<success_criteria>
- promote_to_ready_for_review and post_promotion_failure_comment exist and are importable
- Retry logic retries only 5xx/network, 3 attempts total
- Failure comment body is neutral (no Booty branding)
</success_criteria>

<output>
After completion, create `.planning/phases/06-pr-promotion/06-01-SUMMARY.md`
</output>
