---
phase: 23-ingestion
plan: 04
type: execute
wave: 3
depends_on: ["01", "02"]
files_modified:
  - src/booty/webhooks.py
  - src/booty/cli.py
  - src/booty/memory/__init__.py
autonomous: true

must_haves:
  truths:
    - "CLI: booty memory ingest revert --repo OWNER/REPO --sha SHA --reverted-sha REVERTED_SHA stores revert record"
    - "Push to main: commits with 'Revert' or 'revert SHA' in message produce revert records"
  artifacts:
    - path: src/booty/cli.py
      provides: booty memory ingest revert command
      contains: ingest.*revert|revert.*ingest
    - path: src/booty/webhooks.py
      provides: push event handler for revert detection on main
      contains: push|revert
  key_links:
    - from: CLI ingest revert
      to: memory.add_record
      via: build_revert_record + add_record
      pattern: add_record
    - from: push webhook
      to: memory.add_record
      via: detect revert in message, build_revert_record, add_record
      pattern: add_record
---

<objective>
Implement Revert ingestion: CLI for explicit input and push-to-main detection. MEM-12.

Purpose: MEM-12 — revert commits on main produce revert records.
Output: CLI `booty memory ingest revert`; push event handler for main branch with Revert detection.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-ingestion/23-CONTEXT.md
@.planning/phases/23-ingestion/23-RESEARCH.md
@src/booty/cli.py
@src/booty/webhooks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add booty memory ingest revert CLI</name>
  <files>src/booty/cli.py</files>
  <action>
1. Add subcommand under existing `booty memory` group (or create if missing): `ingest revert`
   - Args: --repo (required, owner/repo), --sha (required, merge/revert commit SHA), --reverted-sha (required, SHA being reverted)
   - Load booty_config from repo: Github.get_repo(repo).get_contents(".booty.yml", ref="main"). load_booty_config_from_content. mem_config = get_memory_config(config); mem_config = apply_memory_env_overrides(mem_config) if mem_config else None
   - If not mem_config or not mem_config.enabled: print "Memory disabled" and exit 0
   - record = build_revert_record(repo, sha, reverted_sha, source="cli")
   - result = add_record(record, mem_config)
   - Print "Added" or "Duplicate" based on result

2. Wire into CLI entrypoint. Check existing `booty memory` structure — may have `status` from Phase 26. For Phase 23, add `ingest` subcommand with `revert` as nested or `ingest-revert`. Simpler: `booty memory ingest revert --repo X --sha Y --reverted-sha Z`

Imports: from booty.memory import add_record, get_memory_config; from booty.memory.adapters import build_revert_record
  </action>
  <verify>cd /Users/marlinf/Projects/datashaman/booty && booty memory ingest revert --help 2>/dev/null || python -m booty.cli memory ingest revert --help 2>/dev/null</verify>
  <done>CLI booty memory ingest revert stores revert record when memory enabled</done>
</task>

<task type="auto">
  <name>Task 2: Add push handler and revert detection on main</name>
  <files>src/booty/webhooks.py</files>
  <action>
1. In github_webhook, add handler for event_type == "push":
   - ref = payload.get("ref", "")
   - if ref != "refs/heads/main": return {"status": "ignored", "reason": "not_main"}
   - commits = payload.get("commits", [])
   - repo = payload.get("repository", {}); repo_full_name = repo.get("full_name", "")
   - For each commit: message = commit.get("message", ""); sha = commit.get("id", "")
   - Detect revert: (a) message.strip().startswith("Revert ") or (b) re.match(r"revert\s+([a-f0-9]{7,40})", message, re.I)
   - If (a): extract reverted SHA from "Revert \"abc1234\"." or "Revert abc1234" — parse with regex
   - If (b): reverted_sha = match.group(1)
   - If revert detected: load booty_config, get mem_config, build_revert_record(repo_full_name, sha, reverted_sha, "push"), add_record with try/except

2. Revert message parsing:
   - "Revert \"abc1234\"." or "Revert 'abc1234'." -> abc1234
   - "Revert abc1234" -> abc1234
   - "revert abc1234" -> abc1234
   - Use regex: r'(?i)revert\s+["\']?([a-f0-9]{7,40})["\']?' or r'(?i)revert\s+([a-f0-9]{7,40})'

3. Return 202 with status "accepted" after processing commits. Idempotency: use delivery_id if available to avoid duplicate processing.
  </action>
  <verify>cd /Users/marlinf/Projects/datashaman/booty && python -c "
import re
def detect_revert(message):
    if not message: return None
    m = re.search(r'(?i)revert\s+[\"\']?([a-f0-9]{7,40})[\"\']?', message)
    return m.group(1) if m else None
assert detect_revert('Revert \"abc1234\"') == 'abc1234'
assert detect_revert('revert abc1234567') == 'abc1234567'
print('OK')
"</verify>
  <done>Push to main with Revert in message produces revert record</done>
</task>

</tasks>

<verification>
- CLI: booty memory ingest revert --repo o/r --sha X --reverted-sha Y works
- Push with revert message creates record
- Main branch only; non-main pushes ignored
</verification>

<success_criteria>
- MEM-12 satisfied
- CLI and push detection both functional
</success_criteria>

<output>
After completion, create `.planning/phases/23-ingestion/23-04-SUMMARY.md`
</output>
