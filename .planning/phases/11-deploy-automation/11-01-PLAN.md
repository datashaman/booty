---
phase: 11-deploy-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
autonomous: true
user_setup:
  - service: github
    why: "Deploy secrets and environment"
    env_vars:
      - name: SSH_PRIVATE_KEY
        source: "GitHub Settings → Secrets → production Environment"
      - name: DEPLOY_HOST
        source: "Optional secret if host not public; else variable"
      - name: DEPLOY_USER
        source: "Optional secret if sensitive; else variable"
    dashboard_config:
      - task: "Create production Environment"
        location: "GitHub Settings → Environments → New environment: production"
      - task: "Add secrets/variables"
        location: "Environment production: SSH_PRIVATE_KEY (required), DEPLOY_HOST, DEPLOY_USER, SERVER_NAME, REPO_URL"

must_haves:
  truths:
    - "Push to main triggers deploy workflow"
    - "Workflow SSHs to deploy host and runs deploy.sh"
    - "Booty service restarts after deploy"
    - "Health check confirms runtime before success"
    - "No deploy when no deploy-relevant files changed"
  artifacts:
    - path: .github/workflows/deploy.yml
      provides: "Deploy workflow"
      min_lines: 80
  key_links:
    - from: .github/workflows/deploy.yml
      to: deploy.sh
      via: "run step invoking ./deploy.sh with env"
      pattern: "deploy\.sh|\./deploy\.sh"
    - from: .github/workflows/deploy.yml
      to: webfactory/ssh-agent
      via: "step before deploy.sh"
      pattern: "webfactory/ssh-agent"
---

<objective>
Create the deploy workflow that automates deployment to DigitalOcean when code is pushed to main.

**Purpose:** Enables repeatable deploys without manual SSH; booty service restarts automatically; deploy-path filtering avoids unnecessary deploys.

**Output:** `.github/workflows/deploy.yml` with trigger, preflight, deploy steps, and health check.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-deploy-automation/11-CONTEXT.md
@.planning/phases/11-deploy-automation/11-RESEARCH.md
@deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy workflow skeleton</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create .github/workflows/deploy.yml with:

1. **Trigger:** `on: push: branches: [main]` (DEPLOY-01)

2. **Job:** Single job named `deploy`, runs on `ubuntu-latest`, uses `environment: production` for secrets scoping

3. **Preflight step:** Before any deploy work, validate required env vars with `: "${VAR:?Missing VAR}"` pattern. Required: DEPLOY_HOST, SERVER_NAME, REPO_URL. DEPLOY_USER optional (deploy.sh defaults to whoami). Use GitHub Environment variables and secrets — no hardcoded values in workflow.

4. **Structure:** Steps will be preflight → checkout → paths-filter → ssh-agent → deploy → health-check. Add preflight only in this task.

Reference 11-CONTEXT.md for blast-radius rule (secrets vs variables). Use `${{ secrets.SSH_PRIVATE_KEY }}`, `${{ vars.DEPLOY_HOST }}` or `${{ secrets.DEPLOY_HOST }}` — planner choice based on CONTEXT.
  </action>
  <verify>grep -E 'on:|push:|branches:|main' .github/workflows/deploy.yml && grep -E 'environment:|production' .github/workflows/deploy.yml && grep -E '\$\{.*:?Missing' .github/workflows/deploy.yml</verify>
  <done>Workflow file exists with push-to-main trigger, production environment, and preflight env validation.</done>
</task>

<task type="auto">
  <name>Task 2: Add deploy steps (checkout, paths-filter, ssh-agent, deploy.sh)</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Add steps after preflight:

1. **Checkout:** `actions/checkout@v4` with `fetch-depth: 0` (needed for paths-filter merge-base on push to main)

2. **paths-filter:** `dorny/paths-filter@v3` with id `deploy_filter`. Set `base: ${{ github.ref }}` for long-lived-branch mode (changes vs previous main commit). Filters per 11-CONTEXT deploy_paths:
   - src/**
   - deploy/**
   - deploy.sh
   - pyproject.toml
   - .booty.yml
   - requirements*.txt
   - Dockerfile
   - docker-compose*.yml
   - .github/workflows/deploy*.yml
   Use a single filter key `deploy` with these patterns. If `steps.deploy_filter.outputs.deploy != 'true'`, run `echo "No deploy-relevant changes" >> $GITHUB_STEP_SUMMARY` and `exit 0` — green check, no deploy.

3. **ssh-agent:** `webfactory/ssh-agent@v0.9.1` with `ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}`

4. **Deploy:** Export DEPLOY_HOST, SERVER_NAME, REPO_URL, DEPLOY_USER (from secrets/vars) and run `./deploy.sh`. Capture exit code; on non-zero, set `deploy_transport_success: false` for summary. Do NOT auto-retry (11-CONTEXT).

Do not inline SSH key. All deploy params from secrets/vars.
  </action>
  <verify>grep -q 'webfactory/ssh-agent' .github/workflows/deploy.yml && grep -q 'dorny/paths-filter' .github/workflows/deploy.yml && grep -q 'deploy.sh' .github/workflows/deploy.yml && grep -q 'No deploy-relevant changes' .github/workflows/deploy.yml</verify>
  <done>Checkout, paths-filter (early exit), ssh-agent, and deploy.sh invocation are present.</done>
</task>

<task type="auto">
  <name>Task 3: Add health check and failure handling</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Add after deploy step:

1. **Health check:** Only if deploy.sh succeeded (exit 0). Use curl to `https://${SERVER_NAME}/health` (Booty exposes GET /health). Loop: max 10 attempts, 6s sleep between. On first 2xx response: success, set `runtime_ready: true`. On timeout after 10 attempts: fail with "Deploy failed — health check timeout", set `runtime_ready: false`. Report `deploy_transport_success` and `runtime_ready` separately in job summary on failure (11-CONTEXT).

2. **Failure summary:** On any failure (deploy.sh non-zero OR health check timeout), write to $GITHUB_STEP_SUMMARY:
   - Failure class: SSH/network, auth, remote script exit, health check timeout
   - Host, user, stage, exit code
   - Last ~20 lines of relevant output (never full logs or secrets)
   Classify per 11-CONTEXT. Do not dump full logs.

3. **Success path:** If deploy and health check both pass, job succeeds. No summary needed for success (optional brief "Deployed successfully" is fine).

Ensure overall job fails if either deploy_transport or runtime_ready fails.
  </action>
  <verify>grep -q '/health' .github/workflows/deploy.yml && grep -q 'GITHUB_STEP_SUMMARY' .github/workflows/deploy.yml && (grep -q 'health check timeout' .github/workflows/deploy.yml || grep -q 'runtime_ready' .github/workflows/deploy.yml)</verify>
  <done>Health check loop (10 attempts, 6s), failure classification, and step summary on failure are present.</done>
</task>

</tasks>

<verification>
- Workflow triggers on push to main
- Workflow uses production environment for secrets
- Preflight validates DEPLOY_HOST, SERVER_NAME, REPO_URL
- paths-filter exits early when no deploy-relevant changes
- webfactory/ssh-agent loads SSH key; deploy.sh runs with env
- Health check hits /health, max 10×6s
- Failure produces structured summary
</verification>

<success_criteria>
1. .github/workflows/deploy.yml exists
2. Push to main triggers workflow
3. Workflow SSHs to deploy host and runs deploy.sh
4. Booty service restarts (via deploy.sh)
5. SSH key from GitHub secret; never in workflow file
6. Health check confirms /health before success
7. Early exit when no deploy_paths changed
</success_criteria>

<output>
After completion, create `.planning/phases/11-deploy-automation/11-01-SUMMARY.md`
</output>
