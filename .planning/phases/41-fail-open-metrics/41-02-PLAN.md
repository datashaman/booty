---
phase: 41-fail-open-metrics
plan: 02
type: execute
wave: 2
depends_on: [41-01]
files_modified:
  - src/booty/reviewer/runner.py
autonomous: true

must_haves:
  truths:
    - reviews_total, reviews_blocked, reviews_suggestions incremented on each review outcome
    - Structured logs with repo, pr, sha, outcome, blocked_categories, suggestion_count
  artifacts:
    - path: src/booty/reviewer/runner.py
      provides: Metrics and structured logs at outcome points
  key_links:
    - from: src/booty/reviewer/runner.py
      to: booty.reviewer.metrics
      via: increment_reviews_* at APPROVED, BLOCKED, APPROVED_WITH_SUGGESTIONS
      pattern: increment_reviews_
---

<objective>
Wire metrics increments for success-path outcomes (REV-15) and add structured logs with repo, pr, sha, outcome, blocked_categories, suggestion_count.

Purpose: Observability for review outcomes; status command will read from persisted metrics.
Output: Runner calls increment_reviews_total/blocked/suggestions; logger.info with structured fields.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-fail-open-metrics/41-CONTEXT.md
@src/booty/reviewer/runner.py
@src/booty/reviewer/metrics.py
</context>

<tasks>

<task type="auto">
  <name>Wire success-path metrics and structured logs</name>
  <files>src/booty/reviewer/runner.py</files>
  <action>
After edit_check_run and post_reviewer_comment (success path, lines 130-154):

1. Call increment_reviews_total() for every completed review (all three outcomes)

2. Based on result.decision:
   - APPROVED: increment only reviews_total (no blocked/suggestions)
   - APPROVED_WITH_SUGGESTIONS: increment reviews_total + increment_reviews_suggestions()
   - BLOCKED: increment reviews_total + increment_reviews_blocked()

3. Add structlog after edit_check_run:
   logger.info(
     "reviewer_outcome",
     repo=f"{job.owner}/{job.repo_name}",
     pr=job.pr_number,
     sha=job.head_sha[:7] if job.head_sha else "",
     outcome=result.decision,
     blocked_categories=result.blocking_categories or [],
     suggestion_count=sum(1 for c in result.categories for f in c.findings if f.suggestion),
   )

Use structlog.get_logger() or the logger from queue context (reviewer queue passes bound logger). Check reviewer/queue.py for how job processing gets logger — use the same pattern (queue passes log = log.bind(...)) or import structlog.get_logger() for runner.
</action>
  <verify>grep -n "increment_reviews_\|reviewer_outcome" src/booty/reviewer/runner.py</verify>
  <done>All three outcomes increment correct metrics; structured log emitted with required fields</done>
</task>

</tasks>

<verification>
- REV-15: reviews_total, reviews_blocked, reviews_suggestions incremented
- REV-15: Structured logs with repo, pr, sha, outcome, blocked_categories, suggestion_count
</verification>

<success_criteria>
- APPROVED → increment_reviews_total
- APPROVED_WITH_SUGGESTIONS → increment_reviews_total + increment_reviews_suggestions
- BLOCKED → increment_reviews_total + increment_reviews_blocked
- logger.info("reviewer_outcome", ...) with all required fields
</success_criteria>

<output>
After completion, create .planning/phases/41-fail-open-metrics/41-02-SUMMARY.md
</output>
