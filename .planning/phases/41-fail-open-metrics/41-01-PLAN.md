---
phase: 41-fail-open-metrics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/reviewer/metrics.py
  - src/booty/reviewer/runner.py
autonomous: true

must_haves:
  truths:
    - Infra/LLM failure yields check success with "Reviewer unavailable (fail-open)"
    - No PR comment when fail-open triggers
    - reviewer_fail_open incremented on fail-open
  artifacts:
    - path: src/booty/reviewer/metrics.py
      provides: Reviewer metrics persistence
      min_lines: 40
  key_links:
    - from: src/booty/reviewer/runner.py
      to: booty.reviewer.metrics
      via: increment_reviewer_fail_open on exception
      pattern: increment_reviewer_fail_open
---

<objective>
Implement fail-open handling (REV-09): when diff fetch, GitHub API, LLM, or schema fails, report check success with "Reviewer unavailable (fail-open)", increment reviewer_fail_open, no PR comment. Create reviewer metrics module mirroring Architect pattern.

Purpose: Quality tooling never halts delivery due to infra issues.
Output: src/booty/reviewer/metrics.py, runner.py fail-open path.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-fail-open-metrics/41-CONTEXT.md
@.planning/phases/41-fail-open-metrics/41-RESEARCH.md
@src/booty/architect/metrics.py
@src/booty/reviewer/runner.py
</context>

<tasks>

<task type="auto">
  <name>Create reviewer/metrics.py</name>
  <files>src/booty/reviewer/metrics.py</files>
  <action>
Create src/booty/reviewer/metrics.py mirroring architect/metrics.py:

1. get_reviewer_metrics_dir(state_dir=None) -> Path — uses get_planner_state_dir()/reviewer
2. _metrics_path, _load_events, _save_events (same pattern: events array, tempfile + os.replace)
3. Event types: "approved", "blocked", "suggestions", "fail_open"
4. increment_reviews_total(), increment_reviews_blocked(), increment_reviews_suggestions(), increment_reviewer_fail_open(fail_open_type: str)
5. get_reviewer_24h_stats() -> dict: reviews_total, reviews_blocked, reviews_suggestions, reviewer_fail_open (count events in last 24h)

For fail_open events, store type in event: {"ts": iso, "type": "fail_open", "bucket": "diff_fetch_failed"|"github_api_failed"|"llm_timeout"|"llm_error"|"schema_parse_failed"|"unexpected_exception"}
</action>
  <verify>python -c "from booty.reviewer.metrics import increment_reviewer_fail_open, get_reviewer_24h_stats; increment_reviewer_fail_open('llm_timeout'); s = get_reviewer_24h_stats(); assert 'reviewer_fail_open' in s and s['reviewer_fail_open'] >= 1"</verify>
  <done>reviewer/metrics.py exists; increment and get_reviewer_24h_stats work; events persist</done>
</task>

<task type="auto">
  <name>Wire fail-open in runner.py</name>
  <files>src/booty/reviewer/runner.py</files>
  <action>
Replace the bare except Exception block (lines 118-128) in process_reviewer_job:

1. Classify exception into fail_open bucket:
   - UnknownObjectException from repo.compare or get_contents → github_api_failed
   - TimeoutError, asyncio.TimeoutError → llm_timeout
   - JSONDecodeError, validation errors from Magentic/schema → schema_parse_failed
   - Other GitHub API errors (check for status/request attributes) → github_api_failed
   - Diff/compute errors before run_review → diff_fetch_failed
   - Default → unexpected_exception

2. Call increment_reviewer_fail_open(bucket) from booty.reviewer.metrics

3. edit_check_run with status="completed", conclusion="success", output:
   - title: "Reviewer unavailable (fail-open)"
   - summary: "Review did not run; promotion/merge not blocked"

4. Do NOT call post_reviewer_comment — check output only per CONTEXT

5. Add structlog: log.info("reviewer_fail_open", repo=..., pr=..., sha=..., fail_open_type=bucket)
</action>
  <verify>grep -n "Reviewer unavailable (fail-open)\|increment_reviewer_fail_open" src/booty/reviewer/runner.py</verify>
  <done>Fail-open path yields check success, no comment, metrics incremented, structured log</done>
</task>

</tasks>

<verification>
- REV-09: Infra/LLM failure → check success with "Reviewer unavailable (fail-open)", increment reviewer_fail_open
- No PR comment on fail-open
- Metrics persisted to ~/.booty/state/reviewer/metrics.json
</verification>

<success_criteria>
- reviewer/metrics.py with increment_reviewer_fail_open, get_reviewer_24h_stats
- Runner exception path → edit_check_run success, no post_reviewer_comment
- reviewer_fail_open event stored with bucket
</success_criteria>

<output>
After completion, create .planning/phases/41-fail-open-metrics/41-01-SUMMARY.md
</output>
