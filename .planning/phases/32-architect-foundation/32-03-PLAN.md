---
phase: 32-architect-foundation
plan: 03
type: execute
wave: 3
depends_on: ['01', '02']
files_modified:
  - src/booty/github/comments.py
  - src/booty/github/issues.py
  - src/booty/planner/worker.py
  - src/booty/main.py
autonomous: true

must_haves:
  truths:
    - Architect subscribes to Planner completion (runs after plan is created; never from GitHub labels)
    - Planner cache hit skips Architect, enqueues Builder directly
    - Invalid architect config: post comment, apply agent:architect-review, do NOT enqueue Builder
    - Architect enabled and approved: enqueue Builder
  artifacts:
    - path: src/booty/github/comments.py
      provides: post_architect_invalid_config_comment, post_architect_blocked_comment
    - path: src/booty/github/issues.py
      provides: add_architect_review_label
    - path: src/booty/planner/worker.py
      provides: process_planner_job with Architect integration
  key_links:
    - from: planner worker (main.py)
      to: process_planner_job
      via: process_planner_job completes then Architect runs
      pattern: process_planner_job
    - from: process_planner_job
      to: get_architect_config
      via: load booty_config from repo, then get_architect_config
      pattern: get_architect_config
    - from: process_architect_input
      to: job_queue.enqueue
      via: when approved
      pattern: enqueue.*Builder
---

<objective>
Planner worker integration: Architect runs after Planner completion.

Purpose: Architect subscribes to Planner completion only (ARCH-01, ARCH-03). When Planner cache hit: skip Architect, enqueue Builder. When architect config invalid (unknown keys): post comment "Architect review required — invalid architect config in .booty.yml", apply agent:architect-review, don't enqueue Builder. When architect disabled or enabled+approved: enqueue Builder.
Output: Integrated flow Planner → Architect (when enabled) → Builder.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-architect-foundation/32-CONTEXT.md
@.planning/phases/32-architect-foundation/32-RESEARCH.md
@src/booty/main.py
@src/booty/planner/worker.py
@src/booty/github/comments.py
@src/booty/webhooks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Architect GitHub helpers (comments and label)</name>
  <files>src/booty/github/comments.py, src/booty/github/issues.py</files>
  <action>
1. In comments.py: Add post_architect_invalid_config_comment(github_token, repo_url, issue_number) — body "Architect review required — invalid architect config in .booty.yml". Add post_architect_blocked_comment(github_token, repo_url, issue_number) — body "Architect review required — plan is structurally unsafe." Mirror post_builder_blocked_comment pattern.

2. In issues.py (or new helper module): Add add_architect_review_label(github_token, repo_url, issue_number). Adds "agent:architect-review" to issue. Try issue.add_to_labels(...); on 404 create_label then add. Mirror add_agent_builder_label from pulls.py.
  </action>
  <verify>python -c "
from booty.github.comments import post_architect_invalid_config_comment, post_architect_blocked_comment
from booty.github.issues import add_architect_review_label
assert callable(post_architect_invalid_config_comment) and callable(post_architect_blocked_comment)
assert callable(add_architect_review_label)
"</verify>
  <done>Architect comment and label helpers exist</done>
</task>

<task type="auto">
  <name>Task 2: process_planner_job returns cache hit flag and exposes plan/inp for Architect</name>
  <files>src/booty/planner/worker.py</files>
  <action>
Refactor process_planner_job to return PlannerJobResult(cache_hit: bool, plan: Plan, normalized_input: PlannerInput, repo_context: dict | None, job: PlannerJob). main.py _planner_worker_loop needs this for Architect integration. Define PlannerJobResult dataclass in planner/jobs.py or worker.py; have process_planner_job return it (never raises — exceptions are caught in main.py).
  </action>
  <verify>pytest tests/test_planner_config.py -v</verify>
  <done>process_planner_job returns structured result for Architect integration</done>
</task>

<task type="auto">
  <name>Task 3: Planner worker loop — Architect integration</name>
  <files>src/booty/main.py</files>
  <action>
In _planner_worker_loop, after process_planner_job(job) completes:
1. Get result (PlannerJobResult). If job failed (exception), Architect never runs (existing behavior).
2. If result.cache_hit: enqueue Builder directly (skip Architect per CONTEXT). Continue to enqueue logic.
3. If not cache_hit: Load booty_config from repo: Github(owner, repo).get_contents(".booty.yml", ref=default_branch). load_booty_config_from_content. If load fails (no .booty.yml, etc.): treat as no architect, enqueue Builder.
4. architect_config = get_architect_config(booty_config). If ArchitectConfigError: post_architect_invalid_config_comment, add_architect_review_label, do NOT enqueue Builder. Return.
5. If architect_config is None or architect_config.enabled is False (after apply_architect_env_overrides): enqueue Builder directly.
6. Else: build ArchitectInput(plan, normalized_input, repo_context, issue_metadata), call process_architect_input(architect_config, inp). If approved: enqueue Builder. If not approved: post_architect_blocked_comment, add_architect_review_label, do NOT enqueue Builder.
7. Only enqueue Builder when: cache_hit OR architect disabled OR architect approved. Use same Builder enqueue logic as today (job_queue, has_issue_in_queue check).
  </action>
  <verify>Booty starts without error; run a minimal planner flow test or import main</verify>
  <done>Planner worker invokes Architect when not cache hit; invalid config blocks Builder</done>
</task>

</tasks>

<verification>
- Architect runs only after Planner completion (never from GitHub labels)
- Planner cache hit skips Architect
- Invalid architect config posts comment and applies label, does not enqueue Builder
- Architect enabled + approved enqueues Builder
</verification>

<success_criteria>
- ARCH-01, ARCH-02, ARCH-03: Architect subscribes to Planner completion only
- Unknown keys in architect block: post comment, apply label, block Builder (ARCH-32)
- Architect enabled + pass-through: Builder enqueued
</success_criteria>

<output>
After completion, create .planning/phases/32-architect-foundation/32-03-SUMMARY.md
</output>
