---
phase: 12-sentry-apm
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/booty/config.py
  - src/booty/main.py
  - deploy.sh
  - deploy/booty.service
autonomous: true

user_setup:
  - service: sentry
    why: "Error tracking DSN"
    env_vars:
      - name: SENTRY_DSN
        source: "Sentry Dashboard → Project Settings → Client Keys (DSN)"
    dashboard_config:
      - task: "Create project if needed"
        location: "Sentry → Create Project → Python/FastAPI"
      - task: "Secrets file on deploy host"
        location: "Create /etc/booty/secrets.env with SENTRY_DSN=... (deploy does NOT write this)"

must_haves:
  truths:
    - "Sentry SDK captures unhandled FastAPI exceptions"
    - "Release set to git SHA when available (deploy correlation)"
    - "Environment tagged (e.g. production) for Sentry filtering"
    - "Production without DSN fails startup"
  artifacts:
    - path: pyproject.toml
      provides: "sentry-sdk dependency"
      contains: "sentry-sdk"
    - path: src/booty/config.py
      provides: "Sentry settings"
      contains: "SENTRY"
    - path: deploy/booty.service
      provides: "Systemd loads release.env and secrets.env"
      contains: "EnvironmentFile"
    - path: deploy.sh
      provides: "Deploy writes release.env with SHA"
      contains: "SENTRY_RELEASE"
  key_links:
    - from: src/booty/main.py
      to: "sentry_sdk.init"
      via: "init_sentry() in lifespan startup"
      pattern: "sentry_sdk\.init|init_sentry"
    - from: deploy/booty.service
      to: "release.env"
      via: "EnvironmentFile"
      pattern: "release\.env"
---

<objective>
Integrate Sentry SDK at app startup with FastAPI integration. Configure release (git SHA) and environment via env vars. Deploy writes release.env; systemd loads it. Production without DSN fails startup.

Purpose: Error tracking with deploy correlation for Phase 13 observability agent.
Output: sentry-sdk installed; init at startup; release/env from deploy; FastAPI integration captures unhandled exceptions.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-sentry-apm/12-CONTEXT.md
@.planning/phases/12-sentry-apm/12-RESEARCH.md

# Current app entry
@src/booty/main.py
@src/booty/config.py
@deploy.sh
@deploy/booty.service
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sentry-sdk and Settings</name>
  <files>pyproject.toml, src/booty/config.py</files>
  <action>
1. Add `sentry-sdk` to dependencies in pyproject.toml.
2. Add Sentry settings to config.py (BaseSettings):
   - SENTRY_DSN: str = "" (empty = not configured)
   - SENTRY_RELEASE: str = "" (optional; deploy sets from git rev-parse)
   - SENTRY_ENVIRONMENT: str = "development"
   - SENTRY_SAMPLE_RATE: float = 1.0
   Use env_file; case_sensitive; extra="ignore". No validation that blocks startup for missing DSN here — that's init logic.
  </action>
  <verify>grep -q '"sentry-sdk"' pyproject.toml && grep -q SENTRY_DSN src/booty/config.py</verify>
  <done>sentry-sdk in deps; SENTRY_DSN, SENTRY_RELEASE, SENTRY_ENVIRONMENT, SENTRY_SAMPLE_RATE in Settings.</done>
</task>

<task type="auto">
  <name>Task 2: Sentry init in lifespan</name>
  <files>src/booty/main.py</files>
  <action>
1. At the very start of lifespan (after configure_logging, before job_queue creation), add Sentry init logic per 12-CONTEXT and 12-RESEARCH:
   - If SENTRY_DSN empty and environment is production (case-insensitive "production" or "prod"): log error "Sentry disabled — production requires DSN; refusing to start", then sys.exit(1).
   - If SENTRY_DSN empty and not production: log once "Sentry disabled — no DSN configured" with environment=..., return (no init).
   - If DSN present: call sentry_sdk.init() with:
     - dsn=settings.SENTRY_DSN
     - release=settings.SENTRY_RELEASE or None (never empty string — omit release when unknown)
     - environment=settings.SENTRY_ENVIRONMENT
     - sample_rate=settings.SENTRY_SAMPLE_RATE
     - traces_sample_rate=0
     - integrations=[StarletteIntegration(transaction_style="endpoint"), FastApiIntegration(transaction_style="endpoint")]
   Import: sentry_sdk, sentry_sdk.integrations.fastapi.FastApiIntegration, sentry_sdk.integrations.starlette.StarletteIntegration.
2. Ensure init runs before any app routing (lifespan runs first).
  </action>
  <verify>grep -q "sentry_sdk.init" src/booty/main.py && grep -q "sys.exit" src/booty/main.py</verify>
  <done>Init logic in lifespan; production+no DSN exits; non-prod+no DSN skips with log; DSN present triggers full init with FastAPI/Starlette integrations.</done>
</task>

<task type="auto">
  <name>Task 3: Deploy writes release.env, systemd loads it</name>
  <files>deploy.sh, deploy/booty.service</files>
  <action>
1. deploy.sh (inside the remote heredoc, before systemctl restart):
   - Create /etc/booty if it doesn't exist: sudo mkdir -p /etc/booty
   - Get SHA: SHA=$(git rev-parse HEAD)
   - Write release.env: echo "SENTRY_RELEASE=$SHA" and "SENTRY_ENVIRONMENT=production" to /etc/booty/release.env (overwrite each deploy)
   - Use: printf 'SENTRY_RELEASE=%s\nSENTRY_ENVIRONMENT=production\n' "$(git rev-parse HEAD)" | sudo tee /etc/booty/release.env
2. deploy/booty.service:
   - Add EnvironmentFile=/etc/booty/release.env (before or after existing .env)
   - Add EnvironmentFile=-/etc/booty/secrets.env (leading - makes optional; user creates with SENTRY_DSN when using Sentry)
   - For release.env: deploy creates it before systemctl restart, so it exists. No - prefix.
   - Order: secrets.env (DSN), release.env (release, env), then ${INSTALL_DIR}/.env
3. Update deploy.sh envsubst if booty.service needs new vars — no new vars; INSTALL_DIR already used.
  </action>
  <verify>grep -q "release.env" deploy.sh && grep -q "SENTRY_RELEASE\|SENTRY_ENVIRONMENT" deploy.sh && grep -q "release.env" deploy/booty.service && grep -q "secrets.env" deploy/booty.service</verify>
  <done>Deploy writes /etc/booty/release.env with SENTRY_RELEASE and SENTRY_ENVIRONMENT; booty.service loads release.env and secrets.env.</done>
</task>

</tasks>

<verification>
- pytest passes (no regressions)
- With SENTRY_DSN unset: app starts (local dev)
- With SENTRY_DSN unset and SENTRY_ENVIRONMENT=production: app exits with error
- With SENTRY_DSN set: app starts, unhandled exception in route is captured (manual or follow-up plan)
</verification>

<success_criteria>
1. sentry-sdk in pyproject.toml
2. sentry_sdk.init() at app startup with DSN from env
3. release set to git SHA when SENTRY_RELEASE env present (from deploy)
4. environment set (production via deploy)
5. FastAPI integration enabled; unhandled exceptions captured
6. Production + no DSN → startup fails
</success_criteria>

<output>
After completion, create `.planning/phases/12-sentry-apm/12-01-SUMMARY.md`
</output>
