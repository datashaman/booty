---
phase: 12-sentry-apm
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/booty/main.py
  - tests/
autonomous: true

must_haves:
  truths:
    - "Job pipeline crashes (before PR) are captured in Sentry"
    - "Verifier job crashes are captured in Sentry"
    - "Test can verify capture_exception is called on error paths"
  artifacts:
    - path: src/booty/main.py
      provides: "capture_exception in job failure handler"
      contains: "capture_exception"
  key_links:
    - from: src/booty/main.py process_job except block
      to: "sentry_sdk.capture_exception"
      via: "call before post_failure_comment"
      pattern: "capture_exception"
    - from: src/booty/main.py _process_verifier_job
      to: "sentry_sdk.capture_exception"
      via: "try/except around process_verifier_job call"
      pattern: "capture_exception"
---

<objective>
Add explicit capture_exception for critical handled failures: job pipeline crashes (before PR) and verifier job crashes. Add verification test and optional manual Sentry test route.

Purpose: Ensure Builder and Verifier failures are tracked in Sentry for Phase 13 observability.
Output: capture_exception in process_job and verifier runner; pytest verifies capture; optional /internal/sentry-test route for manual E2E.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-sentry-apm/12-CONTEXT.md
@.planning/phases/12-sentry-apm/12-RESEARCH.md

@src/booty/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: capture_exception in process_job</name>
  <files>src/booty/main.py</files>
  <action>
In process_job, inside the except block (where we catch pipeline crashes before PR creation):
- Add sentry_sdk.capture_exception(e) before post_failure_comment
- Add tags for context: sentry_sdk.set_tag("job_id", job.job_id), set_tag("issue_number", job.issue_number)
- Import sentry_sdk at top of main.py if not already
- Keep existing logger.error and post_failure_comment — capture_exception is additive
  </action>
  <verify>grep -A5 "except Exception as e:" src/booty/main.py | grep -q capture_exception</verify>
  <done>Job pipeline exceptions are sent to Sentry with job context before posting failure comment.</done>
</task>

<task type="auto">
  <name>Task 2: capture_exception in _process_verifier_job</name>
  <files>src/booty/main.py</files>
  <action>
In main.py, modify _process_verifier_job to wrap the process_verifier_job call in try/except:
- try: await process_verifier_job(job, settings, job_queue=job_queue)
- except Exception as e: sentry_sdk.capture_exception(e); add set_tag for job_id if available from job; logger.error with exc_info; then re-raise so the verifier worker can handle the failure
- The VerifierJob has job_id; use it for Sentry context
  </action>
  <verify>grep -A15 "_process_verifier_job" src/booty/main.py | grep -q capture_exception</verify>
  <done>Verifier job crashes are captured in Sentry before propagation to worker.</done>
</task>

<task type="auto">
  <name>Task 3: Verification test and manual test route</name>
  <files>tests/, src/booty/main.py</files>
  <action>
1. Add pytest: mock sentry_sdk.capture_exception, trigger process_job with process_issue_to_pr raising, assert capture_exception was called. Put in tests/test_sentry_integration.py or tests/test_main.py. Use pytest fixture to mock; call the code path that hits the except block.
2. Add GET /internal/sentry-test route (or /test-sentry) that raises a test exception. Guard: only register when SENTRY_DSN is set (avoid noise in dev). Or always register but document it's for manual E2E — hitting it triggers an error that should appear in Sentry. Simpler: add route that raises; document in USER-SETUP or plan that user hits it to verify. Route can be under /internal/ to signal it's internal. No auth for now (observability phase).
3. Ensure pytest passes: uv run pytest
  </action>
  <verify>uv run pytest tests/ -v passes; grep -q "sentry-test\|test_sentry" src/booty/main.py tests/</verify>
  <done>Pytest verifies capture_exception called on job failure; manual route exists for E2E Sentry verification.</done>
</task>

</tasks>

<verification>
- uv run pytest passes
- Manual: with SENTRY_DSN set, hit GET /internal/sentry-test, verify event in Sentry dashboard with release (if SENTRY_RELEASE set) and environment
</verification>

<success_criteria>
6. Test: Trigger error in app; event appears in Sentry with correct release (pytest + manual route)
</success_criteria>

<output>
After completion, create `.planning/phases/12-sentry-apm/12-02-SUMMARY.md`
</output>
