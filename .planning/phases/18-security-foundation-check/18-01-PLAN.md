---
phase: 18-security-foundation-check
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/test_runner/config.py
  - tests/test_security_config.py
autonomous: true

must_haves:
  truths:
    - "SecurityConfig schema accepts enabled, fail_severity, sensitive_paths; unknown keys fail (extra='forbid')"
    - "Env vars SECURITY_ENABLED, SECURITY_FAIL_SEVERITY override .booty.yml values"
    - "BootyConfigV1.security is optional; invalid security block sets security=None (Security skips, rest loads)"
  artifacts:
    - path: src/booty/test_runner/config.py
      provides: SecurityConfig, BootyConfigV1.security, apply_security_env_overrides
      contains: SecurityConfig
    - path: tests/test_security_config.py
      provides: SecurityConfig validation tests
  key_links:
    - from: BootyConfigV1
      to: SecurityConfig
      via: security optional field
      pattern: security.*SecurityConfig
---

<objective>
Add SecurityConfig schema to .booty.yml with env override support.

Purpose: SEC-12, SEC-13, SEC-14 â€” security block (enabled, fail_severity, sensitive_paths); unknown keys fail for security block; env overrides SECURITY_ENABLED, SECURITY_FAIL_SEVERITY.

Output: SecurityConfig model, BootyConfigV1 extended, apply_security_env_overrides helper, tests.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-security-foundation-check/18-CONTEXT.md
@.planning/phases/18-security-foundation-check/18-RESEARCH.md
@src/booty/test_runner/config.py
@.planning/phases/14-governor-foundation-persistence/14-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SecurityConfig and extend BootyConfigV1</name>
  <files>src/booty/test_runner/config.py</files>
  <action>
Create SecurityConfig Pydantic model with model_config = ConfigDict(extra="forbid"). Include fields:
- enabled: bool = True
- fail_severity: Literal["low", "medium", "high", "critical"] = "high"
- sensitive_paths: list[str] with default [".github/workflows/**", "infra/**", "terraform/**", "helm/**", "k8s/**", "iam/**", "auth/**", "security/**"]

Add security: SecurityConfig | None = None to BootyConfigV1.

Use field_validator(mode="before") on security: when value is dict, try SecurityConfig.model_validate(value); on ValidationError return None (Security skips, config load succeeds). When value is None or key absent, return None.

Ensure _parse_booty_config and load_booty_config_from_content handle the new field. Backward compat: repos without security key load with security=None.
  </action>
  <verify>python -c "
from booty.test_runner.config import load_booty_config_from_content
c = load_booty_config_from_content('schema_version: 1\ntest_command: pytest\nsecurity:\n  enabled: true\n  fail_severity: high')
assert c.security is not None
assert c.security.enabled is True
assert c.security.fail_severity == 'high'
c2 = load_booty_config_from_content('schema_version: 1\ntest_command: pytest\nsecurity:\n  enabled: false\n  unknown_key: x')
assert c2.security is None  # invalid security block -> Security skips
"</verify>
  <done>BootyConfigV1 loads .booty.yml with optional security block; SecurityConfig validates with strict schema; invalid security block sets security=None</done>
</task>

<task type="auto">
  <name>Task 2: Add apply_security_env_overrides</name>
  <files>src/booty/test_runner/config.py</files>
  <action>
Add apply_security_env_overrides(config: SecurityConfig) -> SecurityConfig. Apply env vars:
- SECURITY_ENABLED: "1"/"true"/"yes" -> enabled=True; "0"/"false"/"no" -> enabled=False
- SECURITY_FAIL_SEVERITY: value must be in ("low","medium","high","critical"); update fail_severity

Return config.model_copy(update=overrides) when overrides present, else return config unchanged. Mirror apply_release_governor_env_overrides pattern.
  </action>
  <verify>SECURITY_ENABLED=false python -c "
from booty.test_runner.config import SecurityConfig, apply_security_env_overrides
import os
os.environ['SECURITY_ENABLED'] = 'false'
c = SecurityConfig(enabled=True)
c2 = apply_security_env_overrides(c)
assert c2.enabled is False
"</verify>
  <done>Env vars SECURITY_ENABLED and SECURITY_FAIL_SEVERITY override SecurityConfig values</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for SecurityConfig</name>
  <files>tests/test_security_config.py</files>
  <action>
Create tests/test_security_config.py. Test cases:
1. SecurityConfig accepts valid config (enabled, fail_severity, sensitive_paths)
2. SecurityConfig rejects unknown keys (extra="forbid")
3. BootyConfigV1 with valid security block loads
4. BootyConfigV1 with security block containing unknown keys loads with security=None
5. BootyConfigV1 without security key loads with security=None
6. apply_security_env_overrides applies SECURITY_ENABLED and SECURITY_FAIL_SEVERITY
  </action>
  <verify>pytest tests/test_security_config.py -v</verify>
  <done>SecurityConfig and env override behavior covered by tests</done>
</task>
