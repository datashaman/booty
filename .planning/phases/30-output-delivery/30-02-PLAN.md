---
phase: 30-output-delivery
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/booty/planner/worker.py
  - src/booty/cli.py
autonomous: true

must_haves:
  truths:
    - Worker posts plan comment to issue after storing plan (when GITHUB_TOKEN set)
    - CLI booty plan --issue posts plan comment after storing (always has token)
    - Missing token: store plan, skip comment, log warning (don't fail job)
  artifacts:
    - path: src/booty/planner/worker.py
      provides: process_planner_job calls format_plan_comment + post_plan_comment
    - path: src/booty/cli.py
      provides: plan_issue calls format_plan_comment + post_plan_comment
  key_links:
    - from: worker.process_planner_job
      to: format_plan_comment, post_plan_comment
      via: import, call after save_plan
      pattern: format_plan_comment|post_plan_comment
    - from: cli.plan_issue
      to: format_plan_comment, post_plan_comment
      via: import, call after save_plan
      pattern: format_plan_comment|post_plan_comment
---

<objective>
Wire planner worker and CLI plan --issue to post formatted plan comment to GitHub issue after storing. Worker: post when GITHUB_TOKEN available; skip and log if not. CLI: always post (already requires token).
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-output-delivery/30-CONTEXT.md
@src/booty/planner/worker.py
@src/booty/planner/output.py
@src/booty/github/comments.py
@src/booty/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire worker to post plan comment</name>
  <files>src/booty/planner/worker.py</files>
  <action>
In process_planner_job, after save_plan(plan, path):

1. Get token from get_settings().GITHUB_TOKEN or ""
2. If token.strip() and job.repo_url:
   - Import format_plan_comment from booty.planner.output
   - Import post_plan_comment from booty.github.comments
   - body = format_plan_comment(plan)
   - post_plan_comment(token, job.repo_url, job.issue_number, body)
   - Log planner_plan_posted or similar
3. Else (no token or no repo_url): log planner_comment_skipped (warning) — no token/repo, storing plan only
4. Wrap post_plan_comment in try/except GithubException: on exception log error and continue (do not re-raise). Plan storage already succeeded; comment is best-effort.
  </action>
  <verify>Manual or integration: trigger planner job with agent:plan, verify comment appears on issue with formatted plan</verify>
  <done>Worker posts plan comment when token and repo_url available; stores plan regardless; does not fail job on comment errors</done>
</task>

<task type="auto">
  <name>Task 2: Wire CLI plan --issue to post plan comment</name>
  <files>src/booty/cli.py</files>
  <action>
In plan_issue, after save_plan(plan_obj, path) and before the echo:

1. repo_url = f"https://github.com/{repo_name}" (repo_name is owner/repo)
2. body = format_plan_comment(plan_obj)
3. post_plan_comment(token, repo_url, issue_number, body)
4. Wrap in try/except GithubException: on error log and continue (plan was stored; comment is best-effort). CLI still echoes path and summary.
5. Import format_plan_comment from booty.planner.output, post_plan_comment from booty.github.comments

plan_issue already requires token (exits if missing), so we always have token and repo when we reach this point.
  </action>
  <verify>GITHUB_TOKEN=... booty plan issue N --repo owner/repo — plan stored and comment posted on issue</verify>
  <done>CLI plan --issue posts plan comment after storing; on comment error logs and continues, still echoes path</done>
</task>

</tasks>

<verification>
- Worker: process_planner_job posts comment when token present
- CLI: plan issue posts comment
- Both: plan storage succeeds even if comment fails
</verification>

<success_criteria>
- Planner posts plan as issue comment (webhook + CLI paths)
- Plan stored to $HOME/.booty/state/plans/... (unchanged)
- Comment includes Goal, Risk, Steps, Builder instructions per PLAN-18
</success_criteria>

<output>
After completion, create `.planning/phases/30-output-delivery/30-02-SUMMARY.md`
</output>
