---
phase: 30-output-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/booty/planner/output.py
  - src/booty/github/comments.py
  - tests/test_planner_output.py
autonomous: true

must_haves:
  truths:
    - Plan comment formatted per 30-CONTEXT (Goal → Risk → Steps → Builder instructions → collapsed JSON)
    - post_plan_comment posts or updates single comment on GitHub issue
    - Empty handoff fields omitted; pr_body_outline collapsed when long
  artifacts:
    - path: src/booty/planner/output.py
      provides: format_plan_comment(plan) -> str
    - path: src/booty/github/comments.py
      provides: post_plan_comment(github_token, repo_url, issue_number, body)
  key_links:
    - from: planner/worker.py
      to: format_plan_comment + post_plan_comment
      via: import and call after save_plan
      pattern: format_plan_comment|post_plan_comment
---

<objective>
Create plan comment formatter and posting function. Format follows 30-CONTEXT: Goal, Risk, Steps, Builder instructions, collapsed JSON. Single comment per issue via find-and-edit pattern.
</objective>

<execution_context>
@/Users/marlinf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marlinf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-output-delivery/30-CONTEXT.md
@.planning/phases/30-output-delivery/30-RESEARCH.md
@src/booty/planner/schema.py
@src/booty/github/comments.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: format_plan_comment in planner/output.py</name>
  <files>src/booty/planner/output.py</files>
  <action>
Create src/booty/planner/output.py with format_plan_comment(plan: Plan) -> str.

Format per 30-CONTEXT:
1. **## Goal** — plan.goal
2. **## Risk** — plan.risk_level
3. **## Steps** — Bullet list: `- P1: action path — acceptance` (action + path for read/edit/add; command for run/verify). One line per step, flat.
4. **## Builder instructions** — Grouped bullets from handoff_to_builder. Omit any empty field. Format:
   - `- **Branch:** {branch_name_hint}`
   - `- **Commit:** {commit_message_hint}`
   - `- **PR Title:** {pr_title}`
   - `- **PR Body:** — if pr_body_outline short (e.g. &lt;200 chars, no newlines or few), inline. If long, put in nested `<details><summary>PR body outline</summary>...` collapsed.
5. **Raw JSON** — `<details><summary>Full plan (JSON)</summary>` with ```json code block. Use plan.model_dump() then json.dumps(indent=2, default=str).
6. Append `\n\n<!-- booty-plan -->` at end.

Moderate spacing between sections (blank line between). No long prose; keep operator-focused.
  </action>
  <verify>python -c "from booty.planner.output import format_plan_comment; from booty.planner.schema import Plan, Step, HandoffToBuilder; p = Plan(goal='Test', steps=[Step(id='P1', action='read', path='x', acceptance='done')], handoff_to_builder=HandoffToBuilder(branch_name_hint='b', commit_message_hint='c', pr_title='t', pr_body_outline='out')); print('<!-- booty-plan -->' in format_plan_comment(p))" — prints True</verify>
  <done>format_plan_comment produces markdown with Goal, Risk, Steps, Builder instructions, collapsed JSON, and booty-plan marker</done>
</task>

<task type="auto">
  <name>Task 2: post_plan_comment in comments.py</name>
  <files>src/booty/github/comments.py</files>
  <action>
Add post_plan_comment(github_token: str, repo_url: str, issue_number: int, body: str) -> None to comments.py.

Mirror post_memory_comment pattern:
1. Use _get_repo(github_token, repo_url)
2. Get issue via repo.get_issue(issue_number)
3. Iterate issue.get_comments(); if "<!-- booty-plan -->" in comment.body, call comment.edit(body) and return
4. Else issue.create_comment(body)
5. Log with logger.info("plan_comment_posted" or "plan_comment_updated", issue_number=...)
6. Catch GithubException, log error, re-raise

Body is pre-formatted (caller uses format_plan_comment). Body must include <!-- booty-plan --> for find-and-edit.
  </action>
  <verify>python -c "from booty.github.comments import post_plan_comment; import inspect; sig = inspect.signature(post_plan_comment); assert set(sig.parameters) >= {'github_token','repo_url','issue_number','body'}; print('OK')"</verify>
  <done>post_plan_comment posts or updates single plan comment per issue using find-and-edit pattern</done>
</task>

<task type="auto">
  <name>Task 3: Tests for format_plan_comment</name>
  <files>tests/test_planner_output.py</files>
  <action>
Create tests/test_planner_output.py with:
1. test_format_plan_comment_includes_sections — assert "## Goal", "## Risk", "## Steps", "## Builder instructions" in output
2. test_format_plan_comment_includes_marker — assert "<!-- booty-plan -->" in output
3. test_format_plan_comment_omits_empty_handoff — handoff with empty pr_body_outline still has other fields; or handoff with only branch set produces just Branch bullet
4. test_format_plan_comment_pr_body_long_collapsed — when pr_body_outline &gt;200 chars, assert `<details>` and `PR body outline` in output
  </action>
  <verify>pytest tests/test_planner_output.py -v</verify>
  <done>Tests pass for format_plan_comment sections, marker, empty omission, and long pr_body collapse</done>
</task>

</tasks>

<verification>
- format_plan_comment and post_plan_comment importable and have correct signatures
- Format matches 30-CONTEXT section order and structure
- pytest tests/test_planner_output.py passes
</verification>

<success_criteria>
- format_plan_comment(plan) returns valid markdown per 30-CONTEXT
- post_plan_comment uses find-and-edit; single comment per issue
- Tests cover sections, marker, handoff edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/30-output-delivery/30-01-SUMMARY.md`
</output>
