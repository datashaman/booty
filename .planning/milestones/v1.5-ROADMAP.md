# Milestone v1.5: Security Agent

**Status:** ✅ SHIPPED 2026-02-16
**Phases:** 18-21
**Total Plans:** 10

## Overview

The Security Agent is a merge veto authority. It runs on pull_request events, publishes the `booty/security` check, blocks merges on secrets and high/critical vulnerabilities, and escalates permission-surface changes to the Release Governor. Decision model: PASS, FAIL, ESCALATE.

## Phases

### Phase 18: Security Foundation & Check ✓

**Goal:** Config schema, Security module skeleton, pull_request webhook, booty/security check.

**Requirements:** SEC-01, SEC-02, SEC-12, SEC-13, SEC-14, SEC-15, SEC-16

**Depends on:** Nothing

**Completed:** 2026-02-16

**Plans:** 3 plans

Plans:
- [x] 18-01-PLAN.md — SecurityConfig schema (enabled, fail_severity, sensitive_paths); env overrides
- [x] 18-02-PLAN.md — SecurityJob, SecurityQueue, process_security_job, booty/security check
- [x] 18-03-PLAN.md — pull_request webhook wiring, security_queue in lifespan

**Details:**
- SecurityConfig in BootyConfigV1 (enabled, fail_severity, sensitive_paths); unknown keys → security=None
- SECURITY_ENABLED, SECURITY_FAIL_SEVERITY env overrides applied
- pull_request opened/synchronize triggers Security pipeline
- booty/security check published (queued → in_progress → completed)
- Clear check titles (secret detected, vulnerability, workflow modified)
- Security runs on every PR; Verifier and Security both trigger on pull_request

---

### Phase 19: Secret Leakage Detection ✓

**Goal:** Scan changed files for secrets with gitleaks (or trufflehog); FAIL + annotate.

**Requirements:** SEC-03, SEC-04, SEC-17

**Depends on:** Phase 18

**Completed:** 2026-02-16

**Plans:** 3 plans

Plans:
- [x] 19-01-PLAN.md — SecurityConfig: secret_scanner, secret_scan_exclude
- [x] 19-02-PLAN.md — Scanner module: run_secret_scan, build_annotations
- [x] 19-03-PLAN.md — Runner integration: clone, scan, FAIL with annotations

**Details:**
- Changed files only scanned (diff-based)
- Secret detected → check FAIL, file+line annotations, cap 50
- Check completes in under 60 seconds
- Title "Security failed — secret detected"

---

### Phase 20: Dependency Vulnerability Gate ✓

**Goal:** Auto-detect ecosystem from lockfiles; run audit; FAIL on severity >= HIGH.

**Requirements:** SEC-05, SEC-06, SEC-07

**Depends on:** Phase 18

**Completed:** 2026-02-16

**Plans:** 2 plans

Plans:
- [x] 20-01-PLAN.md — Audit module: discover_lockfiles, run_dependency_audit
- [x] 20-02-PLAN.md — Runner integration: audit after secret scan

**Details:**
- Lockfile detection: pip (requirements*.txt, pyproject.toml), npm (package-lock.json), composer (composer.lock), cargo (Cargo.lock)
- Correct audit tool invoked per ecosystem
- FAIL only on severity >= HIGH; low/medium ignored
- Title "Security failed — critical vulnerability" when failed

---

### Phase 21: Permission Drift & Governor Integration ✓

**Goal:** Sensitive paths → ESCALATE; persist override; Governor consumes.

**Requirements:** SEC-08, SEC-09, SEC-10, SEC-11

**Depends on:** Phase 18

**Completed:** 2026-02-16

**Plans:** 2 plans

Plans:
- [x] 21-01-PLAN.md — Permission drift detection (permission_drift, override persist, runner integration)
- [x] 21-02-PLAN.md — Governor override integration (read, poll, handler wiring)

**Details:**
- Sensitive paths matched (default: .github/workflows/**, infra/**, terraform/**, helm/**, k8s/**, iam/**, auth/**, security/**)
- Touched → ESCALATE (not FAIL); title "Security escalated — workflow modified"
- Override persisted: risk_override=HIGH, reason=permission_surface_change, sha
- Governor reads override for head_sha before compute_decision; uses HIGH when present
- PR is not blocked — only deploy risk escalated

---

## Milestone Summary

**Key Decisions:**
- gitleaks preferred for secrets; trufflehog acceptable
- fail_severity: high (configurable)
- ESCALATE does not block merge; Governor handles deploy gating
- Security runs in parallel with Verifier (different check)
- Security uses same GitHub App as Verifier
- Security runs on every PR (no is_agent_pr filter)
- pip-audit vulns treated as HIGH (no severity in JSON)
- PathSpec gitwildmatch for sensitive path matching
- Override stored in state_dir/security_overrides.json
- Governor override poll with RELEASE_GOVERNOR_OVERRIDE_POLL_SEC (default 120s)

**Issues Resolved:**
- Handler tests would hang 2 min without override; patched get_security_override_with_poll in tests

**Technical Debt Incurred:**
- None noted

---

_For current project status, see .planning/ROADMAP.md_

---
