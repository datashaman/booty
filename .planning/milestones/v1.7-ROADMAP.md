# Milestone v1.7: Planner Agent

**Status:** ✓ Complete
**Phases:** 27–31
**Total Plans:** 4 (Phase 27), 3 (Phase 28)

## Overview

Planner Agent turns input requests (GitHub issue, Observability incident, operator CLI prompt) into structured execution plans that Builder can consume without interpretation. Planner does not make code changes, create PRs, or approve—it produces a Plan JSON with goal, steps, risk_level, touch_paths, and handoff_to_builder.

## Phases

### Phase 27: Planner Foundation

**Goal:** Plan schema, config, webhook for `agent:plan`, booty plan CLI skeleton.

**Depends on:** Nothing

**Plans:** 4 plans

Plans:
- [x] 27-01-PLAN.md — Plan schema (Pydantic) and storage (get_planner_state_dir, save_plan) ✓
- [x] 27-02-PLAN.md — PlannerConfig, .booty.yml planner block, env overrides ✓
- [x] 27-03-PLAN.md — Webhook agent:plan branch, PlannerJob, planner worker ✓
- [x] 27-04-PLAN.md — booty plan --issue, booty plan --text CLI ✓

**Success criteria:**
1. Plan JSON schema (Pydantic) validates plan_version, goal, steps, risk_level, touch_paths, handoff_to_builder
2. .booty.yml planner block (optional) with env overrides
3. GitHub webhook handles issue labeled `agent:plan` (enqueue planner job)
4. `booty plan --issue <n>` and `booty plan --text "..."` CLI subcommands exist
5. Planner stores output to $HOME/.booty/state/plans/<issue_id>.json

**Requirements:** PLAN-05, PLAN-06, PLAN-07, PLAN-08, PLAN-13, PLAN-14, PLAN-15, PLAN-17

---

### Phase 28: Input Normalization

**Goal:** Normalize GitHub issue, Observability incident, and CLI text into Planner input context.

**Depends on:** Phase 27

**Plans:** 3 plans

Plans:
- [x] 28-01-PLAN.md — PlannerInput model, normalizers (GitHub issue, CLI text), incident detection ✓
- [x] 28-02-PLAN.md — get_repo_context (optional default branch + tree) ✓
- [x] 28-03-PLAN.md — Wire worker and CLI to normalizers ✓

**Success criteria:**
1. Planner accepts full GitHub Issue payload (title, body, labels)
2. Planner recognizes Observability incident format (Sentry-derived issue body)
3. Planner accepts operator free text via `booty plan --text`
4. Optional: fetch repo context (default branch, tree, recent commits) when available
5. Single normalized input structure fed to plan generation

**Requirements:** PLAN-01, PLAN-02, PLAN-03, PLAN-04

---

### Phase 29: Plan Generation ✓

**Goal:** LLM produces valid Plan JSON from normalized input; risk classification applied.

**Depends on:** Phase 28

**Plans:**
- [x] 29-01-PLAN.md — Magentic prompt, derive_touch_paths, schema Field descriptions ✓
- [x] 29-02-PLAN.md — classify_risk_from_paths ✓
- [x] 29-03-PLAN.md — Worker and CLI wiring ✓

**Success criteria:**
1. Magentic/LLM prompt produces Plan JSON matching schema
2. Max 12 steps; each step has id, action, path/command, acceptance
3. No "research" steps without specified artifact
4. risk_level derived from touch_paths: HIGH (workflows, infra, deploy, lockfiles, migrations), MEDIUM (manifests), LOW otherwise
5. touch_paths populated from intended changes
6. handoff_to_builder populated with branch_name_hint, commit_message_hint, pr_title, pr_body_outline

**Requirements:** PLAN-05, PLAN-06, PLAN-07, PLAN-08, PLAN-09, PLAN-10, PLAN-11, PLAN-12, PLAN-19, PLAN-20, PLAN-21, PLAN-25

---

### Phase 30: Output Delivery

**Goal:** Post plan to issue comment and store artifact; operator UX format.

**Depends on:** Phase 29

**Plans:** 2 plans

Plans:
- [x] 30-01-PLAN.md — format_plan_comment + post_plan_comment ✓
- [x] 30-02-PLAN.md — Wire worker and CLI to post comment ✓

**Success criteria:**
1. Planner posts Plan JSON in issue comment (code block)
2. Planner stores plan to $HOME/.booty/state/plans/<issue_id>.json
3. Comment includes Goal, Risk level, Step list (P1..Pn), "Builder instructions" section
4. Output avoids long prose

**Requirements:** PLAN-16, PLAN-17, PLAN-18

---

### Phase 31: Idempotency

**Goal:** Same plan for unchanged inputs within 24h; plan_hash for dedup.

**Depends on:** Phase 29

**Plans:** 3 plans

Plans:
- [x] 31-01-PLAN.md — Cache primitives: schema metadata, input_hash, plan_hash, load_plan, find_cached_issue_plan ✓
- [x] 31-02-PLAN.md — Wire worker and CLI plan_issue to check cache before LLM ✓
- [x] 31-03-PLAN.md — Ad-hoc cache with hash index; wire CLI plan_text ✓

**Success criteria:**
1. Planner checks for existing plan for same issue within 24h
2. If inputs unchanged, return cached plan (no new LLM call)
3. Plan metadata includes plan_hash (hash of normalized plan)
4. Output is reproducible for unchanged inputs

**Requirements:** PLAN-23, PLAN-24, PLAN-26

---

## Milestone Summary

**Key Decisions:**
- Planner triggers on `agent:plan` label (webhook) and `booty plan` CLI
- Plan schema v1 fixed; Builder integration (consuming plan) deferred to future milestone
- risk_level advisory only; Governor/Security enforce their own rules

**Builder Contract (v1.7):**
- Plan format enables Builder to consume; Builder changes to read plan from comment/artifact deferred

---
_For current project status, see .planning/ROADMAP.md_

---
*Created: 2026-02-16 — Milestone v1.7 Planner Agent*
