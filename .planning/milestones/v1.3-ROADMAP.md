# Milestone v1.3: Observability

**Status:** ✅ SHIPPED 2026-02-15
**Phases:** 11-13
**Total Plans:** 5

## Overview

Close the post-merge loop — production errors automatically flow back as GitHub issues for Builder intake. Automated deployment via GitHub Actions; Sentry APM for error tracking and release correlation; Observability agent ingests Sentry alerts via webhook, filters (severity, dedup, cooldown), and creates GitHub issues with agent:builder label.

## Phases

### Phase 11: Deploy Automation

**Goal**: Automated deployment via GitHub Actions — push to main triggers SSH to DigitalOcean, runs deploy.sh, restarts Booty.

**Requirements:** DEPLOY-01, DEPLOY-02, DEPLOY-03

**Depends on**: Nothing (first v1.3 phase)

**Plans**: 1 plan

Plans:
- [x] 11-01-PLAN.md — Deploy workflow (trigger, preflight, paths-filter, ssh-agent, deploy.sh, health check)

**Details:**
- Workflow file at `.github/workflows/deploy.yml`
- Triggers on push to main branch
- Preflight validates DEPLOY_HOST, SERVER_NAME, REPO_URL before any deploy work
- paths-filter (dorny/paths-filter@v3) exits early when no deploy-relevant files changed
- webfactory/ssh-agent loads SSH key; deploy.sh runs with env
- Health check: curl to https://${SERVER_NAME}/health, 10 attempts × 6s
- Failure summary written to GITHUB_STEP_SUMMARY
- SSH key stored as GitHub secret; not in workflow file

---

### Phase 12: Sentry APM

**Goal**: Sentry SDK integrated for error tracking; release and environment set for deploy correlation.

**Requirements:** APM-01, APM-02, APM-03

**Depends on**: Phase 11

**Plans**: 2 plans

Plans:
- [x] 12-01-PLAN.md — SDK integration (dependency, config, init, deploy release.env, systemd)
- [x] 12-02-PLAN.md — capture_exception (job + verifier), verification test, manual route

**Details:**
- sentry-sdk added to dependencies; FastAPI/Starlette integrations
- _init_sentry() in lifespan; production + no DSN exits with error
- deploy.sh writes /etc/booty/release.env with SENTRY_RELEASE (git SHA), SENTRY_ENVIRONMENT
- systemd loads secrets.env (DSN) and release.env (release, env)
- capture_exception in process_job and verifier failure handlers
- GET /internal/sentry-test for manual E2E verification

---

### Phase 13: Observability Agent

**Goal**: Sentry webhook → verify → filter (severity, dedup, cooldown) → create GitHub issue with agent:builder label.

**Requirements:** OBSV-01 through OBSV-08

**Depends on**: Phase 12

**Plans**: 2 plans

Plans:
- [x] 13-01-PLAN.md — Webhook route, HMAC verify, severity/dedup/cooldown filters
- [x] 13-02-PLAN.md — Issue body builder, create_issue, retry, spool, wire to route

**Details:**
- POST /webhooks/sentry with Sentry-Hook-Signature HMAC-SHA256 verification
- Configurable severity threshold; dedup by fingerprint; in-memory cooldown per fingerprint
- create_issue_from_sentry_event with agent:builder label
- Issue body: severity, release/SHA, environment, breadcrumbs, Sentry event link
- tenacity retry (5xx only); disk spool on failure
- Builder picks up created issues via existing issue webhook flow

---

## Milestone Summary

**Key Decisions:**
- Push-to-main trigger for deploy (plan choice); staging/rollback deferred
- Release omitted when SENTRY_RELEASE empty; DSN in secrets.env, release/env in release.env
- SENTRY_WEBHOOK_SECRET required at startup (no dev exception)
- In-memory cooldown store; OBSV-10 persistent store deferred
- Retry only on 5xx; 4xx not retried
- deploy_paths whitelist for paths-filter early exit

**Issues Resolved:**
- Post-merge error loop closed (Sentry → webhook → GitHub issue → Builder)
- Deploy automation via GitHub Actions (SSH + deploy.sh)
- Sentry release/environment correlation for deploy tracing

**Issues Deferred:**
- OBSV-10: Persistent cooldown store (e.g., Redis) survives restarts
- DEPLOY-04: Staging vs production deploy targets
- DEPLOY-05: Rollback workflow

**Technical Debt Incurred:**
- Phase 11: User setup required (GitHub production Environment, SSH_PRIVATE_KEY, DEPLOY_HOST, SERVER_NAME, REPO_URL)
- Phase 12: Manual E2E for Sentry (hit /internal/sentry-test); production startup without DSN exits with error (by design)
- Phase 13: In-memory cooldown store; OBSV-10 deferred to future release

---

_For current project status, see .planning/ROADMAP.md_
