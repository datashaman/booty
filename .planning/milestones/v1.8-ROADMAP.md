# Milestone v1.8: Architect Agent

**Status:** ✅ SHIPPED 2026-02-17
**Phases:** 32–36
**Total Plans:** 16

## Overview

Architect Agent validates and refines plans before Builder executes. It sits between Planner and Builder, prevents structurally risky work, enforces architectural consistency, and ensures Builder runs against a technically sound blueprint. Architect does not write code—it rewrites the plan when necessary. Builder triggers only after Architect approval.

## Phases

### Phase 32: Architect Foundation

**Goal:** Architect config, triggering from Planner completion, input ingestion.

**Depends on:** Phase 31 (Planner idempotency)

**Requirements:** ARCH-01, ARCH-02, ARCH-03, ARCH-04, ARCH-05, ARCH-31, ARCH-32

**Plans:** 3 plans in 3 waves ✓

Plans:
- [x] 32-01-PLAN.md — ArchitectConfig, .booty.yml architect block, get_architect_config, ArchitectConfigError, env overrides
- [x] 32-02-PLAN.md — ArchitectInput, ArchitectResult, process_architect_input (pass-through)
- [x] 32-03-PLAN.md — Planner worker integration, GitHub helpers (comments, label), Architect flow

**Success criteria:**
1. Architect subscribes to Planner completion (runs after plan is created; never from GitHub labels)
2. ArchitectConfig in .booty.yml: enabled, rewrite_ambiguous_steps, enforce_risk_rules
3. Architect receives plan_json, normalized_input, optional repo_context, optional issue_metadata
4. Architect operates when repo_context is missing
5. Unknown keys in architect block fail Architect only

---

### Phase 33: Validation Rules

**Goal:** Structural integrity, path consistency, risk accuracy, ambiguity and overreach detection.

**Depends on:** Phase 32

**Requirements:** ARCH-06, ARCH-07, ARCH-08, ARCH-09, ARCH-10, ARCH-11, ARCH-12, ARCH-13, ARCH-14, ARCH-15, ARCH-34

**Plans:** 3 plans in 3 waves ✓

Plans:
- [x] 33-01-PLAN.md — Structural validation, path consistency, risk recomputation
- [x] 33-02-PLAN.md — Ambiguity and overreach detection and rewrite
- [x] 33-03-PLAN.md — Worker integration, block flow, < 5s

**Success criteria:**
1. Architect validates steps ≤ 12; each step has id + action; actions ∈ {read, add, edit, run, verify, research}
2. touch_paths == union(step.paths); empty paths flagged unless justified
3. Risk recomputed from touch_paths (HIGH/MEDIUM/LOW); Architect overrides Planner when different
4. Ambiguous steps rewritten when rewrite_ambiguous_steps enabled
5. Overreach detected (repo-wide refactors, multi-domain rewrites); rewritten into smaller scope when possible
6. Architect completes in < 5 seconds

---

### Phase 34: Output & Failure Handling

**Goal:** ArchitectPlan output, comment updates, block handling.

**Depends on:** Phase 33

**Requirements:** ARCH-16, ARCH-17, ARCH-18, ARCH-19, ARCH-20, ARCH-21, ARCH-22

**Plans:** 3 plans in 3 waves ✓

Plans:
- [x] 34-01-PLAN.md — ArchitectPlan, build_architect_plan
- [x] 34-02-PLAN.md — format_architect_section, format_plan_comment update, update_plan_comment_with_architect_section, post_architect_blocked_comment refactor
- [x] 34-03-PLAN.md — main.py wire Architect comment updates (approved/rewritten/blocked)

**Success criteria:**
1. Architect produces ArchitectPlan (plan_version, goal, steps, touch_paths, risk_level, handoff_to_builder, architect_notes)
2. architect_notes optional; not consumed by Builder
3. Architect updates plan comment with <!-- booty-architect --> section (Approved or Rewritten)
4. When blocked: post "Architect review required — plan is structurally unsafe.", apply agent:architect-review, do NOT trigger Builder
5. No automatic retries on block

---

### Phase 35: Idempotency

**Goal:** plan_hash cache; reuse ArchitectPlan within 24h when plan unchanged.

**Depends on:** Phase 34

**Requirements:** ARCH-23, ARCH-24, ARCH-25

**Plans:** 3 plans in 2 waves ✓

Plans:
- [x] 35-01-PLAN.md — Architect cache primitives (plan_hash reuse, find/save)
- [x] 35-02-PLAN.md — Comment diff helper (get_plan_comment_body, update_if_changed)
- [x] 35-03-PLAN.md — Main flow integration (cache check, save, diff-before-update)

**Success criteria:**
1. plan_hash = sha256(plan_json)
2. Same plan approved within 24h reuses ArchitectPlan; no rewrite
3. Update comment only if changed on cache hit

---

### Phase 36: Builder Handoff & CLI

**Goal:** Persist ArchitectPlan artifact, emit approval event, Builder consumes; CLI and metrics.

**Depends on:** Phase 35

**Requirements:** ARCH-26, ARCH-27, ARCH-28, ARCH-29, ARCH-30, ARCH-33

**Plans:** 4 plans in 3 waves

Plans:
- [x] 36-01-PLAN.md — Artifact persistence, event emission
- [x] 36-02-PLAN.md — Builder handoff, webhook changes
- [x] 36-03-PLAN.md — Metrics (plans_reviewed, plans_rewritten, architect_blocks, cache_hits)
- [x] 36-04-PLAN.md — CLI architect status, architect review

**Success criteria:**
1. Architect persists approved artifact to ~/.booty/state/plans/<repo>/<issue>-architect.json
2. Architect emits planner.plan.approved (internal event) when approved
3. Builder listens for Architect approval; Builder no longer triggers from agent:builder
4. booty architect status shows enabled, plans reviewed (24h), rewrites count
5. booty architect review --issue N forces re-evaluation
6. Metrics: plans_reviewed, plans_rewritten, architect_blocks, cache_hits

---

## Milestone Summary

**Key Decisions:**
- Architect runs only after Planner; subscribes to Planner completion event
- Builder triggers solely from Architect approval (agent:builder label retired for Builder)
- Risk deterministic from touch_paths; Architect overrides Planner
- Conservative, rule-driven, < 5s, stateless
- architect.plan.approved event (requirement said planner.plan.approved; impl uses architect for clarity)

**Issues Resolved:**
- Planner → Architect → Builder flow wired; webhook gates Builder on Architect approval
- Architect cache integration; cache hit skips Architect, saves artifact, enqueues Builder
- Block flow: agent:architect-review, no Builder trigger, post_architect_blocked_comment

**Tech Debt (Non-blocking):**
- ARCH-27: requirement specifies planner.plan.approved; implementation uses architect.plan.approved. Non-blocking.

**Integration Points:**
- Planner worker: after plan stored → invoke Architect (don’t enqueue Builder directly)
- Builder: consume ArchitectPlan from artifact; require approval before execution
- Webhook: agent:plan → Planner; no direct agent:architect label

---
_For current project status, see .planning/ROADMAP.md_

---
*Archived: 2026-02-17 as part of v1.8 milestone completion*
