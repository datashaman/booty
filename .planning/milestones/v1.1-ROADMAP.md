# Milestone v1.1: Test Generation & PR Promotion

**Status:** ✅ SHIPPED 2026-02-15
**Phases:** 5-6
**Total Plans:** 4

## Overview

Make the Builder generate tests with every code change and promote PRs to ready-for-review only when tests pass.

## Phases

### Phase 5: Test Generation

**Goal**: Builder generates and validates unit tests for all code changes

**Depends on**: Phase 4 (v1.0 baseline)

**Requirements**: TGEN-01, TGEN-02, TGEN-03, TGEN-04, TGEN-05

**Plans**: 2 plans

Plans:

- [x] 05-01-PLAN.md — Convention detection and import validation module
- [x] 05-02-PLAN.md — LLM integration and pipeline wiring

**Details:**
- DetectedConventions model captures language, framework, directory, naming pattern, and config file
- Convention detector analyzes repos to infer test conventions from structure and config
- Import validator uses AST parsing to catch hallucinated Python packages
- CodeGenerationPlan tracks test files separately; LLM prompts include test generation instructions
- Test conventions forwarded through entire execution chain; refinement prompt instructs LLM not to modify test files

### Phase 6: PR Promotion

**Goal**: Draft PRs are automatically promoted to ready-for-review when validation passes

**Depends on**: Phase 5 (needs working test generation)

**Requirements**: PRMO-01, PRMO-02, PRMO-03

**Plans**: 2 plans

Plans:

- [x] 06-01-PLAN.md — Promotion module and failure comment
- [x] 06-02-PLAN.md — Pipeline wiring (quality for all, promote when criteria met)

**Details:**
- promote_to_ready_for_review with tenacity retry (5xx/network only)
- post_promotion_failure_comment with neutral body
- Quality checks run for all jobs; promote when tests+lint pass and not self-modification
- Self-modification PRs always remain draft with "Draft by design" note

---

## Milestone Summary

**Key Decisions:**
- Single LLM call for code + tests (shared context, simpler architecture)
- One-shot test generation, refine only code (preserves refinement loop stability)
- Multi-criteria PR promotion (tests + linting + not self-modification)
- GraphQL via PyGithub (zero new dependencies)
- Test files in same commit as source (atomic changes)
- File extension counting for language detection (99%+ accuracy, zero dependencies)
- AST parsing for import extraction (not regex) to handle edge cases correctly
- Check both project.dependencies and project.optional-dependencies for framework detection
- Test files tracked separately from source changes (test_files field)
- Import validation logs warnings but doesn't block (refinement catches real failures)
- Refinement prompt instructs LLM not to modify test files (one-shot generation)
- Quality checks run for all jobs (promotion gate); always create draft PRs; promote when tests+lint pass and not self-mod
- Retry promotion only on 5xx/network; post neutral failure comment on exception

**Issues Resolved:**
- Test generation integrated without breaking refinement loop
- Promotion failure handling (comment, leave draft, no job failure)
- Self-modification PRs never auto-promoted

**Issues Deferred:**
- Integration tests (TBKF-02) — future backfill phase
- Non-Python import validation — deferred to future implementation

**Technical Debt Incurred:**
- None significant; all stdlib/no new dependencies for v1.1

---

_For current project status, see .planning/ROADMAP.md_
