# Milestone v1.10: Pipeline Correctness

**Status:** In progress
**Phases:** 42–47
**Total Plans:** TBD

## Overview

Given any relevant GitHub event, Booty runs exactly the right agents exactly once, promotes correctly, and never stalls silently. Focus: event router, Planner→Architect→Builder wiring, promotion gating, dedup/cancel alignment, operator visibility.

## Phases

### Phase 42: Event Router ✓

**Goal:** Single canonical event router; normalize GitHub events to internal events; should_run decision point.

**Depends on:** v1.9 (Phase 41)

**Requirements:** ROUTE-01, ROUTE-02, ROUTE-03, ROUTE-04, ROUTE-05

**Completed:** 2026-02-17

**Success criteria:**
1. Extracted router module or clear normalization layer before enqueue
2. issues.labeled/opened → planner | builder per routing rules
3. pull_request → reviewer | verifier | security per agent config
4. workflow_run → governor.evaluate | governor.observe_deploy
5. Single should_run(agent, repo, context) with config+env precedence; all enqueue paths use it

**Plans:** 3 plans in 2 waves ✓

- 42-01: Internal event structs + normalizer (Wave 1)
- 42-02: should_run(agent, repo, context) (Wave 1)
- 42-03: Router module + webhook integration (Wave 2)

---

### Phase 43: Dedup Alignment ✓

**Goal:** Standardize dedup keys; add repo to Verifier/Security queues.

**Depends on:** Phase 42

**Requirements:** DEDUP-01, DEDUP-02, DEDUP-04

**Completed:** 2026-02-17

**Success criteria:**
1. All PR agents use (repo_full_name, pr_number, head_sha)
2. VerifierQueue.is_duplicate and mark_processed accept repo_full_name
3. SecurityQueue.is_duplicate and mark_processed accept repo_full_name
4. Issue agent dedup keys documented (Planner, Builder)

**Plans:** 2 plans in 1 wave ✓

- 43-01: VerifierQueue + SecurityQueue repo-scoped dedup + router (Wave 1)
- 43-02: Dedup keys documentation (Wave 1)

---

### Phase 44: Planner→Architect→Builder Wiring ✓

**Goal:** Audit and fix routing logic; Builder consumes Architect first; compat flag.

**Depends on:** Phase 43

**Requirements:** WIRE-01, WIRE-02, WIRE-03, WIRE-04, WIRE-05

**Completed:** 2026-02-17

**Success criteria:**
1. Architect-approved plan → Builder enqueue only (no Planner/Architect)
2. Plan exists but unreviewed → Architect enqueue
3. No plan → Planner enqueue
4. Builder get_plan_for_builder returns Architect artifact first; Planner fallback when compat enabled
5. Routing logic documented in code or docs

**Plans:** 4 plans in 2 waves ✓

- 44-01: Architect standalone enqueue (ArchitectJob, architect_queue, architect worker) — Wave 1
- 44-02: Compat flag (ArchitectConfig.builder_compat, get_plan_for_builder) — Wave 1
- 44-03: Router plan-state-first + Architect enqueue — Wave 2
- 44-04: docs/routing.md — Wave 2

---

### Phase 45: Promotion Gate Hardening

**Goal:** Architect check for plan PRs; idempotent promote; deterministic second-finisher.

**Depends on:** Phase 44

**Requirements:** PROMO-01, PROMO-02, PROMO-03, PROMO-04, PROMO-05

**Success criteria:**
1. Promote only when Verifier success AND (Reviewer success OR fail-open OR disabled)
2. For plan-originated PRs with Architect enabled, Architect approval required at promote-time
3. Only Verifier calls promote_to_ready_for_review (grep-verified)
4. promote_to_ready_for_review is idempotent (no-op or re-fetch draft state)

**Plans:** 2 plans in 1 wave

- 45-01: Idempotent promote_to_ready_for_review (Wave 1)
- 45-02: Architect gate + promotion_gates + Verifier wiring (Wave 1)

---

### Phase 46: Cancel Semantics

**Goal:** Verifier cooperative cancel; new head_sha supersedes prior run.

**Depends on:** Phase 45

**Requirements:** DEDUP-03, DEDUP-05

**Success criteria:**
1. VerifierQueue supports request_cancel (mirror ReviewerQueue pattern)
2. New head_sha for same PR triggers cancel of prior in-flight Verifier run
3. Verifier runner checks cancel_event at phase boundaries
4. Superseded run exits with conclusion=cancelled

**Plans:** 2 plans in 2 waves

- 46-01: VerifierQueue request_cancel + VerifierJob cancel_event (Wave 1)
- 46-02: Verifier runner cancel checks at phase boundaries (Wave 2)

---

### Phase 47: Operator Visibility

**Goal:** Structured skip logs; booty status CLI.

**Depends on:** Phase 46

**Requirements:** OPS-01, OPS-02, OPS-03, OPS-04

**Success criteria:**
1. Every event skip emits structured log: agent, repo, event_type, decision=skip, reason
2. Skip reasons: disabled, not_agent_pr, missing_config, dedup_hit
3. booty status shows enabled agents, last run timestamps, queue depth
4. Verifier logs promotion_waiting_reviewer when tests pass but Reviewer not yet success (already exists; verify)

**Plans:** TBD

---

## Milestone Summary

**Requirements mapped:** 23/23 ✓

**Phase ordering rationale:**
- Router first (foundation)
- Dedup alignment enables correct multi-repo behavior before wiring changes
- Planner→Architect→Builder wiring builds on router
- Promotion gate builds on existing Verifier; Architect check is hardening
- Cancel semantics extend Verifier (Reviewer pattern exists)
- Operator visibility last (observability across all changes)

---
_For current project status, see .planning/ROADMAP.md_
---
*Created: 2026-02-17*
