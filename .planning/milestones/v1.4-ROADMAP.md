# Milestone v1.4: Release Governor

**Status:** ✅ SHIPPED 2026-02-16
**Phases:** 14-17
**Total Plans:** 13

## Overview

Release Governor gates production deployment. It runs when a verification workflow completes on main, computes risk from paths touched, enforces holds (deploy config missing, first-deploy approval, degraded+high-risk), triggers deploy via workflow_dispatch for allowed SHAs, records release state, and surfaces HOLD/ALLOW with clear operator UX.

## Phases

### Phase 14: Governor Foundation & Persistence

**Goal**: Config schema, release state store, agent skeleton, deploy workflow sha input.

**Requirements:** GOV-04, GOV-19, GOV-20, GOV-21, GOV-22, GOV-26, GOV-27, GOV-28, GOV-29, GOV-30

**Depends on**: Nothing

**Plans**: 5 plans

Plans:
- [x] 14-01-PLAN.md — Config schema (ReleaseGovernorConfig, env overrides)
- [x] 14-02-PLAN.md — State store + delivery ID cache
- [x] 14-03-PLAN.md — Governor module skeleton + booty governor status
- [x] 14-04-PLAN.md — Deploy workflow sha input + deploy.sh DEPLOY_SHA
- [x] 14-05-PLAN.md — Verify-main workflow

**Details:**
- ReleaseGovernorConfig schema in .booty.yml (strict) with env overrides
- File-based release.json at .booty/state/release.json; atomic write; single-writer safe
- Delivery ID cache for idempotency; (repo, head_sha) dedup
- New module src/booty/release_governor/ with config + store
- Deploy workflow accepts optional sha input for workflow_dispatch; checkout uses it
- Verify-main workflow (runs on push to main, runs tests); deploy trigger changes to workflow_dispatch-only (Governor triggers)

---

### Phase 15: Trigger, Risk & Decision Logic

**Goal**: workflow_run handler, risk scoring from paths, decision rules, cooldown/rate limit.

**Requirements:** GOV-01, GOV-02, GOV-03, GOV-05, GOV-06, GOV-07, GOV-08, GOV-09, GOV-10, GOV-11, GOV-12, GOV-13

**Depends on**: Phase 14

**Plans**: 3 plans

Plans:
- [x] 15-01-PLAN.md — Risk scoring (config medium_risk_paths, risk.py, pathspec)
- [x] 15-02-PLAN.md — Decision engine (store deploy_history, decision.py, cooldown/rate limit)
- [x] 15-03-PLAN.md — workflow_run webhook + handler (full pipeline)

**Details:**
- Governor receives workflow_run (verification workflow on main, conclusion=success)
- Uses head_sha from payload; fetches diff vs production_sha for risk
- Risk scoring: HIGH (workflows, infra, lockfiles, migrations), MEDIUM (manifests), LOW (rest)
- Hard holds: deploy not configured; first deploy without approval; degraded + high-risk
- Approval policy: LOW auto-ALLOW; MEDIUM hold if incident; HIGH hold unless approval (env/label/comment)
- Cooldown and max_deploys_per_hour enforced

---

### Phase 16: Deploy Integration & Operator UX

**Goal**: workflow_dispatch deploy, HOLD/ALLOW UX, post-deploy observation, failure issues.

**Requirements:** GOV-14, GOV-15, GOV-16, GOV-17, GOV-18, GOV-23, GOV-24, GOV-25

**Depends on**: Phase 15

**Plans**: 3 plans

Plans:
- [x] 16-01-PLAN.md — Deploy trigger & HOLD/ALLOW operator UX
- [x] 16-02-PLAN.md — Deploy failure issue module
- [x] 16-03-PLAN.md — Deploy outcome observation (workflow_run)

**Details:**
- On ALLOW: POST workflow_dispatch with sha; update release state
- On HOLD: commit status or issue with Decision, SHA, Risk, Reason, "How to unblock"
- On ALLOW: status or comment with "Triggered: deploy workflow run <link>"
- Governor observes deploy workflow_run completion; updates release state
- Deploy failure → create/append GitHub issue with deploy-failure, severity:high, Actions link
- Never deploys non-head_sha

---

### Phase 17: CLI & Documentation

**Goal**: booty governor CLI and docs/release-governor.md.

**Requirements:** GOV-31, GOV-32

**Depends on**: Phase 16

**Plans**: 2 plans

Plans:
- [x] 17-01-PLAN.md — CLI simulate, trigger, status --json
- [x] 17-02-PLAN.md — docs/release-governor.md

**Details:**
- booty governor status — show release state
- booty governor simulate --sha <sha> — dry-run decision (no deploy)
- booty governor trigger --sha <sha> — manual trigger (respects approval if HIGH risk)
- docs/release-governor.md: configuration, approval mechanism, troubleshooting, manual test steps

---

## Milestone Summary

**Key Decisions:**
- Config loaded from repo .booty.yml via GitHub API (not local file) — Governor is multi-tenant
- Environment approval for Phase 15; label/comment approval stubbed (tech debt, GOV-11 partial)
- Verify-main workflow runs on push to main; deploy trigger is workflow_dispatch-only (Governor owns deploy trigger)
- Single UX pattern: commit status booty/release-governor for both HOLD and ALLOW

**Issues Resolved:**
- Post-verify deploy gating closed (workflow_run → risk → decision → dispatch or HOLD)
- Deploy failure → GitHub issue with deploy-failure label (operator visibility)
- Release state persisted in .booty/state/release.json

**Issues Deferred:**
- GOV-11 label/comment approval: only environment mode implemented; label/comment require PR lookup
- PathSpec GitWildMatchPattern deprecation warnings (cosmetic)

**Technical Debt Incurred:**
- handler.py: label_approved and comment_approved stubbed to False
- pathspec deprecation warnings in risk tests (64 warnings)

---

_For current project status, see .planning/ROADMAP.md_
