# Milestone v1.2: Verifier Agent

**Status:** ✅ SHIPPED 2026-02-15
**Phases:** 7-10
**Total Plans:** 12

## Overview

Verifier agent runs on every PR, runs tests in clean env, enforces diff limits, validates .booty.yml, detects import/compile failures, posts check run `booty/verifier`. Builder increases mutation rate; Verifier controls error rate.

## Phases

### Phase 7: GitHub App + Checks Integration

**Goal**: Unblock Checks API — create `booty/verifier` check run using GitHub App auth.

**Requirements:** VERIFY-01

**Depends on**: Nothing (first v1.2 phase)

**Plans**: 3 plans

Plans:
- [x] 07-01-PLAN.md — Settings extension, verifier enabled check, startup log
- [x] 07-02-PLAN.md — checks.py with create_check_run (App auth)
- [x] 07-03-PLAN.md — CLI (booty status, booty verifier check-test), docs

**Details:**
- GITHUB_APP_ID, GITHUB_APP_PRIVATE_KEY in Settings (optional when empty — Verifier disabled)
- booty/github/checks.py creates check run via repo.create_check_run() with App token
- booty status, booty verifier check-test for manual verification
- docs/github-app-setup.md for App setup

---

### Phase 8: pull_request Webhook + Verifier Runner

**Goal**: Verifier runs on every PR, clones head, runs tests, posts check result.

**Requirements:** VERIFY-02, VERIFY-03, VERIFY-04, VERIFY-05

**Depends on**: Phase 7

**Plans**: 3 plans

Plans:
- [x] 08-01-PLAN.md — Verifier runner (VerifierJob, workspace, process_verifier_job)
- [x] 08-02-PLAN.md — pull_request webhook branch, VerifierQueue, workers
- [x] 08-03-PLAN.md — Builder skip promote, agent:builder label, Verifier promotion/comment

**Details:**
- Webhook accepts pull_request (opened, synchronize, reopened); enqueues VerifierJob
- Verifier clones PR head_sha in clean env, loads .booty.yml, runs execute_tests()
- Check run transitions: queued → in_progress → completed (success/failure)
- Agent PRs: Builder skips promotion; Verifier promotes on success, comments on failure
- agent:builder label on all Builder PRs

---

### Phase 9: Diff Limits + .booty.yml Schema v1

**Goal**: Enforce diff limits and validate extended .booty.yml schema.

**Requirements:** VERIFY-06, VERIFY-07, VERIFY-08, VERIFY-09, VERIFY-10

**Depends on**: Phase 8

**Plans**: 3 plans

Plans:
- [x] 09-01-PLAN.md — BootyConfig schema v1, load_booty_config_from_content
- [x] 09-02-PLAN.md — verifier/limits.py (DiffStats, check_diff_limits)
- [x] 09-03-PLAN.md — Wire schema + limits into runner

**Details:**
- Verifier rejects PR exceeding max_files_changed or max_diff_loc (check failure)
- Optional max_loc_per_file enforced for pathspec-matched safety-critical dirs
- .booty.yml with schema_version: 1 validated; unknown/malformed config fails check
- Schema supports: test_command, setup_command?, timeout_seconds, max_retries, allowed_paths, forbidden_paths, allowed_commands, network_policy, labels
- Backward compat: repos without schema_version use v0 (existing BootyConfig)
- Agent PRs: schema + limits validated before clone (fail fast)

---

### Phase 10: Import/Compile Detection

**Goal**: Detect hallucinated imports and compile failures before/during test run.

**Requirements:** VERIFY-11, VERIFY-12

**Depends on**: Phase 9

**Plans**: 3 plans

Plans:
- [x] 10-01-PLAN.md — install_command schema, BootyConfigV1
- [x] 10-02-PLAN.md — verifier/imports.py (compile sweep, import validation)
- [x] 10-03-PLAN.md — Wire runner: execution order, annotations

**Details:**
- Verifier parses changed files (AST); validates imports resolve to existing modules
- Unresolvable import → check failure with clear message
- setup_command or test run compile failure (e.g. SyntaxError) → check failure
- Failures reported in check output (title, summary, annotations where applicable)
- Execution order: setup_command → install_command → import/compile sweep → test_command

---

## Milestone Summary

**Key Decisions:**
- get_verifier_repo returns None on auth failure (log and continue)
- Both App credentials default to empty; Booty runs without Verifier when not configured
- Agent PRs: schema then limits, both before clone; non-agent PRs skip limits
- Execution order: setup_command → install_command → import/compile → test_command
- Agent PR with BootyConfigV1: install_command required for import validation

**Issues Resolved:**
- Checks API integration via GitHub App auth
- Verifier promotion ownership: Builder never promotes; Verifier promotes agent PRs on success
- Early validation path for agent PRs (schema + limits before clone)
- Import/compile failure annotations in check output

**Issues Deferred:**
- network_policy, allowed_commands enforcement (schema exists, VERIFY-13)
- Aggregate CI check results (VERIFY-14)

**Technical Debt Incurred:**
- Human verification: create_check_run E2E (booty verifier check-test) requires real GitHub App credentials; manual step documented in docs/github-app-setup.md

---

_For current project status, see .planning/ROADMAP.md_

---
