stateDiagram-v2
    [*] --> IssueCreated: Human/Sentry creates
    IssueCreated --> IssueLabeled: Label agent:plan or agent:builder
    IssueLabeled --> PlannerCheck: Webhook received
    PlannerCheck --> PlannerEnqueued: agent:plan OR (agent:builder + no plan)
    PlannerEnqueued --> PlanStored: Planner worker completes
    PlanStored --> BuilderEnqueued: agent:builder on issue (worker enqueues)
    PlannerCheck --> BuilderEnqueued: agent:builder + plan exists
    PlannerCheck --> BuilderBlocked: agent:builder + no plan + Planner disabled
    BuilderBlocked --> [*]: post_builder_blocked_comment
    BuilderEnqueued --> BuilderProcessing: Job dequeued
    BuilderProcessing --> PRDraft: create_pull_request, add_agent_builder_label
    BuilderProcessing --> FailureCommented: post_failure_comment on issue
    FailureCommented --> [*]

    PRDraft --> VerifierEnqueued: PR webhook (opened/synchronize/reopened)
    VerifierEnqueued --> VerifierProcessing: Job dequeued
    VerifierProcessing --> CheckQueued: create_check_run
    CheckQueued --> CheckInProgress: edit_check_run
    CheckInProgress --> CheckSuccess: tests passed
    CheckInProgress --> CheckFailure: tests/config/setup failed

    CheckSuccess --> PRReadyForReview: promote_to_ready_for_review
    PRReadyForReview --> [*]: Human merges

    CheckFailure --> VerifierCommentPosted: post_verifier_failure_comment on PR
    VerifierCommentPosted --> BuilderRetryEnqueued: enqueue_builder_retry (if under limit)
    BuilderRetryEnqueued --> BuilderProcessing: Job dequeued
    VerifierCommentPosted --> [*]: retry limit reached
